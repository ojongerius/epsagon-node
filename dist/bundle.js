"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var e=_interopDefault(require("google-protobuf-minified")),t=_interopDefault(require("uuid4")),r=_interopDefault(require("axios-minified")),a=_interopDefault(require("os")),n=_interopDefault(require("fs")),s=_interopDefault(require("require-in-the-middle")),o=_interopDefault(require("events")),i=_interopDefault(require("https")),p=_interopDefault(require("http")),c=_interopDefault(require("buffer")),u=_interopDefault(require("json-stringify-safe")),d=_interopDefault(require("md5")),l=_interopDefault(require("json.sortify")),g=_interopDefault(require("util")),f=_interopDefault(require("shimmer")),h=_interopDefault(require("zlib")),m=_interopDefault(require("uuid-parse")),_=_interopDefault(require("path")),E=_interopDefault(require("url")),b=_interopDefault(require("dns"));function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var y=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Exception",null,n),proto.Exception=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Exception,e.Message),a.DEBUG&&!COMPILED&&(proto.Exception.displayName="proto.Exception"),e.Message.GENERATE_TO_OBJECT&&(proto.Exception.prototype.toObject=function(e){return proto.Exception.toObject(e,this)},proto.Exception.toObject=function(t,r){var a,n={type:e.Message.getFieldWithDefault(r,1,""),message:e.Message.getFieldWithDefault(r,2,""),traceback:e.Message.getFieldWithDefault(r,3,""),time:+e.Message.getFieldWithDefault(r,4,0),additionalDataMap:(a=r.getAdditionalDataMap())?a.toObject(t,void 0):[]};return t&&(n.$jspbMessageInstance=r),n}),proto.Exception.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Exception;return proto.Exception.deserializeBinaryFromReader(a,r)},proto.Exception.deserializeBinaryFromReader=function(t,r){for(;r.nextField()&&!r.isEndGroup();){switch(r.getFieldNumber()){case 1:var a=r.readString();t.setType(a);break;case 2:a=r.readString();t.setMessage(a);break;case 3:a=r.readString();t.setTraceback(a);break;case 4:a=r.readDouble();t.setTime(a);break;case 5:a=t.getAdditionalDataMap();r.readMessage(a,(function(t,r){e.Map.deserializeBinary(t,r,e.BinaryReader.prototype.readString,e.BinaryReader.prototype.readString)}));break;default:r.skipField()}}return t},proto.Exception.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Exception.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Exception.serializeBinaryToWriter=function(t,r){var a=void 0;(a=t.getType()).length>0&&r.writeString(1,a),(a=t.getMessage()).length>0&&r.writeString(2,a),(a=t.getTraceback()).length>0&&r.writeString(3,a),0!==(a=t.getTime())&&r.writeDouble(4,a),(a=t.getAdditionalDataMap(!0))&&a.getLength()>0&&a.serializeBinary(5,r,e.BinaryWriter.prototype.writeString,e.BinaryWriter.prototype.writeString)},proto.Exception.prototype.getType=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Exception.prototype.setType=function(t){e.Message.setProto3StringField(this,1,t)},proto.Exception.prototype.getMessage=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Exception.prototype.setMessage=function(t){e.Message.setProto3StringField(this,2,t)},proto.Exception.prototype.getTraceback=function(){return e.Message.getFieldWithDefault(this,3,"")},proto.Exception.prototype.setTraceback=function(t){e.Message.setProto3StringField(this,3,t)},proto.Exception.prototype.getTime=function(){return+e.Message.getFieldWithDefault(this,4,0)},proto.Exception.prototype.setTime=function(t){e.Message.setProto3FloatField(this,4,t)},proto.Exception.prototype.getAdditionalDataMap=function(t){return e.Message.getMapField(this,5,t,null)},proto.Exception.prototype.clearAdditionalDataMap=function(){this.getAdditionalDataMap().clear()},a.object.extend(r,proto)})),v=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.ErrorCode",null,n),proto.ErrorCode={OK:0,ERROR:1,EXCEPTION:2,TIMEOUT:3},a.object.extend(r,proto)})),T=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Event",null,n),a.exportSymbol("proto.Resource",null,n),proto.Resource=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Resource,e.Message),a.DEBUG&&!COMPILED&&(proto.Resource.displayName="proto.Resource"),e.Message.GENERATE_TO_OBJECT&&(proto.Resource.prototype.toObject=function(e){return proto.Resource.toObject(e,this)},proto.Resource.toObject=function(t,r){var a,n={name:e.Message.getFieldWithDefault(r,1,""),type:e.Message.getFieldWithDefault(r,2,""),operation:e.Message.getFieldWithDefault(r,3,""),metadataMap:(a=r.getMetadataMap())?a.toObject(t,void 0):[]};return t&&(n.$jspbMessageInstance=r),n}),proto.Resource.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Resource;return proto.Resource.deserializeBinaryFromReader(a,r)},proto.Resource.deserializeBinaryFromReader=function(t,r){for(;r.nextField()&&!r.isEndGroup();){switch(r.getFieldNumber()){case 1:var a=r.readString();t.setName(a);break;case 2:a=r.readString();t.setType(a);break;case 3:a=r.readString();t.setOperation(a);break;case 4:a=t.getMetadataMap();r.readMessage(a,(function(t,r){e.Map.deserializeBinary(t,r,e.BinaryReader.prototype.readString,e.BinaryReader.prototype.readString)}));break;default:r.skipField()}}return t},proto.Resource.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Resource.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Resource.serializeBinaryToWriter=function(t,r){var a=void 0;(a=t.getName()).length>0&&r.writeString(1,a),(a=t.getType()).length>0&&r.writeString(2,a),(a=t.getOperation()).length>0&&r.writeString(3,a),(a=t.getMetadataMap(!0))&&a.getLength()>0&&a.serializeBinary(4,r,e.BinaryWriter.prototype.writeString,e.BinaryWriter.prototype.writeString)},proto.Resource.prototype.getName=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Resource.prototype.setName=function(t){e.Message.setProto3StringField(this,1,t)},proto.Resource.prototype.getType=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Resource.prototype.setType=function(t){e.Message.setProto3StringField(this,2,t)},proto.Resource.prototype.getOperation=function(){return e.Message.getFieldWithDefault(this,3,"")},proto.Resource.prototype.setOperation=function(t){e.Message.setProto3StringField(this,3,t)},proto.Resource.prototype.getMetadataMap=function(t){return e.Message.getMapField(this,4,t,null)},proto.Resource.prototype.clearMetadataMap=function(){this.getMetadataMap().clear()},proto.Event=function(t){e.Message.initialize(this,t,0,-1,null,null)},a.inherits(proto.Event,e.Message),a.DEBUG&&!COMPILED&&(proto.Event.displayName="proto.Event"),e.Message.GENERATE_TO_OBJECT&&(proto.Event.prototype.toObject=function(e){return proto.Event.toObject(e,this)},proto.Event.toObject=function(t,r){var a,n={id:e.Message.getFieldWithDefault(r,1,""),startTime:+e.Message.getFieldWithDefault(r,2,0),resource:(a=r.getResource())&&proto.Resource.toObject(t,a),origin:e.Message.getFieldWithDefault(r,4,""),duration:+e.Message.getFieldWithDefault(r,5,0),errorCode:e.Message.getFieldWithDefault(r,6,0),exception:(a=r.getException())&&y.Exception.toObject(t,a)};return t&&(n.$jspbMessageInstance=r),n}),proto.Event.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Event;return proto.Event.deserializeBinaryFromReader(a,r)},proto.Event.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setId(r);break;case 2:r=t.readDouble();e.setStartTime(r);break;case 3:r=new proto.Resource;t.readMessage(r,proto.Resource.deserializeBinaryFromReader),e.setResource(r);break;case 4:r=t.readString();e.setOrigin(r);break;case 5:r=t.readDouble();e.setDuration(r);break;case 6:r=t.readEnum();e.setErrorCode(r);break;case 7:r=new y.Exception;t.readMessage(r,y.Exception.deserializeBinaryFromReader),e.setException(r);break;default:t.skipField()}}return e},proto.Event.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Event.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Event.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getId()).length>0&&t.writeString(1,r),0!==(r=e.getStartTime())&&t.writeDouble(2,r),null!=(r=e.getResource())&&t.writeMessage(3,r,proto.Resource.serializeBinaryToWriter),(r=e.getOrigin()).length>0&&t.writeString(4,r),0!==(r=e.getDuration())&&t.writeDouble(5,r),0!==(r=e.getErrorCode())&&t.writeEnum(6,r),null!=(r=e.getException())&&t.writeMessage(7,r,y.Exception.serializeBinaryToWriter)},proto.Event.prototype.getId=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Event.prototype.setId=function(t){e.Message.setProto3StringField(this,1,t)},proto.Event.prototype.getStartTime=function(){return+e.Message.getFieldWithDefault(this,2,0)},proto.Event.prototype.setStartTime=function(t){e.Message.setProto3FloatField(this,2,t)},proto.Event.prototype.getResource=function(){return e.Message.getWrapperField(this,proto.Resource,3)},proto.Event.prototype.setResource=function(t){e.Message.setWrapperField(this,3,t)},proto.Event.prototype.clearResource=function(){this.setResource(void 0)},proto.Event.prototype.hasResource=function(){return null!=e.Message.getField(this,3)},proto.Event.prototype.getOrigin=function(){return e.Message.getFieldWithDefault(this,4,"")},proto.Event.prototype.setOrigin=function(t){e.Message.setProto3StringField(this,4,t)},proto.Event.prototype.getDuration=function(){return+e.Message.getFieldWithDefault(this,5,0)},proto.Event.prototype.setDuration=function(t){e.Message.setProto3FloatField(this,5,t)},proto.Event.prototype.getErrorCode=function(){return e.Message.getFieldWithDefault(this,6,0)},proto.Event.prototype.setErrorCode=function(t){e.Message.setProto3EnumField(this,6,t)},proto.Event.prototype.getException=function(){return e.Message.getWrapperField(this,y.Exception,7)},proto.Event.prototype.setException=function(t){e.Message.setWrapperField(this,7,t)},proto.Event.prototype.clearException=function(){this.setException(void 0)},proto.Event.prototype.hasException=function(){return null!=e.Message.getField(this,7)},a.object.extend(r,proto)})),$=createCommonjsModule((function(t,r){var a=e,n=Function("return this")();a.exportSymbol("proto.Trace",null,n),proto.Trace=function(t){e.Message.initialize(this,t,0,-1,proto.Trace.repeatedFields_,null)},a.inherits(proto.Trace,e.Message),a.DEBUG&&!COMPILED&&(proto.Trace.displayName="proto.Trace"),proto.Trace.repeatedFields_=[3,4],e.Message.GENERATE_TO_OBJECT&&(proto.Trace.prototype.toObject=function(e){return proto.Trace.toObject(e,this)},proto.Trace.toObject=function(t,r){var a={appName:e.Message.getFieldWithDefault(r,1,""),token:e.Message.getFieldWithDefault(r,2,""),eventList:e.Message.toObjectList(r.getEventList(),T.Event.toObject,t),exceptionList:e.Message.toObjectList(r.getExceptionList(),y.Exception.toObject,t),version:e.Message.getFieldWithDefault(r,5,""),platform:e.Message.getFieldWithDefault(r,6,"")};return t&&(a.$jspbMessageInstance=r),a}),proto.Trace.deserializeBinary=function(t){var r=new e.BinaryReader(t),a=new proto.Trace;return proto.Trace.deserializeBinaryFromReader(a,r)},proto.Trace.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setAppName(r);break;case 2:r=t.readString();e.setToken(r);break;case 3:r=new T.Event;t.readMessage(r,T.Event.deserializeBinaryFromReader),e.addEvent(r);break;case 4:r=new y.Exception;t.readMessage(r,y.Exception.deserializeBinaryFromReader),e.addException(r);break;case 5:r=t.readString();e.setVersion(r);break;case 6:r=t.readString();e.setPlatform(r);break;default:t.skipField()}}return e},proto.Trace.prototype.serializeBinary=function(){var t=new e.BinaryWriter;return proto.Trace.serializeBinaryToWriter(this,t),t.getResultBuffer()},proto.Trace.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getAppName()).length>0&&t.writeString(1,r),(r=e.getToken()).length>0&&t.writeString(2,r),(r=e.getEventList()).length>0&&t.writeRepeatedMessage(3,r,T.Event.serializeBinaryToWriter),(r=e.getExceptionList()).length>0&&t.writeRepeatedMessage(4,r,y.Exception.serializeBinaryToWriter),(r=e.getVersion()).length>0&&t.writeString(5,r),(r=e.getPlatform()).length>0&&t.writeString(6,r)},proto.Trace.prototype.getAppName=function(){return e.Message.getFieldWithDefault(this,1,"")},proto.Trace.prototype.setAppName=function(t){e.Message.setProto3StringField(this,1,t)},proto.Trace.prototype.getToken=function(){return e.Message.getFieldWithDefault(this,2,"")},proto.Trace.prototype.setToken=function(t){e.Message.setProto3StringField(this,2,t)},proto.Trace.prototype.getEventList=function(){return e.Message.getRepeatedWrapperField(this,T.Event,3)},proto.Trace.prototype.setEventList=function(t){e.Message.setRepeatedWrapperField(this,3,t)},proto.Trace.prototype.addEvent=function(t,r){return e.Message.addToRepeatedWrapperField(this,3,t,proto.Event,r)},proto.Trace.prototype.clearEventList=function(){this.setEventList([])},proto.Trace.prototype.getExceptionList=function(){return e.Message.getRepeatedWrapperField(this,y.Exception,4)},proto.Trace.prototype.setExceptionList=function(t){e.Message.setRepeatedWrapperField(this,4,t)},proto.Trace.prototype.addException=function(t,r){return e.Message.addToRepeatedWrapperField(this,4,t,proto.Exception,r)},proto.Trace.prototype.clearExceptionList=function(){this.setExceptionList([])},proto.Trace.prototype.getVersion=function(){return e.Message.getFieldWithDefault(this,5,"")},proto.Trace.prototype.setVersion=function(t){e.Message.setProto3StringField(this,5,t)},proto.Trace.prototype.getPlatform=function(){return e.Message.getFieldWithDefault(this,6,"")},proto.Trace.prototype.setPlatform=function(t){e.Message.setProto3StringField(this,6,t)},a.object.extend(r,proto)}));function createTimestampFromTime(e){return e/1e3}var x,S={createTimestampFromTime:createTimestampFromTime,createTimestamp:function(){return createTimestampFromTime(Date.now())},createDurationTimestamp:function(e){return createTimestampFromTime(Date.now()-e)},reflectPromise:function(e){return e.then(e=>({value:e,status:"resolved"})).catch(e=>({error:e,status:"rejected"}))},debugLog:function(...e){"TRUE"===(process.env.EPSAGON_DEBUG||"").toUpperCase()&&console.log("[EPSAGON]",...e)},printWarning:function(...e){console.warn(...e)},printError:function(...e){console.error(...e)},makeQueryablePromise:function(e){if(e.isResolved)return e;let t=!0,r=!1,a=!1;const n=e.then(e=>(a=!0,t=!1,e),e=>{throw r=!0,t=!1,e});return n.isFulfilled=()=>a,n.isPending=()=>t,n.isRejected=()=>r,n},flatten:function(e){const t={};return function step(e,r,a){const n=a||1;Object.keys(e).forEach(a=>{const s=e[a];if(null==s)return null;const o=Array.isArray(s),i=Object.prototype.toString.call(s),p="[object Object]"===i||"[object Array]"===i,c=r?r+"."+a:a;return!o&&!Buffer.isBuffer(s)&&p&&Object.keys(s).length?step(s,c,n+1):(null!=s&&["string","number","boolean"].includes(typeof s)&&(t[c]=s),null)})}(e),t},getLastSplittedItem:(e,t)=>{const r=e&&e.split(t)||[];return r[r.length-1]},isPromise:function(e){return!!e&&"function"==typeof e.then},isLambdaEnv:!!process.env.AWS_LAMBDA_FUNCTION_NAME,getValueIfExist:function(e,t){return t in e?e[t]:void 0},truncateMessage:function(e,t){return e.length<=t?e:e.slice(0,t)},distinct:function(e){return[...new Set(e)]}},R="Epsagon Instrumentation for Node.js",A=["serverless","epsagon","tracing","distributed-tracing","lambda","aws-lambda","debugging","monitoring"],M="Epsagon Team <support@epsagon.com>",C={pretest:"./scripts/build_peg.sh",test:"nyc --reporter=text ./scripts/run_tests.sh","lint:js":"eslint --max-warnings=0 ./src/ ./examples/ ./test/unit_tests ./index.js -f table --ext .js --ext .jsx","lint:js:fix":"eslint --max-warnings=0 ./src/ ./examples/ ./test/unit_tests ./index.js -f table --ext .js --ext .jsx --fix",lint:"npm run lint:js","build:dev":"./scripts/build_peg.sh && rollup -c",build:"./scripts/build_peg.sh && NODE_ENV=production rollup -c",clean:"rm -r dist/",prepublishOnly:"npm run build","semantic-release":"semantic-release"},O={url:"https://github.com/epsagon/epsagon-node/issues"},w="https://github.com/epsagon/epsagon-node#readme",N={type:"git",url:"https://github.com/epsagon/epsagon-node.git"},L="dist/bundle.js",I=["dist"],D={hooks:{"commit-msg":"commitlint -E HUSKY_GIT_PARAMS"}},P={"@babel/runtime":"^7.4.5","@commitlint/cli":"^9.1.2","@commitlint/config-angular":"^7.1.2","@commitlint/config-conventional":"^7.1.2","aws-sdk":"^2.197.0","body-parser":"^1.19.0",chai:"^4.1.2","chai-as-promised":"^7.1.1",dotenv:"^8.2.0",eslint:"^4.18.0","eslint-config-airbnb":"^17.1.0","eslint-plugin-chai-friendly":"^0.4.1","eslint-plugin-import":"^2.14.0","eslint-plugin-json":"^1.2.1","eslint-plugin-jsx-a11y":"^6.1.1","eslint-plugin-mocha":"^4.11.0","eslint-plugin-react":"^7.11.0",express:"^4.17.1","express-session":"^1.17.1",husky:"^1.1.0","ldap-server-mock":"^3.0.0",ldapjs:"^2.1.0",lolex:"^3.0.0",mocha:"^9.0.1",mongodb:"^3.1.13",mysql:"^2.16.0",mysql2:"^1.6.4",nyc:"^15.1.0",pegjs:"^0.10.0",pg:"^7.6.0","pg-pool":"^2.0.3",proxyquire:"^2.0.1",randomstring:"^1.1.5",redis:"^3.1.2",request:"^2.88.2","request-promise-native":"^1.0.7",rollup:"^0.66.6","rollup-plugin-commonjs":"^9.1.8","rollup-plugin-copy":"^3.1.0","rollup-plugin-eslint":"^5.0.0","rollup-plugin-json":"^3.1.0","rollup-plugin-terser":"^7.0.1","semantic-release":"^17.4.4",semver:"^7.3.4","simple-oauth2":"^4.2.0",sinon:"^4.3.0","uglify-es":"^3.3.9",underscore:"^1.12.0"},k={"axios-minified":"^1.0.2","google-protobuf-minified":"^1.0.8","json-stringify-safe":"^5.0.1","json.sortify":"^2.2.2",md5:"^2.2.1","require-in-the-middle":"^5.0.3",shimmer:"^1.2.1","uuid-parse":"^1.1.0",uuid4:"^1.0.0"},W={name:"epsagon",version:"0.0.0-development",description:R,keywords:A,author:M,license:"MIT",scripts:C,bugs:O,homepage:w,repository:N,main:L,files:I,husky:D,devDependencies:P,dependencies:k},q=((x=Object.freeze({name:"epsagon",version:"0.0.0-development",description:R,keywords:A,author:M,license:"MIT",scripts:C,bugs:O,homepage:w,repository:N,main:L,files:I,husky:D,devDependencies:P,dependencies:k,default:W}))&&x.default||x).version;let B=process.env.AWS_REGION;void 0===B&&(B="us-east-1");var j={VERSION:q,REGION:B,LOCAL_URL:"http://localhost:3000",TRACE_COLLECTOR_URL:`https://${B}.tc.epsagon.com`,COLD_START:!0,STEP_ID_NAME:"Epsagon",EPSAGON_EVENT_ID_KEY:"_epsagon_event_id",MAX_VALUE_CHARS:3072,MAX_LABEL_SIZE:10240,MAX_HTTP_VALUE_SIZE:10240,MAX_TRACE_SIZE_BYTES:process.env.EPSAGON_MAX_TRACE_SIZE?parseInt(process.env.EPSAGON_MAX_TRACE_SIZE,10):65536,DEFAULT_SAMPLE_RATE:1,DEFAULT_BATCH_SIZE:5,MAX_TRACE_WAIT:5e3,BATCH_SIZE_BYTES_HARD_LIMIT:655360,QUEUE_SIZE_BYTES_HARD_LIMIT:10485760,EPSAGON_HEADER:"epsagon-trace-id",LAMBDA_DEFAULT_NODE_MODULES_PATH:"/var/task/node_modules",STRONG_ID_KEYS:["key","request_id","requestid","request-id","steps_dict","message_id","etag","item_hash","sequence_number","trace_id","job_id","activation_id","http_trace_id","id","aws.sqs.message_id","x-amz-request-id","object_key","object_etag","aws.requestId","aws.s3.key","aws.s3.etag","aws.kinesis.sequence_number","request_trace_id","logging_tracing_enabled","CLOUDWATCH_LOG_GROUP_NAME","CLOUDWATCH_LOG_STREAM_NAME","log_stream_name","log_group_name","function_version","memory","aws_account","cold_start","region","status_code"],traceUrl:(e,t)=>`https://app.epsagon.com/trace/${e}?timestamp=${t}`,lambdaTraceUrl:(e,t,r,a,n)=>`https://app.epsagon.com/functions/${e}/${t}/${r}?requestId=${a}&requestTime=${n}`},F=createCommonjsModule((function(e){e.exports.HTTP_ERR_CODE=parseInt(process.env.EPSAGON_HTTP_ERR_CODE,10)||400,e.exports.processIgnoredKey=function(e){return e.toLowerCase().replace("-","").replace("_","").replace(/\s/g,"")};const processIgnoredKeys=t=>t.map(t=>"string"==typeof t?e.exports.processIgnoredKey(t):t),matchKeysToIgnore=e=>{const t=e.filter(e=>e&&("string"==typeof e||e instanceof RegExp));return t.length!==e.length&&S.printWarning("Epsagon Deprecaion Warning: matched keys supports only strings and RegExp, other values will be ignored. Recieved Keys:",e),processIgnoredKeys(t)},t={token:process.env.EPSAGON_TOKEN||"",appName:process.env.EPSAGON_APP_NAME||"Application",metadataOnly:"TRUE"===(process.env.EPSAGON_METADATA||"").toUpperCase(),useSSL:"TRUE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase(),traceCollectorURL:process.env.EPSAGON_COLLECTOR_URL||j.TRACE_COLLECTOR_URL,isEpsagonDisabled:"TRUE"===(process.env.DISABLE_EPSAGON||"").toUpperCase(),urlPatternsToIgnore:[],ignoredDBTables:[],internalSampleRate:j.DEFAULT_SAMPLE_RATE,labels:{},sendOnlyErrors:"TRUE"===(process.env.EPSAGON_SEND_TRACE_ON_ERROR||"").toUpperCase(),removeIgnoredKeys:"TRUE"===(process.env.EPSAGON_REMOVE_IGNORED_KEYS||"").toUpperCase(),sendTimeout:1e3*(Number(process.env.EPSAGON_SEND_TIMEOUT_SEC)||1),decodeHTTP:"TRUE"===(process.env.EPSAGON_DECODE_HTTP||"TRUE").toUpperCase(),disableHttpResponseBodyCapture:"TRUE"===(process.env.EPSAGON_DISABLE_HTTP_RESPONSE||"").toUpperCase(),loggingTracingEnabled:"TRUE"===(process.env.EPSAGON_LOGGING_TRACING_ENABLED||(!S.isLambdaEnv).toString()).toUpperCase(),sendBatch:"TRUE"===(process.env.EPSAGON_SEND_BATCH||(!S.isLambdaEnv).toString()).toUpperCase(),batchSize:Number(process.env.EPSAGON_BATCH_SIZE)||j.DEFAULT_BATCH_SIZE,maxTraceWait:Number(process.env.EPSAGON_MAX_TRACE_WAIT)||j.MAX_TRACE_WAIT,maxBatchSizeBytes:j.BATCH_SIZE_BYTES_HARD_LIMIT,maxQueueSizeBytes:j.QUEUE_SIZE_BYTES_HARD_LIMIT,logTransportEnabled:"TRUE"===(process.env.EPSAGON_LOG_TRANSPORT||"FALSE").toUpperCase(),get isEpsagonPatchDisabled(){return this.isEpsagonDisabled||"TRUE"===(process.env.DISABLE_EPSAGON_PATCH||"").toUpperCase()},get sampleRate(){return this.internalSampleRate},set sampleRate(e){const t=parseFloat(e);Number.isNaN(t)||(this.internalSampleRate=t)}};process.env.EPSAGON_SAMPLE_RATE&&(t.sampleRate=process.env.EPSAGON_SAMPLE_RATE),process.env.EPSAGON_URLS_TO_IGNORE&&(t.urlPatternsToIgnore=process.env.EPSAGON_URLS_TO_IGNORE.split(",")),process.env.EPSAGON_IGNORED_DB_TABLES&&(t.ignoredDBTables=process.env.EPSAGON_IGNORED_DB_TABLES.split(",")),process.env.EPSAGON_IGNORED_KEYS&&(t.ignoredKeys=processIgnoredKeys(process.env.EPSAGON_IGNORED_KEYS.split(","))),"FALSE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase()&&(t.traceCollectorURL=t.traceCollectorURL.replace("https:","http:")),"TRUE"===(process.env.EPSAGON_SSL||"TRUE").toUpperCase()&&(t.traceCollectorURL=t.traceCollectorURL.replace("http:","https:")),process.env.EPSAGON_PATCH_WHITELIST&&(t.patchWhitelist=process.env.EPSAGON_PATCH_WHITELIST.split(",")),process.env.EPSAGON_PAYLOADS_TO_IGNORE&&(t.ignoredPayloads=JSON.parse(process.env.EPSAGON_PAYLOADS_TO_IGNORE)),e.exports.getConfig=function(){return t},e.exports.setConfig=function(r){void 0!==r&&(r.token&&(t.token=r.token),r.isEpsagonDisabled&&(t.isEpsagonDisabled=r.isEpsagonDisabled),r.appName&&(t.appName=r.appName),void 0!==r.metadataOnly&&null!=r.metadataOnly&&(t.metadataOnly=r.metadataOnly),r.traceCollectorURL&&(t.traceCollectorURL=r.traceCollectorURL),!1===r.useSSL&&(t.traceCollectorURL=t.traceCollectorURL.replace("https:","http:"),t.useSSL=r.useSSL),r.useSSL&&(t.traceCollectorURL=t.traceCollectorURL.replace("http:","https:"),t.useSSL=r.useSSL),r.useLocalCollector&&(t.traceCollectorURL=j.LOCAL_URL),r.urlPatternsToIgnore&&(t.urlPatternsToIgnore=r.urlPatternsToIgnore),r.sendOnlyErrors&&(t.sendOnlyErrors=r.sendOnlyErrors),r.httpErrorStatusCode&&(e.exports.HTTP_ERR_CODE=r.httpErrorStatusCode),!1===r.decodeHTTP&&(t.decodeHTTP=r.decodeHTTP),r.disableHttpResponseBodyCapture&&(t.disableHttpResponseBodyCapture=r.disableHttpResponseBodyCapture),r.ignoredDBTables&&Array.isArray(r.ignoredDBTables)&&(t.ignoredDBTables=matchKeysToIgnore(r.ignoredDBTables)),r.ignoredKeys&&Array.isArray(r.ignoredKeys)&&(t.ignoredKeys=matchKeysToIgnore(r.ignoredKeys)),r.removeIgnoredKeys&&(t.removeIgnoredKeys=r.removeIgnoredKeys),null!==r.sampleRate&&void 0!==t.sampleRate&&(t.sampleRate=r.sampleRate),Number(r.sendTimeout)&&(t.sendTimeout=Number(r.sendTimeout)),"boolean"==typeof r.sendBatch&&(t.sendBatch=r.sendBatch),Number(r.batchSize)&&(t.batchSize=Number(r.batchSize)),Number(r.maxTraceWait)&&(t.maxTraceWait=Number(r.maxTraceWait)),Number(r.maxBatchSizeBytes)&&(Number(r.maxBatchSizeBytes)>j.QUEUE_SIZE_BYTES_HARD_LIMIT?S.debugLog(`User configured maxBatchSizeBytes exceeded batch size hard limit of ${j.BATCH_SIZE_BYTES_HARD_LIMIT} Bytes`):t.maxBatchSizeBytes=Number(r.maxBatchSizeBytes)),Number(r.maxQueueSizeBytes)&&(Number(r.maxQueueSizeBytes)>j.QUEUE_SIZE_BYTES_HARD_LIMIT?S.debugLog(`User configured maxQueueSizeBytes exceeded queue size hard limit of ${j.QUEUE_SIZE_BYTES_HARD_LIMIT} Bytes`):t.maxQueueSizeBytes=Number(r.maxQueueSizeBytes)),r.labels&&(t.labels=S.flatten([...r.labels].reduce((e,t)=>{const[r,a]=t;return{...e,[r]:a}},{}))))}})),U=(F.HTTP_ERR_CODE,F.processIgnoredKey,F.getConfig,F.setConfig,createCommonjsModule((function(e){e.exports.setException=function(e,t,r=!0,a=!1){try{e.setErrorCode(a?v.ErrorCode.OK:v.ErrorCode.EXCEPTION);const n=new y.Exception([t.name,t.message,t.stack,S.createTimestamp()]);e.setException(n),n.getAdditionalDataMap().set("handled",r),n.getAdditionalDataMap().set("warning",a)}catch(e){le.addException(e)}},e.exports.markAsTimeout=function(e){e.setErrorCode(v.ErrorCode.TIMEOUT)},e.exports.addToMetadata=function(e,t,r={}){const a=e.getResource(),n=a&&a.getMetadataMap();n&&(Object.keys(t).forEach(e=>{n.set(e,t[e])}),F.getConfig().metadataOnly||Object.keys(r).forEach(e=>{n.set(e,r[e])}))},e.exports.addObjectToMetadata=function(e,t,r,a=[]){let n=r;if(!F.getConfig().metadataOnly&&a.length>0){const s=Object.getOwnPropertyNames(r).filter(e=>!a.includes(e));n=Object.assign(...s.map(e=>({[e]:r[e]}))),e.getResource().getMetadataMap().set(t,JSON.stringify(n))}},e.exports.addLabelToMetadata=function(e,t,r){const a=e.getResource().getMetadataMap().get("labels");let n=null;void 0!==a?(n=JSON.parse(a),n[t]=r):n={[t]:r};const s=JSON.stringify(n);s.length<=j.MAX_LABEL_SIZE&&e.getResource().getMetadataMap().set("labels",s)},e.exports.initializeEvent=function(e,r,a,n){const s=Date.now(),o=new T.Resource([r,e,a]),i=new T.Event([`${e}-${t()}`,S.createTimestampFromTime(s),null,n,0,v.ErrorCode.OK]);return i.setResource(o),{slsEvent:i,startTime:s}},e.exports.finalizeEvent=function(e,t,r,a={},n={}){try{r&&this.setException(e,r),this.addToMetadata(e,a,n),e.setDuration(S.createDurationTimestamp(t))}catch(e){le.addException(e)}},e.exports.createTraceIdMetadata=function(r){e.exports.addToMetadata(r,{trace_id:t()})}})));U.setException,U.markAsTimeout,U.addToMetadata,U.addObjectToMetadata,U.addLabelToMetadata,U.initializeEvent,U.finalizeEvent,U.createTraceIdMetadata;let z=null,H=null;var ecs_hasECSMetadata=function(){return process.env.ECS_CONTAINER_METADATA_URI||!1},ecs_loadECSMetadata=function(e){if(z)return Promise.resolve(z);S.debugLog(`loading ecs meta, url: (${e})`);const t=[],a=r.get(e).then(e=>e.data).then(e=>{S.debugLog("Received metadata: "+JSON.stringify(e)),z=e&&e.Labels;const t=z&&z["com.amazonaws.ecs.cluster"];return t&&(H=t.split(":")[4]),z}).catch(e=>{S.debugLog("error fetching ecs metadata: ",e)});return t.push(a),Promise.all(t)},ecs_addECSMetadata=function(e){e&&z&&(U.addToMetadata(e,{ECS:z}),U.addToMetadata(e,{"aws.account_id":H}))};let G=null,K=null;var k8s_hasK8sMetadata=function(){return!!process.env.KUBERNETES_SERVICE_HOST},k8s_loadK8sMetadata=function(){if(G||(G=a.hostname()),!K)try{const e=n.readFileSync("/proc/self/cgroup").toString("utf-8").split("\n")[0].split("/");K=e[e.length-1]}catch(e){S.debugLog("Error loading k8s container id - cannot read cgroup file",e)}},k8s_addK8sMetadata=function(e){if(!e||!G)return;const t={is_k8s:!0,k8s_pod_name:G};K&&(t.k8s_container_id=K),U.addToMetadata(e,t)};let J=null;const Q=`${process.env.AZURE_HOST||"http://169.254.169.254"}${process.env.AZURE_PATH||"/metadata/instance?api-version=2019-06-01"}`,V=process.env.AZURE_REQUEST_TIMEOUT||3e3,parseAzureTags=e=>e.split(";").reduce((e,t)=>{const[r,a]=t.split(":");return r?{...e,[r]:a}:e},{});var azure_loadAzureMetadata=function(e){if(J)return Promise.resolve(J);S.debugLog(`loading azure metadata, url: (${Q})`);const t=r.CancelToken.source();setTimeout(()=>{t.cancel()},V);const a={headers:{Metadata:"True"},timeout:V,cancelToken:t.token};return r.get(Q,a).then(t=>{if(S.debugLog("Received response: "+t),200===t.status){const{location:r,subscriptionId:a,tags:n,publisher:s}=t.data.compute;J={"azure.location":r,"azure.subscription_id":a,"azure.tags":parseAzureTags(n),"azure.publisher":s},e&&e({traceCollectorURL:`http://${r}.atc.epsagon.com`}),S.debugLog("Received metadata: "+J)}}).catch(()=>{S.debugLog("Could not load azure metadata")})},azure_addAzureMetadata=function(e){e&&J&&U.addToMetadata(e,Object.assign({},J))};let Z=null;const X=["instance-id","instance-type","local-ipv4","public-hostname","public-ipv4"],Y=process.env.EPSAGON_EC2_REQUEST_TIMEOUT||3e3;var ec2_loadEC2Metadata=function(){if(Z)return Promise.resolve(Z);const e=[];return S.debugLog("Loading EC2 metadata"),X.forEach(t=>{const a=r.CancelToken.source();setTimeout(()=>{a.cancel()},Y),e.push(r.get("http://169.254.169.254/latest/meta-data/"+t,{timeout:Y,cancelToken:a.token}).then(e=>{if(S.debugLog("Received response for "+t),200===e.status&&e.data.length<100){const r=t.replace("-","_"),a=e.data;Z||(Z={}),Z["aws.ec2."+r]=a,S.debugLog(`${r} stored with: ${a}`)}return t}).catch(()=>{S.debugLog("Could not load EC2 metadata for "+t)}))}),Promise.all(e)},ec2_addEC2Metadata=function(e){e&&Z&&U.addToMetadata(e,Object.assign({},Z))};let ee=null;const tryRequire=e=>{let t;const r="function"==typeof __webpack_require__?__non_webpack_require__:require;try{t=r.resolve(e),ee=null}catch(e){ee=e}if(t)try{return r(t)}catch(e){ee=e}};tryRequire.lastError=()=>ee;var te=tryRequire;const re=te("aws-sdk/global"),ae=te("aws-sdk/clients/sts"),ne=[];function onWinstonCloudwatchRequire(e){if(S.debugLog("winston-cloudwatch required"),"function"!=typeof e)return S.debugLog("winston-cloudwatch got non-function exports",typeof e,e),e;if(e.__epsagon_wrapped)return S.debugLog("winston-cloudwatch already hooked"),e;function wrapper(...t){const[r]=t;try{S.debugLog("winston-cloudwatch instance created"),function(e){if(!re)return Promise.resolve();const t={};t.log_group_name=e.logGroupName,t.log_stream_name=e.logStreamName;const r=new ae,a=e.cloudWatchLogs&&e.cloudWatchLogs.config||{};return t.region=e.awsRegion||a.region||re.config.region||process.env.AWS_REGION,r.getCallerIdentity().promise().then(e=>(t.account_id=e.Account,t))}(r).then(e=>ne.push(e)).catch(e=>le.addException(e))}catch(e){S.debugLog("failed to set cloudwatch-winston log parameters",e),le.addException(e)}return e.apply(this,t)}return wrapper.prototype=Object.create(e.prototype),e.__epsagon_wrapped=!0,S.debugLog("winston-cloudwatch require patching done"),wrapper}var se={init(){S.debugLog("hooking winston-cloudwatch"),s(["winston-cloudwatch"],onWinstonCloudwatchRequire),S.debugLog("hooked winston-cloudwatch")},additionalMetadata:()=>ne.length?{"aws.cloudwatch.log_destinations":ne}:{}};const oe=r.create({headers:{Authorization:"Bearer "+F.getConfig().token},timeout:F.getConfig().sendTimeout,httpAgent:new p.Agent({keepAlive:!0}),httpsAgent:new i.Agent({keepAlive:!0})});async function postBatch(e){S.debugLog(`[QUEUE] Posting batch to ${F.getConfig().traceCollectorURL}...`);const t=r.CancelToken.source(),a=setTimeout(()=>{t.cancel("Timeout sending batch!")},F.getConfig().sendTimeout);return oe.post(F.getConfig().traceCollectorURL,e,{cancelToken:t.token}).then(e=>(clearTimeout(a),S.debugLog("[QUEUE] Batch posted!"),e)).catch(e=>(clearTimeout(a),e.config&&e.config.data?S.debugLog("[QUEUE] Error sending trace. Batch size: "+e.config.data.length):S.debugLog("[QUEUE] Error sending trace. Error: "+e),S.debugLog("[QUEUE] "+(e?e.stack:e)),e))}class ie extends o.EventEmitter{constructor(){super(),this.batchSender=postBatch,this.initQueue()}updateConfig(){this.maxBatchSizeBytes=F.getConfig().maxBatchSizeBytes,this.batchSize=F.getConfig().batchSize,this.maxQueueSizeBytes=F.getConfig().maxQueueSizeBytes}initQueue(){this.updateConfig(),this.removeAllListeners(),this.flush(),this.on("traceQueued",(function(){return this.byteSizeLimitReached()?(S.debugLog(`[QUEUE] Queue Byte size reached ${this.currentByteSize} Bytes, releasing batch...`),this.emit("releaseRequest",Math.max(this.currentSize-1,1))):this.batchSizeReached()&&(S.debugLog(`[QUEUE] Queue size reached ${this.currentSize}, releasing batch... `),this.emit("releaseRequest")),this})),this.on("releaseRequest",(function(e=this.batchSize){try{const t=this.queue.splice(0,e);S.debugLog("[QUEUE] Releasing batch..."),this.subtractFromCurrentByteSize(t),this.emit("batchReleased",t)}catch(e){S.debugLog("[QUEUE] Failed releasing batch!"),S.debugLog("[QUEUE] "+e)}return this})),this.on("batchReleased",(async function(e){S.debugLog("[QUEUE] Sending batch...");const t=e.map(e=>e.json);this.batchSender(t)})),process.on("exit",(function(){this.emit("releaseRequest"),this.removeAllListeners()}))}push(e){try{if(this.currentByteSize>=this.maxQueueSizeBytes)return S.debugLog(`[QUEUE] Discardig trace, queue size reached max size of ${this.currentByteSize} Bytes`),this;const t=Date.now(),r=e,a=JSON.stringify(r),n=a.length,s={json:r,string:a,byteLength:n,timestamp:t};this.queue.push(s),this.addToCurrentByteSize([s]),S.debugLog(`[QUEUE] Trace size ${n} Bytes pushed to queue`),S.debugLog(`[QUEUE] Queue size: ${this.currentSize} traces, total size of ${this.currentByteSize} Bytes`),this.emit("traceQueued",s)}catch(e){S.debugLog("[QUEUE] Failed pushing trace to queue: "+e)}return this}addToCurrentByteSize(e){e.forEach(e=>{this.currentByteSize+=e.byteLength})}subtractFromCurrentByteSize(e){e.forEach(e=>{this.currentByteSize-=e.byteLength,this.currentByteSize=Math.max(this.currentByteSize,0)})}get currentSize(){return this.queue.length}batchSizeReached(){return this.currentSize>=this.batchSize}byteSizeLimitReached(){return this.currentByteSize>=this.maxBatchSizeBytes}flush(){this.queue=[],this.currentByteSize=0}}const pe=new ie;var trace_queue_getInstance=()=>pe;var ce={isBlacklistURL:(e,t,r)=>Object.keys(t).some(a=>"function"==typeof t[a]?t[a](e,a,r):e[t[a]](a)),isBlacklistHeader:(e,t)=>!!e&&t.includes(e["user-agent"]),isStrongId:e=>j.STRONG_ID_KEYS.includes(e.toLowerCase().replace(" ","_"))};const{Buffer:ue}=c;var logs_sendTrace=function(e){return S.debugLog("posting trace to logs"),S.debugLog("trace: "+JSON.stringify(e,null,2)),new Promise(t=>{try{const r=ue.from(JSON.stringify(e)).toString("base64");process.stdout.write(`EPSAGON_TRACE: ${r}\n`),S.debugLog("Trace posted!")}catch(e){S.debugLog("Error sending trace. Error: "+e)}finally{t()}})};const de=r.create({timeout:F.getConfig().sendTimeout,httpAgent:new p.Agent({keepAlive:!0}),httpsAgent:new i.Agent({keepAlive:!0})});var http_1_sendTrace=function(e){S.debugLog("Posting trace to "+F.getConfig().traceCollectorURL),"TRUE"===(process.env.EPSAGON_DEBUG||"").toUpperCase()&&S.debugLog("trace: "+JSON.stringify(e,null,2));const t=r.CancelToken.source(),a=setTimeout(()=>{t.cancel("timeout sending trace")},F.getConfig().sendTimeout);return de.post(F.getConfig().traceCollectorURL,e,{headers:{Authorization:"Bearer "+F.getConfig().token},timeout:F.getConfig().sendTimeout,cancelToken:t.token}).then(e=>(clearTimeout(a),S.debugLog("Trace posted!"),e)).catch(e=>(clearTimeout(a),e.config&&e.config.data?S.debugLog("Error sending trace. Trace size: "+e.config.data.length):S.debugLog("Error sending trace. Error: "+e),S.debugLog(""+(e?e.stack:e)),e))},le=createCommonjsModule((function(e){const{isStrongId:r}=ce;e.exports.getTrace=()=>{};const a=trace_queue_getInstance();function getTrimmedMetadata(e,t){let a;return Object.keys(e).forEach(n=>{r(n)||t&&"labels"===n||(a||(a=e,a.is_trimmed=!0),delete a[n])}),a}function getTrimmedTrace(e,t){let r=e;const a=Object.assign({},t);let n=0,s=0;if(a.exceptions.length>1){const[e,t,s]=function(e){const t=e[0];return[t,e.length-1,JSON.stringify(e).length-JSON.stringify(t).length]}(a.exceptions);r-=s,n=t,a.exceptions=[e]}if(S.debugLog("Epsagon - Pre metadata trim: current trace size "+r),r>=j.MAX_TRACE_SIZE_BYTES){a.events=t.events.sort(e=>["runner","trigger"].includes(e.origin)?-1:1);for(let e=t.events.length-1;e>=0;e-=1){const t=a.events[e];let n=t.resource.metadata;if(n){const e="runner"===t.origin,a=JSON.stringify(n).length,s=getTrimmedMetadata(n,e);if(s){n=s;if(r-=a-JSON.stringify(s).length,r<j.MAX_TRACE_SIZE_BYTES)break}}}}if(S.debugLog("Epsagon - After metadata trim: current trace size "+r),r>=j.MAX_TRACE_SIZE_BYTES)for(let e=t.events.length-1;e>=0;e-=1){const t=a.events[e];if(!["runner","trigger"].includes(t.origin)&&(s+=1,a.events.splice(e,1),r-=JSON.stringify(t).length,r<j.MAX_TRACE_SIZE_BYTES))break}return S.debugLog("Epsagon - After events trim: current trace size "+r),(s||n)&&S.debugLog(`Epsagon - Trace size is larger than maximum size, ${s} events and ${n} exceptions were trimmed.`),a}function addLabelsToTrace(){const t=e.exports.getTrace();t&&Object.keys(F.getConfig().labels).forEach(e=>{const r=t.currRunner.getResource().getMetadataMap().get("labels");r&&JSON.parse(r)[e]||U.addLabelToMetadata(t.currRunner,e,F.getConfig().labels[e])})}function sendCurrentTrace(t,r){const a=r||e.exports.getTrace(),{sendOnlyErrors:n,ignoredKeys:s,removeIgnoredKeys:o}=F.getConfig();if(!a)return S.debugLog("Trace object not found for sending"),Promise.resolve();if(addLabelsToTrace(),!a.currRunner)return S.debugLog("Epsagon - no trace was sent since runner was not found."),Promise.resolve();if(U.addToMetadata(a.currRunner,se.additionalMetadata()),ecs_addECSMetadata(a.currRunner),k8s_addK8sMetadata(a.currRunner),azure_addAzureMetadata(a.currRunner),ec2_addEC2Metadata(a.currRunner),n){if(0===a.trace.getEventList().filter(e=>e.getErrorCode()).length)return S.debugLog("Epsagon - no trace was sent since no error events found."),a.pendingEvents.clear(),Promise.resolve()}let i,p={app_name:a.trace.getAppName(),token:a.trace.getToken(),events:a.trace.getEventList().map(e=>({id:e.getId(),start_time:e.getStartTime(),resource:e.hasResource()?{name:e.getResource().getName(),type:e.getResource().getType(),operation:e.getResource().getOperation(),metadata:e.getResource().getMetadataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})}:{},origin:e.getOrigin(),duration:e.getDuration(),error_code:e.getErrorCode(),exception:e.hasException()?{type:e.getException().getType(),message:e.getException().getMessage(),traceback:e.getException().getTraceback(),time:e.getException().getTime(),additional_data:e.getException().getAdditionalDataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})}:{}})),exceptions:a.trace.getExceptionList().map(e=>({type:e.getType(),message:e.getMessage(),traceback:e.getTraceback(),time:e.getTime(),additional_data:e.getAdditionalDataMap().toArray().reduce((e,t)=>(e[t[0]]=t[1],e),{})})),version:a.trace.getVersion(),platform:a.trace.getPlatform()};try{p=s&&Array.isArray(s)&&s.length>0?e.exports.filterTrace(p,s,o):p}catch(e){return S.printWarning("Epsagon - failed to filter trace, cancelling send",e),Promise.resolve({})}try{i=JSON.stringify(p)}catch(e){return S.printWarning("Epsagon - no trace was sent since there was an error serializing the trace. Please contact support.",e),Promise.resolve()}const c=i.length;c>=j.MAX_TRACE_SIZE_BYTES&&(p=getTrimmedTrace(c,p));const u=t(p);return a.pendingEvents.clear(),F.getConfig().sampleRate!==j.DEFAULT_SAMPLE_RATE&&(a.deleted=!0),u}e.exports.createTracer=function(){if(F.getConfig().sampleRate<=Math.random())return null;return{trace:new $.Trace(["","",[],[],j.VERSION,"node "+process.versions.node]),currRunner:null,pendingEvents:new Map,createdAt:Date.now()}},e.exports.addEvent=function(t,r){const a=e.exports.getTrace();a&&(this.addPendingEvent(t,r),a.trace.addEvent(t))},e.exports.addPendingEvent=function(t,r){const a=e.exports.getTrace();a&&S.isPromise(r)&&a.pendingEvents.set(t,S.makeQueryablePromise(r.catch(t=>{e.exports.addException(t)})))},e.exports.addException=function(t,r){const a=t||new Error,n=new y.Exception([a.name,a.message,a.stack,S.createTimestamp()]);"object"==typeof r&&Object.keys(r).forEach(e=>{void 0===r[e]?n.getAdditionalDataMap().set(e,"undefined"):n.getAdditionalDataMap().set(e,r[e])});const s=e.exports.getTrace();s&&s.trace.addException(n)},e.exports.initTrace=function(e){try{if(!S.isLambdaEnv){const t=ecs_hasECSMetadata();t&&ecs_loadECSMetadata(t).catch(e=>S.debugLog(e)),k8s_hasK8sMetadata()&&k8s_loadK8sMetadata(),azure_loadAzureMetadata(t=>{F.setConfig(Object.assign(t,e))}),ec2_loadEC2Metadata().catch(e=>S.debugLog(e))}}catch(e){S.debugLog("Could not extract container env data")}F.setConfig(e),a.updateConfig()},e.exports.addRunner=function(t,r){const a=e.exports.getTrace();a&&(a.trace.addEvent(t,r),a.currRunner=t)},e.exports.restart=function(){const t=e.exports.getTrace();t&&(t.disabled=!1,t.trace.clearExceptionList(),t.trace.clearEventList(),t.trace.setAppName(F.getConfig().appName),t.trace.setToken(F.getConfig().token))},e.exports.doesContainIgnoredKey=function(e,t){return e.some(e=>!("string"!=typeof e||!F.processIgnoredKey(t).includes(e))||!!(e instanceof RegExp&&e.test(t)))},e.exports.filterTrace=function(e,t,r){function replacer(e,a){if(function(e){for(let r=0;r<t.length;r+=1){const a=t[r];if("string"==typeof a&&a===F.processIgnoredKey(e))return!1;if(a instanceof RegExp&&a.test(e))return!1}return!0}(e)){if("string"==typeof(n=a)&&n.length>1&&["[","{"].includes(n[0]))try{const e=JSON.parse(a),t=u(e,replacer,0,()=>{});return JSON.parse(t)}catch(e){return a}return a}var n;return r?void 0:"****"}S.debugLog("Trace was filtered with ignored keys");const a=e.events.map(e=>{if(!(e&&e.resource&&e.resource.metadata))return e;const t=Object.assign({},e),r=JSON.parse(u(e.resource.metadata,replacer,0,()=>{}));return t.resource.metadata=r,t});return Object.assign({},e,{events:a})},e.exports.postTrace=function(e){return F.getConfig().logTransportEnabled?logs_sendTrace(e):http_1_sendTrace(e)},e.exports.sendTrace=function(t,r){const n=r||e.exports.getTrace();return!n||n&&n.disabled?(S.debugLog("Trace object not found or disabled"),Promise.resolve()):F.getConfig().isEpsagonDisabled?(n.pendingEvents.clear(),Promise.resolve()):(addLabelsToTrace(),S.debugLog("Sending trace async..."),Promise.all(n.pendingEvents.values()).then(()=>(t(),F.getConfig().sendBatch?sendCurrentTrace(e=>a.push(e),n):sendCurrentTrace(t=>e.exports.postTrace(t),n))))},e.exports.sendTraceSync=function(){const r=e.exports.getTrace();return!r||r&&r.disabled?Promise.resolve():F.getConfig().isEpsagonDisabled?(r.pendingEvents.clear(),Promise.resolve()):(S.debugLog("Sending trace sync"),r.pendingEvents.forEach((e,r)=>{e.isPending()&&(r.getId()||r.setId(t()),r.getErrorCode()===v.ErrorCode.OK&&U.addToMetadata(r,{premature_exit:!0}),0===r.getDuration()&&r.setDuration(S.createDurationTimestamp(1e3*r.getStartTime())))}),sendCurrentTrace(t=>e.exports.postTrace(t)))},e.exports.label=function(t,r){const a=e.exports.getTrace();if(!a||!a.currRunner)return void S.debugLog("Failed to label without an active tracer");const n={[t]:r},s=S.flatten(n);Object.keys(s).forEach(e=>{U.addLabelToMetadata(a.currRunner,e,s[e])})},e.exports.setError=function(t){const r=e.exports.getTrace();r&&r.currRunner?U.setException(r.currRunner,t):S.debugLog("Failed to setError without an active tracer")},e.exports.setWarning=function(t){const r=e.exports.getTrace();r&&r.currRunner?U.setException(r.currRunner,t,!0,!0):S.debugLog("Failed to setWarning without an active tracer")},e.exports.getTraceUrl=function(){const t=e.exports.getTrace();if(!t||!t.currRunner)return S.debugLog("Failed to get trace URL without an active tracer"),"";const r=t.currRunner.getResource();return"lambda"!==r.getType()?j.traceUrl(e.exports.getTraceId(),parseInt(t.currRunner.getStartTime(),10)):j.lambdaTraceUrl(r.getMetadataMap().get("aws_account"),r.getMetadataMap().get("region"),r.getName(),t.currRunner.getId(),parseInt(t.currRunner.getStartTime(),10))},e.exports.disable=function(){const t=e.exports.getTrace();t?t.disabled=!0:S.debugLog("Failed to disabled without an active tracer")},e.exports.enable=function(){const t=e.exports.getTrace();t?t.disabled=!1:S.debugLog("Failed to enable without an active tracer")},e.exports.getTrimmedTrace=getTrimmedTrace,e.exports.isLoggingTracingEnabled=function(){return F.getConfig().loggingTracingEnabled},e.exports.getTraceId=function(){const t=e.exports.getTrace();return t&&t.currRunner&&t.currRunner.hasResource()?t.currRunner.getResource().getMetadataMap().get("trace_id"):null},e.exports.addLoggingTracingEnabledMetadata=function(){if(F.getConfig().loggingTracingEnabled){const t=e.exports.getTrace();t&&t.currRunner&&(S.debugLog("Setting logging_tracing_enabled"),U.addToMetadata(t.currRunner,{logging_tracing_enabled:!0}))}}}));le.getTrace,le.createTracer,le.addEvent,le.addPendingEvent,le.addException,le.initTrace,le.addRunner,le.restart,le.doesContainIgnoredKey,le.filterTrace,le.postTrace,le.sendTrace,le.sendTraceSync,le.label,le.setError,le.setWarning,le.getTraceUrl,le.disable,le.enable,le.getTrimmedTrace,le.isLoggingTracingEnabled,le.getTraceId,le.addLoggingTracingEnabledMetadata;let ge=null;var trace_object_get=()=>(ge&&!ge.deleted||(ge=le.createTracer()),ge);var fe={getSNSTrigger:function(e){let t=null;return e.some(e=>{try{let r=null;if("Body"in e)r=JSON.parse(e.Body);else{if(!("body"in e))return!0;r=JSON.parse(e.body)}if("Type"in r&&"MessageId"in r&&"TopicArn"in r&&"Message"in r&&"Timestamp"in r)return t=r,!0}catch(e){}return!0}),t}};JSON.sortify=l;const he=te("aws-sdk/clients/dynamodb");const me={s3:function(e,t){const r=t.getResource();t.setId(e.Records[0].responseElements["x-amz-request-id"]),r.setName(e.Records[0].s3.bucket.name),r.setOperation(e.Records[0].eventName),U.addToMetadata(t,{region:""+e.Records[0].awsRegion,request_parameters:JSON.stringify(e.Records[0].requestParameters),user_identity:JSON.stringify(e.Records[0].userIdentity),object_key:""+e.Records[0].s3.object.key,object_size:""+e.Records[0].s3.object.size,object_etag:""+e.Records[0].s3.object.eTag,"x-amz-request-id":""+e.Records[0].responseElements["x-amz-request-id"]})},json:function(e,r,a){const n=r.getResource();r.setId("trigger-"+t()),n.setName("trigger-"+a.functionName),n.setOperation("Event"),U.addToMetadata(r,{},{data:e})},kinesis:function(e,t){const r=t.getResource();t.setId(e.Records[0].eventID),r.setName(e.Records[0].eventSourceARN.split("/").pop()),r.setOperation(e.Records[0].eventName.replace("aws:kinesis:","")),U.addToMetadata(t,{region:e.Records[0].awsRegion,invoke_identity:e.Records[0].invokeIdentityArn,sequence_number:e.Records[0].kinesis.sequenceNumber,partition_key:e.Records[0].kinesis.partitionKey,total_record_count:e.Records.length})},events:function(e,t){const r=t.getResource();t.setId(e.id);let a="CloudWatch Events";"string"==typeof e.resources[0]&&(a=e.resources[0].split("/").pop()),r.setName(a),r.setOperation(e["detail-type"]),U.addToMetadata(t,{region:e.region,detail:JSON.stringify(e.detail),account:e.account})},sns:function(e,t){const r=t.getResource();t.setId(e.Records[0].Sns.MessageId),r.setName(e.Records[0].EventSubscriptionArn.split(":").slice(-2)[0]),r.setOperation(e.Records[0].Sns.Type),U.addToMetadata(t,{"Notification Subject":e.Records[0].Sns.Subject},{"Notification Message":e.Records[0].Sns.Message,"Notification Message Attributes":e.Records[0].Sns.MessageAttributes})},sqs:function(e,t){const r=t.getResource();t.setId(e.Records[0].messageId),r.setName(e.Records[0].eventSourceARN.split(":").slice(-1)[0]),r.setOperation("ReceiveMessage");const a=e.Records[0].body||"{}";U.addToMetadata(t,{record:e.Records.map(e=>{const t={"MD5 Of Message Body":e.md5OfBody,"Message ID":e.messageId};return F.getConfig().metadataOnly||(t["Message Body"]=S.truncateMessage(e.body||"{}",1024),t.Attributes=e.attributes,t["Message Attributes"]=e.messageAttributes),t}),total_record_count:e.Records.length});try{const e=JSON.parse(a);e.input&&e.input.Epsagon&&U.addToMetadata(t,{steps_dict:e.input.Epsagon})}catch(e){S.debugLog("Could not parse SQS message body: "+a)}const n=fe.getSNSTrigger(e.Records);null!=n&&U.addToMetadata(t,{"SNS Trigger":n})},api_gateway:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.headers.Host||e.requestContext.apiId),r.setOperation(e.httpMethod),U.addToMetadata(t,{stage:e.requestContext.stage,query_string_parameters:e.queryStringParameters,path_parameters:e.pathParameters,path:e.resource},{body:e.body,headers:e.headers,requestContext:e.requestContext})},api_gateway_no_proxy:function(e,t){const r=t.getResource();t.setId(e.context["request-id"]),r.setName(e.params.header.Host||e.context["api-id"]),r.setOperation(e.context["http-method"]),U.addToMetadata(t,{stage:e.context.stage,query_string_parameters:e.params.querystring,path_parameters:e.params.path,path:e.context["resource-path"]},{body:e["body-json"],headers:e.params.header})},api_gateway_websocket:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.requestContext.domainName),r.setOperation(e.requestContext.eventType||"CONNECT"),U.addToMetadata(t,{stage:e.requestContext.stage,route_key:e.requestContext.routeKey,message_id:e.requestContext.messageId,connection_id:e.requestContext.connectionId,request_id:e.requestContext.requestId,message_direction:e.requestContext.messageDirection},{body:e.body})},api_gateway_http2:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId),r.setName(e.headers.Host||e.requestContext.domainName),r.setOperation(e.requestContext.http.method),U.addToMetadata(t,{stage:e.requestContext.stage,query_string_parameters:e.queryStringParameters,path_parameters:e.pathParameters,path:e.requestContext.http.path,"aws.api_gateway.api_id":e.requestContext.apiId},{body:e.body,headers:e.headers,requestContext:e.requestContext})},dynamodb:function(e,t){const r=t.getResource(),a=e.Records[0];let n="";if(he){const e="REMOVE"===a.eventName?he.Converter.unmarshall(a.dynamodb.Keys):he.Converter.unmarshall(a.dynamodb.NewImage);n=d(JSON.sortify(e))}t.setId(a.eventID),r.setName(a.eventSourceARN.split("/")[1]),r.setOperation(a.eventName),U.addToMetadata(t,{region:a.awsRegion,sequence_number:a.dynamodb.SequenceNumber,item_hash:n,total_record_count:e.Records.length},{data:JSON.stringify(e.Records)})},elastic_load_balancer:function(e,r){const a=r.getResource();r.setId("elb-"+t()),a.setName(e.headers.host),a.setOperation(e.httpMethod),U.addToMetadata(r,{query_string_parameters:JSON.stringify(e.queryStringParameters),target_group_arn:e.requestContext.elb.targetGroupArn,path:e.path},{body:JSON.stringify(e.body),headers:JSON.stringify(e.headers)})},cognito:function(e,r){const a=r.getResource();r.setId("cognito-"+t()),a.setName(e.userPoolId),a.setOperation(e.triggerSource),U.addToMetadata(r,{username:e.userName,region:e.region},{caller_context:e.callerContext,request:e.request,response:e.response})}};var aws_lambda_createFromEvent=function(e,t){let r="json";e&&("Records"in e?("EventSource"in e.Records[0]&&(r=e.Records[0].EventSource.split(":").pop()),"eventSource"in e.Records[0]&&(r=e.Records[0].eventSource.split(":").pop())):"source"in e&&"detail-type"in e&&"detail"in e?r="events":"source"in e&&e.source?r=e.source.split(".").pop():"requestContext"in e&&"elb"in e.requestContext?r="elastic_load_balancer":"httpMethod"in e?r="api_gateway":"context"in e&&"http-method"in e.context?r="api_gateway_no_proxy":"dynamodb"in e?r="dynamodb":"userPoolId"in e?r="cognito":"requestContext"in e&&"apiId"in e.requestContext&&"http"in e.requestContext?r="api_gateway_http2":"requestContext"in e&&"apiId"in e.requestContext&&(r="api_gateway_websocket"));const a=new T.Resource,n=new T.Event;return n.setResource(a),me[r](e,n,t),function(e,t){e.setStartTime(S.createTimestamp()),e.setDuration(S.createTimestampFromTime(0)),e.setOrigin("trigger"),e.getResource().setType(t),e.setErrorCode(v.ErrorCode.OK)}(n,r),n};var _e={createRunner:function(e,r="lambda"){const a=new T.Resource([e.functionName,r,"invoke",{}]),n=new T.Event(["id"===e.awsRequestId?"local-"+t():e.awsRequestId,0,null,"runner",0,v.ErrorCode.OK]);n.setResource(a);const s=(e.invokedFunctionArn||"").split(":"),o=s.length>4?s[4]:"";return"provisioned-concurrency"===process.env.AWS_LAMBDA_INITIALIZATION_TYPE&&(j.COLD_START=!1),U.addToMetadata(n,{log_stream_name:""+e.logStreamName,log_group_name:""+e.logGroupName,function_version:""+e.functionVersion,aws_account:o,cold_start:""+j.COLD_START,memory:""+e.memoryLimitInMB,region:j.REGION}),8===s.length&&U.addToMetadata(n,{function_alias:s[7]}),j.COLD_START=!1,n}};const{getConfig:Ee}=F,{STEP_ID_NAME:be,MAX_VALUE_CHARS:ye,EPSAGON_EVENT_ID_KEY:ve}=j,Te=parseInt(process.env.EPSAGON_LAMBDA_TIMEOUT_THRESHOLD_MS||200,10),$e=Symbol("epsagonWrapped");function propagateEpsagonId(e,t){return process.env.EPSAGON_PROPAGATE_LAMBDA_ID&&t&&!Array.isArray(t)&&"object"==typeof t&&(t[ve]=e.getId(),U.addToMetadata(e,{propagation_enabled:!0})),t}function baseLambdaWrapper(e,t="lambda",r=!1,a=null){return(n,s,o)=>{if(Ee().ignoredPayloads||process.env.EPSAGON_PAYLOADS_TO_IGNORE){if((Ee().ignoredPayloads?Ee().ignoredPayloads:JSON.parse(process.env.EPSAGON_PAYLOADS_TO_IGNORE)).filter(e=>JSON.stringify(e)===JSON.stringify(n)).length>0)return e(n,s,o)}let i,p;le.getTrace=trace_object_get,le.restart();let c=!1,u=!1;try{i=_e.createRunner(s,t),le.addRunner(i)}catch(t){return(null===a?e:a)(n,s,o)}try{const e=aws_lambda_createFromEvent(n,s);le.addEvent(e)}catch(e){S.debugLog(`Error parsing trigger: ${e.stack}, Event: ${JSON.stringify(n)}`)}const d=Date.now(),runnerSendUpdateHandler=()=>{i.setDuration(S.createDurationTimestamp(d))},l=process._events.beforeExit;process._events.beforeExit=()=>{le.sendTrace(runnerSendUpdateHandler).then(()=>{process._events.beforeExit=l})};const handleUserExecutionDone=(e,t,r)=>{if(clearTimeout(p),c||u)return Promise.resolve();if(u=!0,e){let t=e;if(!e.name){let r;try{r="string"==typeof e?e:JSON.stringify(e)}catch(e){r=""}t={name:"LambdaExecutionError",message:r}}i.getException()||(S.debugLog("Setting exception from handleUserExecutionDone"),U.setException(i,t,!1))}const{statusCode:a}=t||{};if(a&&U.addToMetadata(i,{status_code:a}),null===e&&!Ee().metadataOnly){let e;try{e=JSON.stringify(void 0===t?null:t)}catch(t){e="Unable to stringify response body as json: "+t.message}U.addToMetadata(i,{return_value:e.substring(0,ye)})}return process._events.beforeExit=l,c=!0,!r&&s.callbackWaitsForEmptyEventLoop?le.sendTrace(runnerSendUpdateHandler):(runnerSendUpdateHandler(),le.sendTraceSync())};!function(e,t){const r=process._events.uncaughtException;process._events.uncaughtException=(a,n)=>{process._events.uncaughtException=r,U.setException(t,a,!1),e(a,null,!0).then(()=>{r&&"function"==typeof r&&r(a,n)})};const a=process._events.unhandledRejection;process._events.unhandledRejection=(r,n)=>{process._events.unhandledRejection=a;const s=Error(r);U.setException(t,s,!1),e(s,null,!0).then(()=>{a&&"function"==typeof a&&a(r,n)})}}(handleUserExecutionDone,i);let g=Promise.resolve();const wrappedCallback=(e,t)=>{S.debugLog("wrapped callback called",e,t),t=propagateEpsagonId(i,t),u?S.debugLog("not calling callback since it was already called"):g=new Promise(r=>{S.debugLog("handling execution done before calling callback"),handleUserExecutionDone(e,t).then(()=>{S.debugLog("calling User's callback"),o(e,t),r()})})};let f=Promise.resolve();const h=Object.assign({},s,{succeed:e=>{S.debugLog("wrapped succeed called"),u?S.debugLog("not calling succeed, callback was already called"):f=new Promise(t=>{handleUserExecutionDone(null,e,!0).then(()=>g).then(()=>s.succeed(e)).then(()=>t())})},fail:e=>{S.debugLog("wrapped fail called"),u?S.debugLog("not calling fail, callback was already called"):f=new Promise(t=>{handleUserExecutionDone(e,null,!0).then(()=>g).then(()=>s.fail(e)).then(()=>t())})},done:(e,t)=>{S.debugLog("wrapped done called"),u?S.debugLog("not calling done, callback was already called"):f=new Promise(r=>{handleUserExecutionDone(e,t,!0).then(()=>g).then(()=>s.done(e,t)).then(()=>r())})}});Object.defineProperty(h,"callbackWaitsForEmptyEventLoop",{set:e=>{s.callbackWaitsForEmptyEventLoop=e},get:()=>s.callbackWaitsForEmptyEventLoop});try{p=setTimeout(()=>{S.debugLog("In timeout handler"),c=!0,U.markAsTimeout(i),runnerSendUpdateHandler(),le.sendTraceSync()},h.getRemainingTimeInMillis()-Te),i.setStartTime(S.createTimestampFromTime(d));let t=r?e(n,h,wrappedCallback,i):e(n,h,wrappedCallback);if(t&&"function"==typeof t.then){let e,r;t=t.then(e=>(S.debugLog("user promise resolved (in then)"),e=propagateEpsagonId(i,e),r=e,handleUserExecutionDone(null,e,!0))).catch(t=>(S.debugLog("user promise rejected (in catch)"),e=t,handleUserExecutionDone(t,null,!0))).then(()=>g).then(()=>f).then(()=>{if(e)throw e;return r})}return t}catch(e){h.fail(e)}}}function extractAndAppendStepData(e,r,a){let n=null;return"object"==typeof a&&(n||(e&&e[be]?(n=Object.assign({},e[be]),n.step_num+=1):n={id:t(),step_num:0}),a[be]=n,U.addToMetadata(r,{steps_dict:n})),S.debugLog("Step function response update attempt"),S.debugLog("Updated response: "+g.inspect(a,{showHidden:!1,depth:null})),a}function createStepIdAddWrapper(e){return(t,r,a,n)=>{let s=e(t,r,(e,r)=>(e||extractAndAppendStepData(t,n,r),a(e,r)));return s&&"function"==typeof s.then&&(S.debugLog("Step function response is async"),s=s.then(e=>extractAndAppendStepData(t,n,e))),s}}var lambda_lambdaWrapper=function(e){if(e[$e])return e;const t=baseLambdaWrapper(e);return Object.defineProperty(t,$e,{value:!0,writable:!1}),t},lambda_stepLambdaWrapper=function(e){if(e[$e])return e;const t=baseLambdaWrapper(createStepIdAddWrapper(e),"step_function_lambda",!0,e);return Object.defineProperty(t,$e,{value:!0,writable:!1}),t};const xe={json:function(e,t,r,a){U.addToMetadata(a,{},{"tencent.scf.trigger_data":e})},timer:function(e,r){const a=r.getResource();r.setId("timer-"+t()),a.setName(e.TriggerName),a.setOperation("Timer"),U.addToMetadata(r,{"tencent.timer.timestamp":e.Time},{"tencent.timer.message":e.Message})},http:function(e,t){const r=t.getResource();t.setId(e.requestContext.requestId||e.headers["x-api-requestid"]),r.setName(e.headers.Host||e.headers.host),r.setOperation(e.httpMethod),U.addToMetadata(t,{"http.route":e.requestContext.path,"http.request.path":e.path,"tencent.api_gateway.request_id":e.headers["x-api-requestid"],"tencent.api_gateway.stage":e.requestContext.stage},{"http.request.headers":e.headers,"http.request.body":e.body,"http.request.path_params":e.pathParameters,"http.request.query":e.queryString})},cos:function(e,t){const r=e.Records[0],a=t.getResource();t.setId(r.cos.cosObject.meta["x-cos-request-id"]),a.setName(`${r.cos.cosBucket.name}-${r.cos.cosBucket.appid}`),a.setOperation(r.event.eventName.replace("cos:","")),U.addToMetadata(t,{"tencent.region":r.cos.cosBucket.cosRegion,"tencent.app_id":r.cos.cosBucket.appid,"tencent.cos.object_key":r.cos.cosObject.key,"tencent.cos.object_size":r.cos.cosObject.size,"tencent.cos.request_id":r.cos.cosObject.meta["x-cos-request-id"]})},cmq:function(e,t){const r=e.Records[0].CMQ,a=t.getResource();t.setId(r.msgId),a.setName(r.topicName),a.setOperation("consume"),U.addToMetadata(t,{"tencent.cmq.message.id":r.msgId,"tencent.cmq.message.tags":r.msgTag,"tencent.cmq.request_id":r.requestId,"tencent.cmq.subscription_name":r.subscriptionName},{"tencent.cmq.message.body":r.msgBody})},kafka:function(e,t){const r=e.Records[0].Ckafka,a=t.getResource();t.setId(r.msgKey),a.setName(r.topic),a.setOperation("consume"),U.addToMetadata(t,{"messaging.message.partition":r.partition,"messaging.message.offset":r.offset,"messaging.message.key":r.msgKey},{"messaging.message.body":r.msgBody})}};var tencent_function_createFromEvent=function(e,t,r){let a="json";e&&("Type"in e&&"Timer"===e.Type?a="timer":"httpMethod"in e?a="http":"Records"in e&&("cos"in e.Records[0]?a="cos":"CMQ"in e.Records[0]?a="cmq":"Ckafka"in e.Records[0]&&(a="kafka")));const n=new T.Resource,s=new T.Event;return s.setResource(n),xe[a](e,s,t,r),function(e,t){e.setStartTime(S.createTimestamp()),e.setDuration(S.createTimestampFromTime(0)),e.setOrigin("trigger"),e.getResource().setType(t),e.setErrorCode(v.ErrorCode.OK)}(s,a),s};var Se={createRunner:function(e){const t=new T.Resource([e.function_name,"tencent_function","invoke",{}]),r=new T.Event([e.request_id,0,null,"runner",0,v.ErrorCode.OK]);return r.setResource(t),U.addToMetadata(r,{"tencent.scf.version":e.function_version,"tencent.scf.memory":e.memory_limit_in_mb,"tencent.scf.cold_start":j.COLD_START,"tencent.namespace":e.namespace,"tencent.uin":e.tencentcloud_uin,"tencent.app_id":e.tencentcloud_appid,"tencent.region":e.tencentcloud_region}),j.COLD_START=!1,r}};const{getConfig:Re}=F,{MAX_VALUE_CHARS:Ae}=j,Me=Symbol("epsagonWrapped");function baseTencentFunctionWrapper(e){return le.getTrace=trace_object_get,(t,r,a)=>{let n,s;le.restart();let o=!1,i=!1;try{n=Se.createRunner(r),le.addRunner(n)}catch(n){return e(t,r,a)}try{const e=tencent_function_createFromEvent(t,r,n);le.addEvent(e)}catch(e){S.debugLog(`Error parsing trigger: ${e.stack}, Event: ${JSON.stringify(t)}`)}const p=Date.now(),runnerSendUpdateHandler=()=>{n.setDuration(S.createDurationTimestamp(p))},c=process._events.beforeExit;process._events.beforeExit=()=>{le.sendTrace(runnerSendUpdateHandler).then(()=>{process._events.beforeExit=c})};const handleUserExecutionDone=(e,t,a)=>{if(clearTimeout(s),o||i)return Promise.resolve();if(i=!0,e){let t=e;if(!e.name){let r;try{r="string"==typeof e?e:JSON.stringify(e)}catch(e){r=""}t={name:"SCFExecutionError",message:r}}n.getException()||(S.debugLog("Setting exception from handleUserExecutionDone"),U.setException(n,t,!1))}const{statusCode:p}=t||{};if(p&&U.addToMetadata(n,{status_code:p}),null===e&&!Re().metadataOnly){let e;try{e=JSON.stringify(void 0===t?null:t)}catch(t){e="Unable to stringify response body as json: "+t.message}U.addToMetadata(n,{"tencent.scf.return_data":e.substring(0,Ae)})}return process._events.beforeExit=c,o=!0,!a&&r.callbackWaitsForEmptyEventLoop?le.sendTrace(runnerSendUpdateHandler):(runnerSendUpdateHandler(),le.sendTraceSync())};!function(e,t){const r=process._events.uncaughtException;process._events.uncaughtException=(a,n)=>{process._events.uncaughtException=r,U.setException(t,a,!1),e(a,null,!0).then(()=>{r&&"function"==typeof r&&r(a,n)})};const a=process._events.unhandledRejection;process._events.unhandledRejection=(r,n)=>{process._events.unhandledRejection=a;const s=Error(r);U.setException(t,s,!1),e(s,null,!0).then(()=>{a&&"function"==typeof a&&a(r,n)})}}(handleUserExecutionDone,n);let u=Promise.resolve();const wrappedCallback=(e,t)=>{S.debugLog("wrapped callback called",e,t),i?S.debugLog("not calling callback since it was already called"):u=new Promise(r=>{S.debugLog("handling execution done before calling callback"),handleUserExecutionDone(e,t).then(()=>{S.debugLog("calling User's callback"),a(e,t),r()})})};try{s=setTimeout(()=>{S.debugLog("In timeout handler"),o=!0,U.markAsTimeout(n),runnerSendUpdateHandler(),le.sendTraceSync()},r.getRemainingTimeInMillis()-500),n.setStartTime(S.createTimestampFromTime(p));let a=e(t,r,wrappedCallback);if(a&&"function"==typeof a.then){let e,t;a=a.then(e=>(S.debugLog("user promise resolved (in then)"),t=e,handleUserExecutionDone(null,e,!0))).catch(t=>(S.debugLog("user promise rejected (in catch)"),e=t,handleUserExecutionDone(t,null,!0))).then(()=>u).then(()=>{if(e)throw e;return t})}return a}catch(e){throw e}}}var tencent_tencentFunctionWrapper=function(e){if(e[Me])return e;const t=baseTencentFunctionWrapper(e);return Object.defineProperty(t,Me,{value:!0,writable:!1}),t};const Ce=function(){const createErrorHandler=e=>(t,r)=>{r.fail(e)},createErrorHandlerWithMessage=(e,t)=>(r,a)=>{console.log(e),a.fail(t)},e=process.env.EPSAGON_HANDLER;if(!e)return createErrorHandler(new Error("invalid EPSAGON_HANDLER "+e));const t=e.split(".");if(2!==t.length)return createErrorHandler(new Error("Bad handler "+e));const r=t[0],a=t[1];try{const e=process.env.LAMBDA_TASK_ROOT,t=te(`${e}/${r}`);if(!t)return createErrorHandler(te.lastError());const n=t[a];return n||createErrorHandler(new Error(`Handler '${a}' missing on module '${r}'`))}catch(e){return"MODULE_NOT_FOUND"===e.code?createErrorHandlerWithMessage(`Unable to import module '${r}'`,e):e instanceof SyntaxError?createErrorHandlerWithMessage(`Syntax error in module '${r}'`,e):createErrorHandlerWithMessage("module initialization error",e)}}();var Oe={wrapper:F.getConfig().isEpsagonDisabled?Ce:lambda_lambdaWrapper(Ce)};const we=Symbol("epsagonWrapped"),Ne=new Map;function getTracer(){const e=process.env.__OW_ACTIVATION_ID;return e?Ne.get(e):null}function unregisterTracer(){const e=process.env.__OW_ACTIVATION_ID;e&&Ne.delete(e)}function baseOpenWhiskWrapper(e,t){return le.getTrace=getTracer,r=>{let a;t&&"object"==typeof t&&(t.token?le.initTrace(t):t.token_param&&r&&le.initTrace(Object.assign({token:r[t.token_param]},t))),function(){const e=process.env.__OW_ACTIVATION_ID;e&&Ne.set(e,le.createTracer())}(),le.restart();try{a=function(e,t){const r=new T.Resource([e,"openwhisk_action","invoke",{}]),a=new T.Event([process.env.__OW_ACTIVATION_ID,0,null,"runner",0,v.ErrorCode.OK]);return a.setResource(r),U.addToMetadata(a,{activation_id:process.env.__OW_ACTIVATION_ID,transaction_id:process.env.__OW_TRANSACTION_ID,api_host:process.env.__OW_API_HOST,namespace:process.env.__OW_NAMESPACE,params:t}),a}(process.env.__OW_ACTION_NAME,r)}catch(t){return e(r)}le.addRunner(a);const n=Date.now(),runnerSendUpdateHandler=()=>{a.setDuration(S.createDurationTimestamp(n))};try{a.setStartTime(S.createTimestampFromTime(n));const t=e(r);return t&&"function"==typeof t.then?t.catch(e=>{throw U.setException(a,e),runnerSendUpdateHandler(),e}).finally(()=>le.sendTrace(runnerSendUpdateHandler).catch(()=>{}).finally(unregisterTracer)):(le.sendTrace(runnerSendUpdateHandler).catch(()=>{}).finally(unregisterTracer),t)}catch(e){throw U.setException(a,e),runnerSendUpdateHandler(),le.sendTraceSync().finally(unregisterTracer),e}}}var openwhisk_openWhiskWrapper=function(e,t){if(e[we])return e;const r=baseOpenWhiskWrapper(e,t);return Object.defineProperty(r,we,{value:!0,writable:!1}),r};const{getConfig:Le}=F;var node_nodeWrapper=function(e){return le.getTrace=trace_object_get,(...r)=>{let a;le.restart();try{a=function(e,r){const a=new T.Resource([e.name||"handler","node_function","invoke",{}]),n=new T.Event([t(),0,null,"runner",0,v.ErrorCode.OK]);return n.setResource(a),U.addToMetadata(n,{args_length:r.length},{arguments:r}),U.createTraceIdMetadata(n),j.COLD_START=!1,n}(e,r)}catch(t){return e(...r)}le.addRunner(a);const n=Date.now(),runnerSendUpdateHandler=()=>{a.setDuration(S.createDurationTimestamp(n))};try{a.setStartTime(S.createTimestampFromTime(n));const t=e(...r);!function(e){process.env.EPSAGON_STEPS_ID&&U.addToMetadata(e,{steps_dict:{id:process.env.EPSAGON_STEPS_ID,step_num:process.env.EPSAGON_STEPS_NUM||0}})}(a);const s=Promise.resolve(t).then(e=>{if(!Le().metadataOnly){let t;try{t=JSON.stringify(void 0===e?null:e)}catch(e){t="Unable to stringify response body as json: "+e.message}U.addToMetadata(a,{return_value:t.substring(0,j.MAX_VALUE_CHARS)})}le.sendTrace(runnerSendUpdateHandler)}).catch(e=>{U.setException(a,e),runnerSendUpdateHandler(),le.sendTraceSync().then(()=>{throw e})});return t&&"function"==typeof t.then?s:t}catch(e){throw U.setException(a,e),runnerSendUpdateHandler(),le.sendTraceSync(),e}}};var google_cloud_function_googleCloudFunctionWrapper=function(e){return le.getTrace=trace_object_get,(t,r)=>{let a,n;le.restart();try{const{slsEvent:e,startTime:r}=function(e){const{slsEvent:t,startTime:r}=U.initializeEvent("google_cloud_function",process.env.K_SERVICE,"execute","runner");return U.addToMetadata(t,{"gcp.function.name":process.env.K_SERVICE,"gcp.function.revision":process.env.K_REVISION,"gcp.function.runtime":process.env.GAE_RUNTIME,"gcp.function.execution_id":e.headers["function-execution-id"],"gcp.function.cold_start":j.COLD_START}),U.createTraceIdMetadata(t),j.COLD_START=!1,{slsEvent:t,startTime:r}}(t);a=e,n=r,le.addRunner(a)}catch(a){return console.log(a),e(t,r)}return r.on("finish",()=>{a.setDuration(S.createDurationTimestamp(n));try{const e=function(e,t){const{slsEvent:r}=U.initializeEvent("http",e.hostname,e.method,"trigger");return U.addToMetadata(r,{"http.status_code":t.statusCode,"http.request.path":e.path},{"http.request.path_params":e.params,"http.request.headers":e.headers,"http.response.headers":t.getHeaders()}),e.body&&U.addToMetadata(r,{},{"http.request.body":e.body}),e.query&&U.addToMetadata(r,{},{"http.request.query_params":e.query}),r}(t,r);e.setDuration(S.createDurationTimestamp(n)),le.addEvent(e)}catch(e){S.debugLog("Error parsing trigger: "+e.stack)}le.sendTrace(()=>{})}),e(t,r)}};var Ie={createRunner:function(){const e=new T.Resource([process.env.AWS_BATCH_JOB_ID,"batch","invoke",{}]),t=new T.Event([process.env.AWS_BATCH_JOB_ID,0,null,"runner",0,v.ErrorCode.OK]);t.setResource(e),U.addToMetadata(t,{"Job ID":process.env.AWS_BATCH_JOB_ID,"Job Queue Name":process.env.AWS_BATCH_JQ_NAME,"Compute Environment Name":process.env.AWS_BATCH_CE_NAME,"Job Attempt":process.env.AWS_BATCH_JOB_ATTEMPT},{Hostname:process.env.HOSTNAME,Home:process.env.HOME,Path:process.env.PATH,Arguments:JSON.stringify(process.argv)}),U.createTraceIdMetadata(t);const a=r.get("http://169.254.169.254/latest/dynamic/instance-identity/document",{timeout:100}).then(e=>{S.debugLog("Got Batch response "+e.data);try{const r=JSON.parse(e.data);U.addToMetadata(t,{Region:r.region})}catch(e){S.debugLog("Could not parse Batch env data "+e.toString())}}).catch(e=>{throw le.addException(e),e});return{runner:t,runnerPromise:a}}},batch_wrapBatchJob=function(){le.getTrace=trace_object_get,le.restart();try{const{runner:e,runnerPromise:t}=Ie.createRunner();le.addRunner(e,t);const r=Date.now(),runnerSendUpdateHandler=()=>{e.setDuration(S.createDurationTimestamp(r))};e.setStartTime(S.createTimestampFromTime(r)),process.on("uncaughtException",t=>{U.setException(e,t)}),process.once("beforeExit",()=>{le.sendTrace(runnerSendUpdateHandler)});const processExitWrapper=e=>function(t){runnerSendUpdateHandler(),le.sendTraceSync(),e.apply(this,[t])};f.wrap(process,"exit",processExitWrapper)}catch(e){S.debugLog("failed to create Batch runner",e),le.addException(e)}};const{MAX_HTTP_VALUE_SIZE:De}=j,Pe={br:h.brotliDecompressSync,brotli:h.brotliDecompressSync,gzip:h.gunzipSync,deflate:h.deflateSync};function UUIDToHex(e){const t=Buffer.alloc(16);return m.parse(e,t),t.toString("hex")}var ke={isURLIgnoredByUser:function(e){return F.getConfig().urlPatternsToIgnore.some(t=>e.includes(t))},resolveHttpPromise:function(e,t,r){e.setDuration(S.createDurationTimestamp(r)),t()},USER_AGENTS_BLACKLIST:["openwhisk-client-js"],URL_BLACKLIST:{"tc.epsagon.com":"endsWith","oauth2.googleapis.com":"endsWith","amazonaws.com":(e,t)=>(e.endsWith(t)||e.endsWith(t+":443"))&&-1===e.indexOf(".execute-api.")&&-1===e.indexOf(".es.")&&-1===e.indexOf(".elb.")&&-1===e.indexOf(".appsync-api."),"blob.core.windows.net":"endsWith","myqcloud.com":"endsWith","documents.azure.com":"endsWith","127.0.0.1":(e,t,r)=>e===t&&r.startsWith("/2018-06-01/runtime/invocation/"),"169.254.169.254":"startsWith"},generateEpsagonTraceId:function(){return`${UUIDToHex(t())}:${UUIDToHex(t()).slice(16)}:${UUIDToHex(t()).slice(16)}:1`},updateAPIGateway:function(e,t){e&&"x-amzn-requestid"in e&&(t.getResource().setType("api_gateway"),U.addToMetadata(t,{request_trace_id:e["x-amzn-requestid"]}))},setJsonPayload:function(e,t,r,a){try{let n=r;if(F.getConfig().decodeHTTP&&Pe[a])try{n=Pe[a](r)}catch(e){S.debugLog(`Could decode ${t} with ${a} in http`)}const s=n;try{JSON.parse(s),U.addToMetadata(e,{},{[t]:s.toString()})}catch(r){S.debugLog(`Could not parse JSON ${t} in http`),U.addToMetadata(e,{},{[t]:n.toString("utf-8")})}}catch(a){S.debugLog(`Could not decode data and parse JSON ${t} in http`),U.addToMetadata(e,{},{[t]:r})}},addChunk:function(e,t){if(e){t.reduce((e,t)=>t.length+e,0)+e.length<=De&&t.push("string"==typeof e?Buffer.from(e):e)}}},We=createCommonjsModule((function(e){const{LAMBDA_DEFAULT_NODE_MODULES_PATH:t}=j;let r;const getAllNodeModulesPaths=(e,t=[])=>{let r=t;return n.readdirSync(e).forEach(t=>{n.statSync(`${e}/${t}`).isDirectory()&&("node_modules"===t?r.push(_.join(e,t)):r=getAllNodeModulesPaths(`${e}/${t}`,r))}),r};e.exports.getModules=function(e){const a=[];if("function"!=typeof require.resolve.paths){S.debugLog("require.resolve.paths is not a function");const t=te(e);return t&&a.push(t),a}const n=require.resolve.paths(e);if(process.env.EPSAGON_ADD_NODE_PATH&&n.push(...process.env.EPSAGON_ADD_NODE_PATH.split(":").map(e=>_.resolve(e.trim()))),process.env.EPSAGON_AUTO_ADD_NODE_PATHS&&"TRUE"===process.env.EPSAGON_AUTO_ADD_NODE_PATHS.toUpperCase()){const e=_.dirname(require.main.filename);r||(r=getAllNodeModulesPaths(e)),S.debugLog("Found the following paths",r),r.forEach(e=>{n.includes(e)||n.push(e)})}return S.isLambdaEnv&&!n.includes(t)&&n.push(t),S.distinct(n).forEach(t=>{const r=_.resolve(`${t}/${e}`),n=te(r);n&&(S.debugLog("Loaded module",e,t),a.push(n))}),a};const a=[];e.exports.patchModule=function(t,r,n,s=(e=>e)){S.debugLog("patching module:",t);const o=e.exports.getModules(t);S.debugLog("found module copies:",o.length),o.forEach(e=>{const o=s(e);a.push({id:t,methodName:r,module:o}),f.wrap(o,r,n)}),S.debugLog("done patching module:",t)},e.exports.patchSingle=function(e,t,r){a.push({id:t,methodName:t,module:e}),f.wrap(e,t,r)},e.exports.unpatchModules=function(){console.log("unpatching all modules"),a.forEach(e=>{console.log(`unpatching ${e.methodName} from ${e.id}`),f.unwrap(e.module,e.methodName)}),console.log("finished unpatching")}}));We.getModules,We.patchModule,We.patchSingle,We.unpatchModules;JSON.sortify=l;const{STEP_ID_NAME:qe}=j,Be=te("aws-sdk/clients/dynamodb"),je={generateItemHash(e){const t=Be.Converter.unmarshall(e);return d(JSON.sortify(t))},requestHandler(e,t){const r=e.params||{},a=t.getResource(),{operation:n}=e;switch(a.setName(r.TableName||"DynamoDBEngine"),n){case"deleteItem":U.addToMetadata(t,{item_hash:this.generateItemHash(r.Key)});case"getItem":U.addToMetadata(t,{},{Key:r.Key});break;case"putItem":U.addToMetadata(t,{item_hash:this.generateItemHash(r.Item)},{Item:JSON.stringify(r.Item)});break;case"updateItem":U.addToMetadata(t,{Key:r.Key},{"Update Expression":JSON.stringify(r.UpdateExpression),"Expression Attribute Names":JSON.stringify(r.ExpressionAttributeNames),"Expression Attribute Values":JSON.stringify(r.ExpressionAttributeValues)});break;case"query":U.addObjectToMetadata(t,"Parameters",r,["KeyConditions","QueryFilter","ExclusiveStartKey","ProjectionExpression","FilterExpression","KeyConditionExpression","ExpressionAttributeValues"]);break;case"scan":U.addObjectToMetadata(t,"Parameters",r,["ScanFilter","ExclusiveStartKey","ProjectionExpression","FilterExpression","ExpressionAttributeValues"]);break;case"batchWriteItem":{const e=Object.keys(r.RequestItems)[0];a.setName(e||r.TableName);const n=[],s=[];r.RequestItems[e].forEach(e=>{e.PutRequest&&n.push(e.PutRequest.Item),e.DeleteRequest&&s.push(e.DeleteRequest.Key)}),0!==n.length&&U.addToMetadata(t,{},{"Added Items":JSON.stringify(n)}),0!==s.length&&U.addToMetadata(t,{},{"Deleted Keys":JSON.stringify(s)});break}}},responseHandler(e,t){switch(e.request.operation){case"getItem":U.addToMetadata(t,{},{Item:JSON.stringify(e.data.Item)});break;case"updateItem":e.data.Attributes&&U.addToMetadata(t,{item_hash:this.generateItemHash(e.data.Attributes)},{});break;case"listTables":U.addToMetadata(t,{"Table Names":e.data.TableNames.join(", ")});break;case"scan":case"query":U.addObjectToMetadata(t,"Response",e.data,["Items","LastEvaluatedKey"])}}},initializeStepsDict=(e,r,a)=>{const n=(e.params||{})[r];let s;try{s=JSON.parse(n)}catch(e){s=null}s&&(s[qe]={id:t(),step_num:-1},e.params[r]=JSON.stringify(s),U.addToMetadata(a,{steps_dict:s[qe]}))},Fe={requestHandler(e,t){const r=(e.params||{}).Entries[0]||{},{operation:a}=e,n=t.getResource();switch(n.setType("events"),a){case"putEvents":n.setName(r.EventBusName||"CloudWatch Events"),U.addToMetadata(t,{"aws.cloudwatch.detail_type":r.DetailType,"aws.cloudwatch.resources":r.Resources,"aws.cloudwatch.source":r.Source},{"aws.cloudwatch.detail":r.Detail})}},responseHandler(e,t){switch(e.request.operation){case"putEvents":U.addToMetadata(t,{"aws.cloudwatch.event_id":""+e.data.Entries[0].EventId})}}},Ue={s3:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(n.setName(""+r.Bucket),a){case"headObject":case"getObject":case"putObject":n.getMetadataMap().set("key",""+r.Key)}},responseHandler(e,t){const r=t.getResource();switch(e.request.operation){case"listObjects":r.getMetadataMap().set("files",e.data.Contents.map(e=>[""+e.Key,e.Size,e.Etag]).toString());break;case"putObject":r.getMetadataMap().set("etag",""+e.data.ETag.replace(/"/g,""));break;case"headObject":case"getObject":U.addToMetadata(t,{etag:""+e.data.ETag.replace(/"/g,""),file_size:""+e.data.ContentLength,last_modified:""+e.data.LastModified})}}},kinesis:{requestHandler(e,t){const r=e.params||{},{operation:a}=e;switch(t.getResource().setName(""+r.StreamName||"Kinesis"),a){case"putRecord":U.addToMetadata(t,{partition_key:""+r.PartitionKey},{data:""+r.Data});break;case"putRecords":U.addToMetadata(t,{total_record_count:""+r.Records.length},{data:JSON.stringify(r.Records)})}},responseHandler(e,t){let r="",a=0;switch(e.request.operation){case"putRecord":U.addToMetadata(t,{shard_id:""+e.data.ShardId,sequence_number:""+e.data.SequenceNumber});break;case"putRecords":e.data.FailedRecordCount&&e.data.FailedRecordCount>0&&(r=JSON.stringify(e.data.Records.map(e=>e.ErrorMessage)),a=e.data.FailedRecordCount),U.addToMetadata(t,{total_record_count:""+e.data.Records.length,failed_record_count:""+a,kinesis_error_messages:r}),e.data.Records.length>0&&U.addToMetadata(t,{sequence_number:""+e.data.Records[0].SequenceNumber})}}},sns:{requestHandler(e,t){const r=e.params||{},a=t.getResource(),n=r.TopicArn||r.TargetArn;a.setName(""+n.split(":").pop()||"N/A"),U.addToMetadata(t,{},{"Notification Message":""+r.Message,"Notification Message Attributes":""+JSON.stringify(r.MessageAttributes)})},responseHandler(e,t){switch(e.request.operation){case"publish":U.addToMetadata(t,{"Message ID":""+e.data.MessageId})}}},sqs:{requestHandler(e,t){const r=e.params||{},a=t.getResource();"QueueUrl"in r&&a.setName(""+r.QueueUrl.split("/").pop()),"QueueName"in r&&a.setName(r.QueueName);const n="Entries"in r?r.Entries:r;"MessageBody"in n&&U.addToMetadata(t,{},{"Message Body":n.MessageBody}),"MessageAttributes"in n&&U.addToMetadata(t,{},{"Message Attributes":n.MessageAttributes})},responseHandler(e,t){let r="",a=0;switch(e.request.operation){case"sendMessage":U.addToMetadata(t,{"Message ID":""+e.data.MessageId,"MD5 Of Message Body":""+e.data.MD5OfMessageBody});break;case"sendMessageBatch":e.data.Successful&&e.data.Successful.length>0&&U.addToMetadata(t,{record:JSON.stringify(e.data.Successful.map(e=>e))}),e.data.Failed&&e.data.Failed>0&&(r=JSON.stringify(e.data.Failed.map(e=>e)),a=e.data.FailedRecordCount),U.addToMetadata(t,{successful_record_count:""+e.data.Successful.length,failed_record_count:""+a,sqs_error_messages:r});break;case"deleteMessageBatch":e.data.Failed&&e.data.Failed>0&&(r=JSON.stringify(e.data.Failed.map(e=>e)),a=e.data.FailedRecordCount),U.addToMetadata(t,{successful_record_count:""+e.data.Successful.length,failed_record_count:""+a,sqs_error_messages:r});break;case"receiveMessage":{let r=0;if("Messages"in e.data&&e.data.Messages.length>0){r=e.data.Messages.length,U.addToMetadata(t,{"Message ID":""+e.data.Messages[0].MessageId,"MD5 Of Message Body":""+e.data.Messages[0].MD5OfBody});const a=fe.getSNSTrigger(e.data.Messages);null!=a&&U.addToMetadata(t,{"SNS Trigger":a})}U.addToMetadata(t,{"Number Of Messages":r});break}}}},ses:{requestHandler(e,t){const r=e.params||{};switch(e.operation){case"sendEmail":U.addToMetadata(t,{source:""+r.Source,destination:""+r.Destination.ToAddresses},{subject:""+r.Message.Subject.Data,"Message Text":""+r.Message.Body.Text.Data,"Message Html":""+r.Message.Body.Html.Data})}},responseHandler(e,t){switch(e.request.operation){case"sendEmail":U.addToMetadata(t,{message_id:""+e.data.MessageId})}}},lambda:{requestHandler(e,t){const r=e.params||{},a=t.getResource();S.debugLog("Got lambda event on function: "+r.FunctionName);const n=r.FunctionName.includes(":")?r.FunctionName.split(":").slice(-1)[0]:r.FunctionName;a.setName(n),U.addToMetadata(t,{},{payload:""+r.Payload})},responseHandler(e,t){}},dynamodb:je,athena:{requestHandler(e,t){const r=e.params||{};switch(e.operation){case"startQueryExecution":"QueryExecutionContext"in r&&"Database"in r.QueryExecutionContext&&U.addToMetadata(t,{Database:""+r.QueryExecutionContext.Database}),U.addToMetadata(t,{},{Query:""+r.QueryString});break;case"getQueryExecution":case"getQueryResults":case"stopQueryExecution":U.addToMetadata(t,{"Query ID":""+r.QueryExecutionId})}},responseHandler(e,t){switch(e.request.operation){case"getQueryExecution":"Status"in e.data.QueryExecution&&"State"in e.data.QueryExecution.Status&&U.addToMetadata(t,{State:""+e.data.QueryExecution.Status.State}),"ResultConfiguration"in e.data.QueryExecution&&"OutputLocation"in e.data.QueryExecution.Status&&U.addToMetadata(t,{"Result Location":""+e.data.QueryExecution.ResultConfiguration.OutputLocation}),U.addToMetadata(t,{"Query ID":""+e.data.QueryExecutionId},{Query:""+e.data.Query});break;case"getQueryResults":U.addToMetadata(t,{"Query Row Count":""+e.data.ResultSet.Rows.length});break;case"startQueryExecution":U.addToMetadata(t,{"Query ID":""+e.data.QueryExecutionId})}}},stepfunctions:{patchInput(e,t){switch(e.operation){case"startExecution":case"stopExecution":initializeStepsDict(e,"input",t);break;case"sendTaskSuccess":case"sendTaskFailure":initializeStepsDict(e,"output",t)}},requestHandler(e,t){const r=e.params,a=t.getResource();switch(e.operation){case"startExecution":a.setName(""+r.stateMachineArn.split(":").pop()),U.addToMetadata(t,{"State Machine ARN":""+r.stateMachineArn,"Execution Name":""+r.name},{Input:""+r.input})}},responseHandler(e,t){switch(e.request.operation){case"startExecution":U.addToMetadata(t,{"Execution ARN":""+e.data.executionArn,"Start Date":""+e.data.startDate})}}},batch:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(a){case"submitJob":{n.setName(""+r.jobName);const e={};"containerOverrides"in r&&(e["Container Overrides"]=r.containerOverrides),"parameters"in r&&(e.Parameters=r.parameters),U.addToMetadata(t,{"Job Definition":""+r.jobDefinition,"Job Queue":""+r.jobQueue},e);break}}},responseHandler(e,t){switch(e.request.operation){case"submitJob":U.addToMetadata(t,{"Job ID":""+e.data.jobId})}}},cloudwatchevents:Fe,cognitoidentityserviceprovider:{requestHandler(e,t){const r=e.params||{},a=t.getResource();r.UserPoolId&&a.setName(r.UserPoolId),a.setType("cognito-idp"),U.addToMetadata(t,{},{"aws.cognito.request":r})},responseHandler(e,t){U.addToMetadata(t,{},{"aws.cognito.response":e.data})}},eventbridge:Fe,cloudwatchlogs:{requestHandler(e,t){const r=e.params||{},{operation:a}=e,n=t.getResource();switch(n.setType("logs"),a){case"filterLogEvents":n.setName(r.logGroupName),U.addToMetadata(t,{"aws.cloudwatch.log_streams":e.logStreamNames,"aws.cloudwatch.start_time":e.startTime});break;case"getMetricData":n.setName(r.logGroupName),U.addToMetadata(t,{"aws.cloudwatch.start_time":e.startTime,"aws.cloudwatch.end_time":e.endTime})}},responseHandler(e,t){switch(e.request.operation){case"filterLogEvents":U.addToMetadata(t,{"aws.cloudwatch.events_count":e.data.events.length,"aws.cloudwatch.searched_log_streams":e.data.searchedLogStreams.length})}}},ssm:{requestHandler(e,t){const r=e.params||{},a=t.getResource(),{operation:n}=e;switch(a.setName(r.Name||r.Path||"SSM"),n){case"getParameter":case"getParameters":case"getParametersByPath":U.addToMetadata(t,{},{WithDecryption:r.WithDecryption})}},responseHandler(e,t){switch(e.request.operation){case"getParameter":U.addToMetadata(t,{},{parameter:{Name:(e.data.Parameter||{Name:""}).Name||"",Value:(e.data.Parameter||{Value:""}).Value||"",Type:(e.data.Parameter||{Type:""}).Type||""}});break;case"getParameters":case"getParametersByPath":e.data.InvalidParameters&&e.data.InvalidParameters.length>0&&U.addToMetadata(t,{},{invalid_parameters:e.data.InvalidParameters}),e.data.Parameters&&e.data.Parameters.length>0&&U.addToMetadata(t,{},{parameters:e.data.Parameters.map(e=>({Name:e.Name,Value:e.Value,Type:e.Type}))})}}}};function AWSSDKWrapper(e){return function(t){try{const r=this,{serviceIdentifier:a}=r.service.constructor.prototype;if(!(a in Ue))return e.apply(this,[t]);const n=new T.Resource(["",a,""+r.operation]),s=Date.now(),o=new T.Event(["",S.createTimestampFromTime(s),null,"aws-sdk",0,v.ErrorCode.OK]);o.setResource(n),"patchInput"in Ue[a]&&Ue[a].patchInput(this,o);const i=new Promise(e=>{r.on("send",()=>{try{Ue[a].requestHandler(r,o)}catch(e){le.addException(e)}}).on("error",e=>{try{U.setException(o,e)}catch(e){le.addException(e)}}).on("complete",t=>{try{o.setId(""+t.requestId),o.setDuration(S.createDurationTimestamp(s)),null!==t.data&&(o.setErrorCode(v.ErrorCode.OK),U.addToMetadata(o,{request_id:""+t.requestId,retry_attempts:""+t.retryCount,status_code:""+t.httpResponse.statusCode}),Ue[a].responseHandler(t,o)),null!==t.error&&(o.getErrorCode()!==v.ErrorCode.EXCEPTION&&o.setErrorCode(v.ErrorCode.ERROR),U.addToMetadata(o,{request_id:""+t.requestId,error_message:""+t.error.message,error_code:""+t.error.code}))}catch(e){le.addException(e)}finally{e()}})});le.addEvent(o,i)}catch(e){le.addException(e)}return e.apply(this,[t])}}function wrapPromiseOnAdd(e){return function(t){const r=e.apply(this,[t]);try{We.patchModule("aws-sdk/global","promise",AWSSDKWrapper,e=>e.Request.prototype)}catch(e){S.debugLog("Failed to re-instrument aws-sdk's promise method",e)}return r}}var ze={init(){We.patchModule("aws-sdk/global","send",AWSSDKWrapper,e=>e.Request.prototype),We.patchModule("aws-sdk/global","promise",AWSSDKWrapper,e=>e.Request.prototype),We.patchModule("aws-sdk/global","addPromisesToClass",wrapPromiseOnAdd,e=>e.Request)},dynamoDBEventCreator:je};const{dynamoDBEventCreator:He}=ze;function DAXWrapper(e){return function(t,r,a,n){const s=new T.Resource(["","dax",""+t]),o=Date.now(),i=new T.Event(["",S.createTimestampFromTime(o),null,"amazon-dax-client",0,v.ErrorCode.OK]);i.setResource(s);try{He.requestHandler({params:r,operation:t},i)}catch(e){le.addException(e)}const p=e.apply(this,[t,r,a,n]);try{const e=new Promise(e=>{p.once("error",e=>{try{U.setException(i,e)}catch(e){le.addException(e)}if(0===p.listenerCount("error"))throw e}).on("complete",t=>{try{i.setId(""+t.requestId),i.setDuration(S.createDurationTimestamp(o)),null!==t.data&&(i.setErrorCode(v.ErrorCode.OK),U.addToMetadata(i,{request_id:""+t.requestId,retry_attempts:""+t.retryCount,status_code:""+t.httpResponse.statusCode}),He.responseHandler(t,i)),null!==t.error&&(i.getErrorCode()!==v.ErrorCode.EXCEPTION&&i.setErrorCode(v.ErrorCode.ERROR),U.addToMetadata(i,{request_id:""+t.requestId,error_message:""+t.error.message,error_code:""+t.error.code}))}catch(e){le.addException(e)}finally{e()}})});le.addEvent(i,e)}catch(e){le.addException(e)}return p}}var Ge={init(){We.patchModule("amazon-dax-client","_makeWriteRequestWithRetries",DAXWrapper,e=>e.prototype),We.patchModule("amazon-dax-client","_makeReadRequestWithRetries",DAXWrapper,e=>e.prototype)}};const{isBlacklistURL:Ke,isBlacklistHeader:Je}=ce,{isURLIgnoredByUser:Qe,resolveHttpPromise:Ve,USER_AGENTS_BLACKLIST:Ze,URL_BLACKLIST:Xe,generateEpsagonTraceId:Ye,updateAPIGateway:et,setJsonPayload:tt,addChunk:rt}=ke;function requestOnWrapper(e,t){return function(r,a,n){if("response"!==r||"skip"===n||"function"!=typeof a)return e.apply(this,[r,a]);return e.apply(this,[r,(e=>(e&&e.EPSAGON_PATCH||(e.EPSAGON_PATCH=!0,f.wrap(e,"on",e=>function(e,t){return function(r,a){return"data"!==r||"function"!=typeof a?e.apply(this,[r,a]):e.apply(this,[r,(e=>(rt(e,t),a(e))).bind(this)])}}(e,t))),a(e))).bind(this)])}}function httpWrapper(e){return function(r,a,n){const{url:s,options:o,callback:i}=function(e,t,r){let a=e,n=t,s=r;return["string","URL"].includes(typeof a)||s||(s=t,n=e,a=void 0),"function"!=typeof n||s||(s=n,n=null),e.constructor&&"URL"===e.constructor.name&&"object"==typeof t&&!r&&(a=e,a.path=a.pathname,n=t,s=void 0),{url:a,options:n,callback:s}}(r,a,n),p=[];let c=null;try{let u=s;"string"==typeof u&&(u=E.parse(u));let d=u&&u.hostname||u&&u.host||o&&o.hostname||o&&o.host||o&&o.uri&&o.uri.hostname||"localhost";if(S.debugLog("[http] captured call "+d),i&&i.__epsagonCallback)return S.debugLog("[http] filtered patched callback "+d),e.apply(this,[r,a,n]);o.port&&!["80","443",80,443].includes(o.port)&&(d=`${d}:${o.port}`);const l=u&&u.path||o&&o.path||"/",g=u&&u.pathname||o&&o.pathname||"/",h=o&&o.headers||{};if(Ke(d,Xe,l)||Qe(d))return S.debugLog("[http] filtered ignored hostname "+d),e.apply(this,[r,a,n]);if(Je(h,Ze))return S.debugLog("[http] filtered ignored headers"),e.apply(this,[r,a,n]);const m=Ye();"TRUE"!==(process.env.EPSAGON_DISABLE_HTTP_TRACE_ID||"").toUpperCase()&&(h["epsagon-trace-id"]=m,o.headers||(o.headers=h)),o&&o.headers&&o.headers.epsagonSkipResponseData&&o.agent&&(o.agent.epsagonSkipResponseData=!0,delete o.headers.epsagonSkipResponseData);const _=o&&o.agent||o&&o._defaultAgent||void 0,b=u&&u.port||o&&o.port||o&&o.defaultPort||_&&_.defaultPort||80;let y=u&&u.protocol||443===b&&"https:"||o&&o.protocol||_&&_.protocol||"http:";y=y.slice(0,-1);const $=o&&o.body&&(o.body instanceof String||o.body instanceof Buffer)?o.body:"",x=o&&o.method||"GET",R=new T.Resource([d,"http",x]),A=Date.now(),M=new T.Event(["http-"+t(),S.createTimestampFromTime(A),null,"http",0,v.ErrorCode.OK]),C=`${y}://${d}${g}`;M.setResource(R),U.addToMetadata(M,{url:C,http_trace_id:m},{path:l,request_headers:h}),$&&(S.debugLog("Set request body="+$),U.addToMetadata(M,{},{request_body:$}));const patchedCallback=e=>{S.debugLog("[http] patched callback called for "+d);const t={};"x-openwhisk-activation-id"in e.headers&&(t.openwhisk_act_id=e.headers["x-openwhisk-activation-id"]),"x-last-activation-id"in e.headers&&(t.openwhisk_last_act_id=e.headers["x-last-activation-id"]),"x-request-id"in e.headers&&(t.request_id=e.headers["x-request-id"]),U.addToMetadata(M,{status:e.statusCode}),e.statusCode>=F.HTTP_ERR_CODE&&U.setException(M,new Error("Response code: "+e.statusCode)),U.addToMetadata(M,t,{response_headers:e.headers}),e.req&&e.req.getHeaders()&&U.addToMetadata(M,{},{request_headers:e.req.getHeaders()}),et(e.headers,M),i&&"function"==typeof i&&i(e)};patchedCallback.__epsagonCallback=!0,c=e.apply(this,function(e,t,r){return e&&t?[e,t,r]:e&&!t?[e,r]:[t,r]}(s,o,patchedCallback)),S.debugLog("[http] request sent "+d),o&&o.epsagonSkipResponseData&&!F.getConfig().disableHttpResponseBodyCapture&&f.wrap(c,"on",e=>requestOnWrapper(e,p));try{f.wrap(c,"write",(function(e){return function(...t){try{$&&""!==$||!t[0]||!("string"==typeof t[0]||t[0]instanceof Buffer)||tt(M,"request_body",t[0])}catch(e){S.debugLog("Could not parse request body in write wrapper")}return e.apply(this,t)}})),f.wrap(c,"end",(function(e){return function(...t){try{$&&""!==$||!t[0]||!("string"==typeof t[0]||t[0]instanceof Buffer)||tt(M,"request_body",t[0])}catch(e){S.debugLog("Could not parse request body in end wrapper")}return e.apply(this,t)}}))}catch(e){}const O=new Promise(e=>{let t=!1;c.on("timeout",()=>{t=!0}),c.once("error",r=>{const a=new Error;if(a.message=r.message,a.stack=r.stack,a.name=r.name,t&&(a.message+="\nTimeout exceeded"),c.aborted&&(a.message+="\nRequest aborted"),U.setException(M,a),Ve(M,e,A),0===c.listenerCount("error"))throw r});c.on("response",t=>{S.debugLog("[http] response arrived for "+d),(()=>{if(o){if(o.epsagonSkipResponseData)return!0;if(o.agent&&o.agent.epsagonSkipResponseData)return!0}return!!F.getConfig().disableHttpResponseBodyCapture})()||t.on("data",e=>rt(e,p)),t.on("end",()=>{const r=t.headers&&t.headers["content-encoding"];tt(M,"response_body",Buffer.concat(p),r),Ve(M,e,A)})},"skip")}).catch(e=>{le.addException(e)});le.addEvent(M,O),S.debugLog("[http] event added "+d)}catch(e){le.addException(e)}return c||(S.debugLog("[http] not client request set"),c=e.apply(this,[r,a,n])),S.debugLog("[http] done handling call"),c}}function httpGetWrapper(e){return function(t,r,a){const n=e.request(t,r,a);return n.end(),n}}function fetchH2Wrapper(e){return function(t){return e.apply(this,[{...t,epsagonSkipResponseData:!0}])}}function clientRequestWrapper(e){return function(t,r,a){const n=a||{};return n.headers?n.headers={...a.headers,epsagonSkipResponseData:!0}:n.headers={epsagonSkipResponseData:!0},e.apply(this,[t,r,n])}}var at={init(){f.wrap(p,"get",()=>httpGetWrapper(p)),f.wrap(p,"request",httpWrapper),f.wrap(i,"get",()=>httpGetWrapper(i)),f.wrap(i,"request",httpWrapper),We.patchModule("fetch-h2/dist/lib/context-http1","connect",fetchH2Wrapper,e=>e.OriginPool.prototype),We.patchModule("simple-oauth2/lib/client.js","request",clientRequestWrapper,e=>e.prototype),We.patchModule("simple-oauth2/lib/client/client.js","request",clientRequestWrapper,e=>e.prototype)}};const{MAX_HTTP_VALUE_SIZE:nt}=j,{isBlacklistURL:st,isBlacklistHeader:ot}=ce,{isURLIgnoredByUser:it,resolveHttpPromise:pt,USER_AGENTS_BLACKLIST:ct,URL_BLACKLIST:ut,generateEpsagonTraceId:dt,updateAPIGateway:lt,setJsonPayload:gt}=ke,ft=te("http2");function extractHeaders(e){return Object.entries(e).filter(e=>!e[0].startsWith(":")).reduce((e,t)=>{const[r,a]=t;return e[r]=a,e},{})}function wrapHttp2Connect(e){return function(t,r,a){const n=e.apply(this,[t,r,a]);try{f.wrap(n,"request",e=>function(e,t){return function(r,a){let n=null,s=null,o=null;try{const{hostname:n}=E.parse(t);if(st(n,ut,r[":path"])||it(n))return S.debugLog("filtered blacklist hostname "+n),e.apply(this,[r,a]);const i=extractHeaders(r);if(ot(i,ct))return S.debugLog("filtered blacklist headers"),e.apply(this,[r,a]);const p=dt();r["epsagon-trace-id"]=p;const{slsEvent:c,startTime:u}=U.initializeEvent("http",n,r[":method"],"http");s=c,o=u,U.addToMetadata(s,{http_trace_id:p},{path:r[":path"],request_headers:i})}catch(t){return le.addException(t),e.apply(this,[r,a])}try{n=e.apply(this,[r,a])}catch(e){throw U.setException(s,e),le.addEvent(s),e}try{const e=new Promise(e=>{const t=[];let r;F.getConfig().disableHttpResponseBodyCapture||n.on("data",e=>{e&&t.reduce((e,t)=>t.length+e,0)+e.length<=nt&&t.push("string"==typeof e?Buffer.from(e):e)}),n.once("error",t=>{if(U.setException(s,t),pt(s,e,o),0===n.listenerCount("error"))throw t}),n.once("close",()=>{const a=r&&r["content-encoding"];gt(s,"response_body",Buffer.concat(t),a),pt(s,e,o)}),n.once("response",e=>{lt(e,s),r=extractHeaders(e),U.addToMetadata(s,{status:e[":status"]},{response_headers:r})})}).catch(e=>{le.addException(e)});le.addEvent(s,e)}catch(e){le.addException(e)}return n}}(e,t))}catch(e){S.debugLog("Could not instrument http2 session request "+e)}return n}}var ht={init(){ft&&(S.debugLog("Patching http2 module"),f.wrap(ft,"connect",wrapHttp2Connect))}};function peg$SyntaxError(e,t,r,a){this.message=e,this.expected=t,this.found=r,this.location=a,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}!function(e,t){function ctor(){this.constructor=e}ctor.prototype=t.prototype,e.prototype=new ctor}(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(e,t){var r={literal:function(e){return'"'+literalEscape(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?classEscape(e.parts[t][0])+"-"+classEscape(e.parts[t][1]):classEscape(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function hex(e){return e.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+hex(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+hex(e)}))}function classEscape(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+hex(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+hex(e)}))}return"Expected "+function(e){var t,a,n,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=(n=e[t],r[n.type](n));if(s.sort(),s.length>0){for(t=1,a=1;t<s.length;t++)s[t-1]!==s[t]&&(s[a]=s[t],a++);s.length=a}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+literalEscape(e)+'"':"end of input"}(t)+" found."};var mt={SyntaxError:peg$SyntaxError,parse:function(e,t){t=void 0!==t?t:{};var r,a={},n={start:peg$parsestart},s=peg$parsestart,o="(",i=peg$literalExpectation("(",!1),p=")",c=peg$literalExpectation(")",!1),u=peg$literalExpectation(";",!1),d="=",l=peg$literalExpectation("=",!1),g=peg$literalExpectation("KEY",!0),f="index",h=peg$literalExpectation("INDEX",!0),m=peg$otherExpectation("column_clause"),peg$c28=function(e,t){return createList(e,t)},_="`",E=peg$literalExpectation("`",!1),peg$c51=function(e,t){var r={type:"expr_list"},a=function(e,t,r){for(var a,n=createList(e,t),s=[],o=0;o<n.length;o++)"param"==(a=n[o]).type?(a.room=r,a.pos=o):s.push(a);return s}(e,t,r);return r.value=a,r},peg$c54=function(e,t){return createBinaryExprChain(e,t)},b=peg$literalExpectation("!",!1),y=peg$literalExpectation(">=",!1),v=peg$literalExpectation(">",!1),T=peg$literalExpectation("<=",!1),$=peg$literalExpectation("<>",!1),x=peg$literalExpectation("<",!1),S=peg$literalExpectation("!=",!1),peg$c72=function(e,t){return{op:e,right:t}},peg$c74=function(e){return e[0]+" "+e[2]},peg$c75=function(e,t){return{op:e,right:t}},peg$c76=function(e,t){return{op:e,right:t}},R=peg$literalExpectation("+",!1),A=peg$literalExpectation("-",!1),M="*",C=peg$literalExpectation("*",!1),O=peg$literalExpectation("/",!1),w=peg$literalExpectation("%",!1),peg$c88=function(e){return e.paren=!0,e},peg$c91=function(e){return!0===Xt[e.toUpperCase()]},N=/^[^`]/,L=peg$classExpectation(["`"],!0,!1),peg$c96=function(e,t){return e+t.join("")},I=/^[A-Za-z_]/,D=peg$classExpectation([["A","Z"],["a","z"],"_"],!1,!1),P=/^[A-Za-z0-9_]/,k=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_"],!1,!1),W=/^[A-Za-z0-9_:]/,q=peg$classExpectation([["A","Z"],["a","z"],["0","9"],"_",":"],!1,!1),B=peg$otherExpectation("PARAM[:param, ?]"),j=peg$literalExpectation(":",!1),F=peg$literalExpectation("?",!1),U=/^[0-9a-zA-Z_]/,z=peg$classExpectation([["0","9"],["a","z"],["A","Z"],"_"],!1,!1),H='"',G=peg$literalExpectation('"',!1),K="'",J=peg$literalExpectation("'",!1),Q=/^[^'\\\0-\x1F\x7F]/,V=peg$classExpectation(["'","\\",["\0",""],""],!0,!1),Z=/^[^"\\\0-\x1F\x7F]/,X=peg$classExpectation(['"',"\\",["\0",""],""],!0,!1),Y=peg$literalExpectation("\\'",!1),ee=peg$literalExpectation('\\"',!1),te=peg$literalExpectation("\\\\",!1),re=peg$literalExpectation("\\/",!1),ae=peg$literalExpectation("\\b",!1),ne=peg$literalExpectation("\\f",!1),se=peg$literalExpectation("\\n",!1),oe=peg$literalExpectation("\\r",!1),ie=peg$literalExpectation("\\t",!1),pe=peg$literalExpectation("\\u",!1),ce=peg$otherExpectation("LITERAL INT"),ue=".",de=peg$literalExpectation(".",!1),le=peg$otherExpectation("NUMBER"),ge=/^[0-9]/,fe=peg$classExpectation([["0","9"]],!1,!1),he=/^[1-9]/,me=peg$classExpectation([["1","9"]],!1,!1),_e=peg$otherExpectation("HEX"),Ee=/^[0-9a-fA-F]/,be=peg$classExpectation([["0","9"],["a","f"],["A","F"]],!1,!1),ye=/^[eE]/,ve=peg$classExpectation(["e","E"],!1,!1),Te=/^[+\-]/,$e=peg$classExpectation(["+","-"],!1,!1),xe="null",Se=peg$literalExpectation("NULL",!0),Re="true",Ae=peg$literalExpectation("TRUE",!0),Me="false",Ce=peg$literalExpectation("FALSE",!0),Oe="select",we=peg$literalExpectation("SELECT",!0),Ne="update",Le=peg$literalExpectation("UPDATE",!0),Ie="create",De=peg$literalExpectation("CREATE",!0),Pe="delete",ke=peg$literalExpectation("DELETE",!0),We="insert",qe=peg$literalExpectation("INSERT",!0),Be="replace",je=peg$literalExpectation("REPLACE",!0),Fe="into",Ue=peg$literalExpectation("INTO",!0),ze="from",He=peg$literalExpectation("FROM",!0),Ge=peg$literalExpectation("SET",!0),Ke=peg$literalExpectation("AS",!0),Je="table",Qe=peg$literalExpectation("TABLE",!0),Ve=peg$literalExpectation("ON",!0),Ze="left",Xe=peg$literalExpectation("LEFT",!0),Ye="inner",et=peg$literalExpectation("INNER",!0),tt=peg$literalExpectation("JOIN",!0),rt=peg$literalExpectation("UNION",!0),at="values",nt=peg$literalExpectation("VALUES",!0),st=peg$literalExpectation("IF",!0),ot="exists",it=peg$literalExpectation("EXISTS",!0),pt="where",ct=peg$literalExpectation("WHERE",!0),ut="group",dt=peg$literalExpectation("GROUP",!0),lt=peg$literalExpectation("BY",!0),gt="order",ft=peg$literalExpectation("ORDER",!0),ht="limit",mt=peg$literalExpectation("LIMIT",!0),_t=peg$literalExpectation("ASC",!0),Et="desc",bt=peg$literalExpectation("DESC",!0),yt=peg$literalExpectation("ALL",!0),vt=peg$literalExpectation("DISTINCT",!0),Tt="between",$t=peg$literalExpectation("BETWEEN",!0),xt=peg$literalExpectation("IN",!0),St=peg$literalExpectation("IS",!0),Rt=peg$literalExpectation("LIKE",!0),At=peg$literalExpectation("CONTAINS",!0),Mt=peg$literalExpectation("NOT",!0),Ct=peg$literalExpectation("AND",!0),Ot=peg$literalExpectation("OR",!0),wt="count",Nt=peg$literalExpectation("COUNT",!0),Lt=peg$literalExpectation(",",!1),It=peg$literalExpectation("[",!1),Dt=peg$literalExpectation("]",!1),Pt=peg$otherExpectation("WHITE_SPACE"),kt=/^[ \t\n\r]/,Wt=peg$classExpectation([" ","\t","\n","\r"],!1,!1),qt=peg$literalExpectation("$",!1),Bt="return",jt=peg$literalExpectation("return",!0),Ft=":=",Ut=peg$literalExpectation(":=",!1),zt=0,Ht=[{line:1,column:1}],Gt=0,Kt=[],Jt=0;if("startRule"in t){if(!(t.startRule in n))throw new Error("Can't start parsing from rule \""+t.startRule+'".');s=n[t.startRule]}function peg$literalExpectation(e,t){return{type:"literal",text:e,ignoreCase:t}}function peg$classExpectation(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function peg$otherExpectation(e){return{type:"other",description:e}}function peg$computePosDetails(t){var r,a=Ht[t];if(a)return a;for(r=t-1;!Ht[r];)r--;for(a={line:(a=Ht[r]).line,column:a.column};r<t;)10===e.charCodeAt(r)?(a.line++,a.column=1):a.column++,r++;return Ht[t]=a,a}function peg$computeLocation(e,t){var r=peg$computePosDetails(e),a=peg$computePosDetails(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:a.line,column:a.column}}}function peg$fail(e){zt<Gt||(zt>Gt&&(Gt=zt,Kt=[]),Kt.push(e))}function peg$parsestart(){var t,r,n,s;return t=zt,(r=peg$parse__())!==a?((n=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseselect_stmt())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_UNION())!==a&&(i=peg$parse__())!==a&&(p=peg$parseselect_stmt())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_UNION())!==a&&(i=peg$parse__())!==a&&(p=peg$parseselect_stmt())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=function(e,t){for(var r=e,a=0;a<t.length;a++)r._next=t[a][3],r=r._next;return e}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(n=function(){var t,r,n,s;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Ne?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(Le));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parsetable_name())!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,"set"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Ge));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(n=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseset_item())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseset_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseset_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&peg$parse__()!==a&&(s=peg$parsewhere_clause())!==a?(i=n,p=s,t={type:"update",db:(o=r).db,table:o.table,set:i,where:p}):(zt=t,t=a);var o,i,p;return t}())===a&&(n=function(){var t,r,n;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Pe?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(ke));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parsefrom_clause())!==a&&peg$parse__()!==a?((n=peg$parsewhere_clause())===a&&(n=null),n!==a?t={type:"delete",from:r,where:n}:(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(n=function(){var t,r,n,s,o;t=zt,(r=function(){var t,r;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===We?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(qe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r="insert");(t=r)===a&&(t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,7).toLowerCase()===Be?(r=e.substr(zt,7),zt+=7):(r=a,0===Jt&&peg$fail(je));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r="replace"),t=r);return t}())!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Fe?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Ue));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(n=peg$parsetable_name())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(s=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a&&peg$parse__()!==a&&(o=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===at?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(nt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsevalue_item())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsevalue_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsevalue_item())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())!==a?(p=s,c=o,t=r={type:r,db:(i=n).db,table:i.table,columns:p,values:c}):(zt=t,t=a);var i,p,c;return t}())===a&&(n=function(){var t,r,n,s,d,l,g,f,h,m,_,E,b;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Ie?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(De));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Je?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Qe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a?(r=zt,(n=function(){var t,r,n,s;t=zt,"if"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(st));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(s=peg$parse__())!==a&&(d=peg$parseKW_NOT())!==a&&(l=peg$parse__())!==a&&(g=function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===ot?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(it));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(f=peg$parse__())!==a?r=n=[n,s,d,l,g,f]:(zt=r,r=a),r===a&&(r=null),r!==a&&(n=peg$parsetable_name())!==a&&(s=peg$parse__())!==a?(40===e.charCodeAt(zt)?(d=o,zt++):(d=a,0===Jt&&peg$fail(i)),d!==a&&(l=peg$parse__())!==a&&(g=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn_def())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_def())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_def())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=createList(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a&&(f=peg$parse__())!==a?(41===e.charCodeAt(zt)?(h=p,zt++):(h=a,0===Jt&&peg$fail(c)),h!==a&&peg$parse__()!==a?((m=function(){var e,t,r,n,s,o;if(e=zt,(t=peg$parsetable_option())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsetable_option())!==a?n=s=[s,o]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsetable_option())!==a?n=s=[s,o]:(zt=n,n=a);r!==a?e=t=function(e,t){let r=e;return t.forEach(e=>{let t=e[1];Object.keys(t).forEach(e=>{r[e]=t[e].column})}),r}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(m=null),m!==a&&peg$parse__()!==a?((_=function(){var e,t,r,n,s,o;if(e=zt,(t=peg$parseprimary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseprimary())!==a?n=s=[s,o]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseprimary())!==a?n=s=[s,o]:(zt=n,n=a);r!==a?e=t=function(e,t){let r=[e];return t.forEach(e=>{r.push(e)}),r}(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())===a&&(_=null),_!==a&&peg$parse__()!==a?(59===e.charCodeAt(zt)?(E=";",zt++):(E=a,0===Jt&&peg$fail(u)),E===a&&(E=null),E!==a?((b=peg$parse__())===a&&(b=null),b!==a?t={type:"create_table",name:n,columns:g,tableOptions:m,partitionOptions:_}:(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}()),n!==a?((s=n).params=Yt,t=r=s):(zt=t,t=a)):(zt=t,t=a),t===a&&(t=zt,(r=function(){var e,t;e=[],t=peg$parseproc_stmt();for(;t!==a;)e.push(t),t=peg$parseproc_stmt();return e}())!==a&&(r=r),t=r),t}function peg$parsecolumn_def(){var t,r,n,s,u,d,l;if((t=function(){var t,r,n,s,u,d,l,m;t=zt,r=zt,n=zt,s=[],u=peg$parseident_name();for(;u!==a;)s.push(u),u=peg$parseident_name();s!==a&&(u=peg$parse__())!==a?("key"===e.substr(zt,3).toLowerCase()?(d=e.substr(zt,3),zt+=3):(d=a,0===Jt&&peg$fail(g)),d===a&&(e.substr(zt,5).toLowerCase()===f?(d=e.substr(zt,5),zt+=5):(d=a,0===Jt&&peg$fail(h))),d!==a?n=s=[s,u,d]:(zt=n,n=a)):(zt=n,n=a);r=n!==a?e.substring(r,zt):n;r!==a&&(n=peg$parse__())!==a&&(s=peg$parsecolumn())!==a&&(u=peg$parse__())!==a?(40===e.charCodeAt(zt)?(d=o,zt++):(d=a,0===Jt&&peg$fail(i)),d!==a&&(l=peg$parsecolumn_clause())!==a?(41===e.charCodeAt(zt)?(m=p,zt++):(m=a,0===Jt&&peg$fail(c)),m!==a?t=r=function(e,t,r){let a=[];return r.forEach(e=>{a.push(e.expr.column)}),{type:e,name:t,columns:a}}(r,s,l):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}())===a)if(t=zt,(r=peg$parsecolumn())!==a)if(peg$parse__()!==a)if((n=function(){var e;zt,(e=peg$parsefunc_call())===a&&(e=peg$parseident());e!==a&&(e=function(e){if("function"===e.type){let t=[];return e.args.value.forEach(e=>{t.push(e.value)}),{type:e.name,args:t}}return{type:e}}(e));return e}())!==a){for(s=[],u=zt,(d=peg$parse__())!==a?((l=peg$parseliteral())===a&&(l=peg$parseident_name()),l!==a?u=d=[d,l]:(zt=u,u=a)):(zt=u,u=a);u!==a;)s.push(u),u=zt,(d=peg$parse__())!==a?((l=peg$parseliteral())===a&&(l=peg$parseident_name()),l!==a?u=d=[d,l]:(zt=u,u=a)):(zt=u,u=a);s!==a?t=r=function(e,t,r){let a=[];return r.forEach(e=>{a.push(e[1])}),{name:e,type:t,ext:a}}(r,n,s):(zt=t,t=a)}else zt=t,t=a;else zt=t,t=a;else zt=t,t=a;return t}function peg$parsetable_option(){var t,r,n,s;return t=zt,(r=peg$parseprimary())!==a&&peg$parse__()!==a?(61===e.charCodeAt(zt)?(n=d,zt++):(n=a,0===Jt&&peg$fail(l)),n===a&&(n=null),n!==a&&peg$parse__()!==a&&(s=peg$parseprimary())!==a?t=r=function(e,t){let r={},a="column_ref"===e.type?e.column:e.value,n="column_ref"===t.type?t.column:t.value;return r[a]=n,r}(r,s):(zt=t,t=a)):(zt=t,t=a),t}function peg$parseselect_stmt(){var t,r,n,s,u,d,l;return(t=function(){var t,r,n,s,o,i,p,c;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,6).toLowerCase()===Oe?(r=e.substr(zt,6),zt+=6):(r=a,0===Jt&&peg$fail(we));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a?((r=peg$parseKW_DISTINCT())===a&&(r=null),r!==a&&peg$parse__()!==a&&(n=peg$parsecolumn_clause())!==a&&peg$parse__()!==a?((s=peg$parsefrom_clause())===a&&(s=null),s!==a&&peg$parse__()!==a?((o=peg$parsewhere_clause())===a&&(o=null),o!==a&&peg$parse__()!==a?((i=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===ut?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(dt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&peg$parseKW_BY()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsecolumn_ref())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_ref())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parsecolumn_ref())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())===a&&(i=null),i!==a&&peg$parse__()!==a?((p=function(){var t,r;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===gt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(ft));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&peg$parseKW_BY()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseorder_by_element())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseorder_by_element())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseorder_by_element())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}())!==a?t=r:(zt=t,t=a);return t}())===a&&(p=null),p!==a&&peg$parse__()!==a?((c=function(){var t,r,n,s,o,i;t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===ht?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(mt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseint_or_param())!==a&&peg$parse__()!==a?(n=zt,(s=peg$parseCOMMA())!==a&&(o=peg$parse__())!==a&&(i=peg$parseint_or_param())!==a?n=s=[s,o,i]:(zt=n,n=a),n===a&&(n=null),n!==a?(c=[r],(p=n)?c.push(p[2]):c.unshift({type:"number",value:0}),t=c):(zt=t,t=a)):(zt=t,t=a);var p,c;return t}())===a&&(c=null),c!==a?t={type:"select",distinct:r,columns:n,from:s,where:o,groupby:i,orderby:p,limit:c}:(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(t=zt,r=zt,40===e.charCodeAt(zt)?(n=o,zt++):(n=a,0===Jt&&peg$fail(i)),n!==a&&(s=peg$parse__())!==a&&(u=peg$parseselect_stmt())!==a&&(d=peg$parse__())!==a?(41===e.charCodeAt(zt)?(l=p,zt++):(l=a,0===Jt&&peg$fail(c)),l!==a?r=n=[n,s,u,d,l]:(zt=r,r=a)):(zt=r,r=a),r!==a&&(r=r[2]),t=r),t}function peg$parsecolumn_clause(){var t,r,n,s,o,i,p,c;if(Jt++,t=zt,(r=function(){var t,r,n,s;t=zt,"all"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(yt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="ALL":(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(r=zt,(n=function(){var t;42===e.charCodeAt(zt)?(t=M,zt++):(t=a,0===Jt&&peg$fail(C));return t}())!==a?(s=zt,Jt++,o=peg$parseident_start(),Jt--,o===a?s=void 0:(zt=s,s=a),s!==a?r=n=[n,s]:(zt=r,r=a)):(zt=r,r=a)),r!==a&&(r="*"),(t=r)===a)if(t=zt,(r=peg$parsecolumn_list_item())!==a){for(n=[],s=zt,(o=peg$parse__())!==a&&(i=peg$parseCOMMA())!==a&&(p=peg$parse__())!==a&&(c=peg$parsecolumn_list_item())!==a?s=o=[o,i,p,c]:(zt=s,s=a);s!==a;)n.push(s),s=zt,(o=peg$parse__())!==a&&(i=peg$parseCOMMA())!==a&&(p=peg$parse__())!==a&&(c=peg$parsecolumn_list_item())!==a?s=o=[o,i,p,c]:(zt=s,s=a);n!==a?t=r=peg$c28(r,n):(zt=t,t=a)}else zt=t,t=a;return Jt--,t===a&&(r=a,0===Jt&&peg$fail(m)),t}function peg$parsecolumn_list_item(){var e,t,r;return e=zt,(t=peg$parseadditive_expr())!==a&&peg$parse__()!==a?((r=function(){var e,t,r;e=zt,(t=peg$parseKW_AS())===a&&(t=null);t!==a&&peg$parse__()!==a&&(r=peg$parseident())!==a?e=t=r:(zt=e,e=a);return e}())===a&&(r=null),r!==a?e=t={expr:t,as:r}:(zt=e,e=a)):(zt=e,e=a),e}function peg$parsefrom_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===ze?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(He));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=function(){var e,t,r,n;if(e=zt,(t=peg$parsetable_base())!==a){for(r=[],n=peg$parsetable_ref();n!==a;)r.push(n),n=peg$parsetable_ref();r!==a?(s=t,(o=r).unshift(s),e=t=o):(zt=e,e=a)}else zt=e,e=a;var s,o;return e}())!==a?t=r:(zt=t,t=a),t}function peg$parsetable_ref(){var e,t,r;return e=zt,peg$parse__()!==a&&(t=peg$parseCOMMA())!==a&&peg$parse__()!==a&&(r=peg$parsetable_base())!==a?e=r:(zt=e,e=a),e===a&&(e=zt,peg$parse__()!==a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsejoin_op())!==a&&peg$parse__()!==a&&(r=peg$parsetable_base())!==a&&peg$parse__()!==a?((n=peg$parseon_clause())===a&&(n=null),n!==a?(s=t,i=n,(o=r).join=s,o.on=i,e=t=o):(zt=e,e=a)):(zt=e,e=a);var s,o,i;return e}())!==a?e=t:(zt=e,e=a)),e}function peg$parsetable_base(){var e,t,r,n,s,o;return e=zt,(t=peg$parsetable_name())!==a&&peg$parse__()!==a?((r=peg$parseKW_AS())===a&&(r=null),r!==a&&peg$parse__()!==a?((n=peg$parseident())===a&&(n=null),n!==a?(o=n,e=t="var"==(s=t).type?(s.as=o,s):{db:s.db,table:s.table,as:o}):(zt=e,e=a)):(zt=e,e=a)):(zt=e,e=a),e}function peg$parsejoin_op(){var t,r,n,s;return t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Ze?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Xe));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_JOIN())!==a?t=r="LEFT JOIN":(zt=t,t=a),t===a&&(t=zt,r=zt,(n=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Ye?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(et));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(s=peg$parse__())!==a?r=n=[n,s]:(zt=r,r=a),r===a&&(r=null),r!==a&&(n=peg$parseKW_JOIN())!==a?t=r="INNER JOIN":(zt=t,t=a)),t}function peg$parsetable_name(){var t,r,n,s,o,i,p,c,u,d,l,g;return t=zt,96===e.charCodeAt(zt)?(r=_,zt++):(r=a,0===Jt&&peg$fail(E)),r===a&&(r=null),r!==a&&(n=peg$parseident())!==a?(s=zt,(o=peg$parse__())!==a&&(i=peg$parseDOT())!==a&&(p=peg$parse__())!==a&&(c=peg$parseident_name())!==a?s=o=[o,i,p,c]:(zt=s,s=a),s===a&&(s=null),s!==a?(96===e.charCodeAt(zt)?(o=_,zt++):(o=a,0===Jt&&peg$fail(E)),o===a&&(o=null),o!==a?(l={db:"",table:u=n},(d=s)&&(l.db=u,l.table=d[3]),t=r=l):(zt=t,t=a)):(zt=t,t=a)):(zt=t,t=a),t===a&&(t=zt,(r=peg$parsevar_decl())!==a&&((g=r).db="",g.table=g.name,r=g),t=r),t}function peg$parseon_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,"on"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ve));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a?t=r:(zt=t,t=a),t}function peg$parsewhere_clause(){var t,r;return t=zt,function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===pt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(ct));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a?t=r:(zt=t,t=a),t}function peg$parseorder_by_element(){var t,r,n,s;return t=zt,(r=peg$parseor_expr())!==a&&peg$parse__()!==a?((n=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Et?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(bt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="DESC":(zt=t,t=a)):(zt=t,t=a);return t}())===a&&(n=function(){var t,r,n,s;t=zt,"asc"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(_t));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="ASC":(zt=t,t=a)):(zt=t,t=a);return t}()),n===a&&(n=null),n!==a?(s={expr:r,type:"ASC"},"DESC"==n&&(s.type="DESC"),t=r=s):(zt=t,t=a)):(zt=t,t=a),t}function peg$parseint_or_param(){var e;return(e=function(){var e,t;Jt++,e=zt,(t=peg$parseint())!==a&&(t=function(e){return{type:"number",value:e}}(t));Jt--,(e=t)===a&&(t=a,0===Jt&&peg$fail(ce));return e}())===a&&(e=peg$parseparam()),e}function peg$parseset_item(){var t,r,n,s;return t=zt,(r=peg$parsecolumn_name())!==a&&peg$parse__()!==a?(61===e.charCodeAt(zt)?(n=d,zt++):(n=a,0===Jt&&peg$fail(l)),n!==a&&peg$parse__()!==a&&(s=peg$parseadditive_expr())!==a?t=r={column:r,value:s}:(zt=t,t=a)):(zt=t,t=a),t}function peg$parsevalue_item(){var e,t;return e=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(t=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t:(zt=e,e=a),e}function peg$parseexpr_list(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseor_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseor_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseor_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c51(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseor_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseand_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_OR())!==a&&(i=peg$parse__())!==a&&(p=peg$parseand_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_OR())!==a&&(i=peg$parse__())!==a&&(p=peg$parseand_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseand_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsenot_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_AND())!==a&&(i=peg$parse__())!==a&&(p=peg$parsenot_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseKW_AND())!==a&&(i=peg$parse__())!==a&&(p=peg$parsenot_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsenot_expr(){var t,r,n,s,o;return t=zt,(r=peg$parseKW_NOT())===a&&(r=zt,33===e.charCodeAt(zt)?(n="!",zt++):(n=a,0===Jt&&peg$fail(b)),n!==a?(s=zt,Jt++,61===e.charCodeAt(zt)?(o=d,zt++):(o=a,0===Jt&&peg$fail(l)),Jt--,o===a?s=void 0:(zt=s,s=a),s!==a?r=n=[n,s]:(zt=r,r=a)):(zt=r,r=a)),r!==a&&(n=peg$parse__())!==a&&(s=peg$parsenot_expr())!==a?t=r={type:"unary_expr",operator:"NOT",expr:s}:(zt=t,t=a),t===a&&(t=peg$parsecomparison_expr()),t}function peg$parsecomparison_expr(){var t,r,n;return t=zt,(r=peg$parseadditive_expr())!==a&&peg$parse__()!==a?((n=function(){var t;(t=function(){var e,t,r,n,s,o;zt,e=[],t=zt,(r=peg$parse__())!==a&&(n=peg$parsearithmetic_comparison_operator())!==a&&(s=peg$parse__())!==a&&(o=peg$parseadditive_expr())!==a?t=r=[r,n,s,o]:(zt=t,t=a);if(t!==a)for(;t!==a;)e.push(t),t=zt,(r=peg$parse__())!==a&&(n=peg$parsearithmetic_comparison_operator())!==a&&(s=peg$parse__())!==a&&(o=peg$parseadditive_expr())!==a?t=r=[r,n,s,o]:(zt=t,t=a);else e=a;e!==a&&(e={type:"arithmetic",tail:e});return e}())===a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsein_op())!==a&&peg$parse__()!==a&&(r=peg$parseLPAREN())!==a&&peg$parse__()!==a&&(n=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=peg$c75(t,n):(zt=e,e=a);e===a&&(e=zt,(t=peg$parsein_op())!==a&&peg$parse__()!==a&&(r=peg$parsevar_decl())!==a?e=t=peg$c76(t,r):(zt=e,e=a));return e}())===a&&(t=function(){var t,r,n,s;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,7).toLowerCase()===Tt?(r=e.substr(zt,7),zt+=7):(r=a,0===Jt&&peg$fail($t));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="BETWEEN":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a&&peg$parse__()!==a&&peg$parseKW_AND()!==a&&peg$parse__()!==a&&(s=peg$parseadditive_expr())!==a?t=r={op:r,right:{type:"expr_list",value:[n,s]}}:(zt=t,t=a);return t}())===a&&(t=function(){var t,r,n;t=zt,(r=function(){var t,r,n,s;t=zt,"is"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(St));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="IS":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a?t=r=peg$c72(r,n):(zt=t,t=a);return t}())===a&&(t=function(){var e,t,r;e=zt,(t=function(){var e,t,r,n,s;e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_LIKE())!==a?t=r=[r,n,s]:(zt=t,t=a);t!==a&&(t=peg$c74(t));(e=t)===a&&(e=peg$parseKW_LIKE());return e}())!==a&&peg$parse__()!==a&&(r=peg$parsecomparison_expr())!==a?e=t=peg$c72(t,r):(zt=e,e=a);return e}())===a&&(t=function(){var e,t,r,n;e=zt,(t=peg$parsecontains_op())!==a&&peg$parse__()!==a&&(r=peg$parseLPAREN())!==a&&peg$parse__()!==a&&(n=peg$parseexpr_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=peg$c75(t,n):(zt=e,e=a);e===a&&(e=zt,(t=peg$parsecontains_op())!==a&&peg$parse__()!==a&&(r=peg$parsevar_decl())!==a?e=t=peg$c76(t,r):(zt=e,e=a));return e}());return t}())===a&&(n=null),n!==a?t=r=function(e,t){if(t)return"arithmetic"==t.type?createBinaryExprChain(e,t.tail):createBinaryExpr(t.op,e,t.right);return e}(r,n):(zt=t,t=a)):(zt=t,t=a),t}function peg$parsearithmetic_comparison_operator(){var t;return">="===e.substr(zt,2)?(t=">=",zt+=2):(t=a,0===Jt&&peg$fail(y)),t===a&&(62===e.charCodeAt(zt)?(t=">",zt++):(t=a,0===Jt&&peg$fail(v)),t===a&&("<="===e.substr(zt,2)?(t="<=",zt+=2):(t=a,0===Jt&&peg$fail(T)),t===a&&("<>"===e.substr(zt,2)?(t="<>",zt+=2):(t=a,0===Jt&&peg$fail($)),t===a&&(60===e.charCodeAt(zt)?(t="<",zt++):(t=a,0===Jt&&peg$fail(x)),t===a&&(61===e.charCodeAt(zt)?(t=d,zt++):(t=a,0===Jt&&peg$fail(l)),t===a&&("!="===e.substr(zt,2)?(t="!=",zt+=2):(t=a,0===Jt&&peg$fail(S)))))))),t}function peg$parsein_op(){var e,t,r,n,s;return e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_IN())!==a?t=r=[r,n,s]:(zt=t,t=a),t!==a&&(t=peg$c74(t)),(e=t)===a&&(e=peg$parseKW_IN()),e}function peg$parsecontains_op(){var e,t,r,n,s;return e=zt,t=zt,(r=peg$parseKW_NOT())!==a&&(n=peg$parse__())!==a&&(s=peg$parseKW_CONTAINS())!==a?t=r=[r,n,s]:(zt=t,t=a),t!==a&&(t=peg$c74(t)),(e=t)===a&&(e=peg$parseKW_CONTAINS()),e}function peg$parseadditive_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parsemultiplicative_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parsemultiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parsemultiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseadditive_operator(){var t;return 43===e.charCodeAt(zt)?(t="+",zt++):(t=a,0===Jt&&peg$fail(R)),t===a&&(45===e.charCodeAt(zt)?(t="-",zt++):(t=a,0===Jt&&peg$fail(A))),t}function peg$parsemultiplicative_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseprimary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseprimary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseprimary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=createBinaryExprChain(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsemultiplicative_operator(){var t;return 42===e.charCodeAt(zt)?(t=M,zt++):(t=a,0===Jt&&peg$fail(C)),t===a&&(47===e.charCodeAt(zt)?(t="/",zt++):(t=a,0===Jt&&peg$fail(O)),t===a&&(37===e.charCodeAt(zt)?(t="%",zt++):(t=a,0===Jt&&peg$fail(w)))),t}function peg$parseprimary(){var t,r;return(t=peg$parseliteral())===a&&(t=function(){var t;(t=function(){var t,r,n;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===wt?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Nt));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="COUNT":(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(n=function(){var t,r,n;t=zt,(r=function(){var t;zt,42===e.charCodeAt(zt)?(t=M,zt++):(t=a,0===Jt&&peg$fail(C));t!==a&&(t={type:"star",value:"*"});return t}())!==a&&(r={expr:r});(t=r)===a&&(t=zt,(r=peg$parseKW_DISTINCT())===a&&(r=null),r!==a&&peg$parse__()!==a&&(n=peg$parsecolumn_ref())!==a?t=r={distinct:r,expr:n}:(zt=t,t=a));return t}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=r=function(e,t){return{type:"aggr_func",name:e,args:t}}(r,n):(zt=t,t=a);return t}())===a&&(t=function(){var t,r,n;t=zt,(r=function(){var t,r;zt,t=[],U.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(z));if(r!==a)for(;r!==a;)t.push(r),U.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(z));else t=a;t!==a&&(t=t.join(""));return t}())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(n=peg$parseadditive_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=r=function(e,t){return{type:"aggr_func",name:e,args:{expr:t}}}(r,n):(zt=t,t=a);return t}());return t}())===a&&(t=peg$parsefunc_call())===a&&(t=peg$parsecolumn_ref())===a&&(t=peg$parseparam())===a&&(t=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=peg$parseor_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?t=peg$c88(r):(zt=t,t=a),t===a&&(t=peg$parsevar_decl())),t}function peg$parsecolumn_ref(){var e,t,r;return e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseDOT()!==a&&peg$parse__()!==a&&(r=peg$parsecolumn())!==a?e=t={type:"column_ref",table:t,column:r}:(zt=e,e=a),e===a&&(e=zt,(t=peg$parsecolumn())!==a&&(t=function(e){return{type:"column_ref",table:"",column:e}}(t)),e=t),e}function peg$parseident(){var e,t;return e=zt,(t=peg$parseident_name())!==a&&(peg$c91(t)?a:void 0)!==a?e=t=t:(zt=e,e=a),e}function peg$parsecolumn(){var t,r,n,s;if(t=zt,(r=peg$parsecolumn_name())!==a&&(n=(n=peg$c91(r))?a:void 0)!==a?t=r=r:(zt=t,t=a),t===a)if(t=zt,96===e.charCodeAt(zt)?(r=_,zt++):(r=a,0===Jt&&peg$fail(E)),r!==a){if(n=[],N.test(e.charAt(zt))?(s=e.charAt(zt),zt++):(s=a,0===Jt&&peg$fail(L)),s!==a)for(;s!==a;)n.push(s),N.test(e.charAt(zt))?(s=e.charAt(zt),zt++):(s=a,0===Jt&&peg$fail(L));else n=a;n!==a?(96===e.charCodeAt(zt)?(s=_,zt++):(s=a,0===Jt&&peg$fail(E)),s!==a?t=r=n.join(""):(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;return t}function peg$parsecolumn_name(){var e,t,r,n;if(e=zt,(t=peg$parseident_start())!==a){for(r=[],n=peg$parsecolumn_part();n!==a;)r.push(n),n=peg$parsecolumn_part();r!==a?e=t=peg$c96(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseident_name(){var e,t,r,n;if(e=zt,(t=peg$parseident_start())!==a){for(r=[],n=peg$parseident_part();n!==a;)r.push(n),n=peg$parseident_part();r!==a?e=t=peg$c96(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseident_start(){var t;return I.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(D)),t}function peg$parseident_part(){var t;return P.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(k)),t}function peg$parsecolumn_part(){var t;return W.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(q)),t}function peg$parseparam(){var t,r,n,s,o;return Jt++,t=zt,58===e.charCodeAt(zt)?(r=":",zt++):(r=a,0===Jt&&peg$fail(j)),r!==a&&(n=peg$parseident_name())!==a?t=r=[r,n]:(zt=t,t=a),t===a&&(t=zt,63===e.charCodeAt(zt)?(r="?",zt++):(r=a,0===Jt&&peg$fail(F)),r!==a&&(o={type:"param",value:(s=r).length>1?s[1]:s[0]},Yt.push(o),r=o),t=r),Jt--,t===a&&(r=a,0===Jt&&peg$fail(B)),t}function peg$parsefunc_call(){var e,t,r;return e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=function(){var e,t;return(e=peg$parseexpr_list())===a&&(e=zt,(t="")!==a&&(t={type:"expr_list",value:[]}),e=t),e}())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=function(e,t){return{type:"function",name:e,args:t}}(t,r):(zt=e,e=a),e}function peg$parseliteral(){var t;return(t=function(){var t,r,n,s;zt,t=zt,34===e.charCodeAt(zt)?(r=H,zt++):(r=a,0===Jt&&peg$fail(G));if(r!==a){for(n=[],s=peg$parsedouble_char();s!==a;)n.push(s),s=peg$parsedouble_char();n!==a?(34===e.charCodeAt(zt)?(s=H,zt++):(s=a,0===Jt&&peg$fail(G)),s!==a?t=r=[r,n,s]:(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;if(t===a)if(t=zt,39===e.charCodeAt(zt)?(r=K,zt++):(r=a,0===Jt&&peg$fail(J)),r!==a){for(n=[],s=peg$parsesingle_char();s!==a;)n.push(s),s=peg$parsesingle_char();n!==a?(39===e.charCodeAt(zt)?(s=K,zt++):(s=a,0===Jt&&peg$fail(J)),s!==a?t=r=[r,n,s]:(zt=t,t=a)):(zt=t,t=a)}else zt=t,t=a;t!==a&&(t={type:"string",value:t[1].join("")});return t}())===a&&(t=function(){var e;zt,(e=function(){var e,t,r,n;e=zt,(t=peg$parseint())!==a&&(r=peg$parsefrac())!==a&&(n=peg$parseexp())!==a&&peg$parse__()!==a?e=t=(s=parseFloat(t+r+n))%1!=0?s.toString():s.toString()+".0":(zt=e,e=a);var s;e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parsefrac())!==a&&(n=peg$parse__())!==a?e=t=function(e,t){var r=parseFloat(e+t);return r%1!=0?r.toString():r.toString()+".0"}(t,r):(zt=e,e=a),e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parseexp())!==a&&(n=peg$parse__())!==a?e=t=function(e,t){return parseFloat(e+t).toString()}(t,r):(zt=e,e=a),e===a&&(e=zt,(t=peg$parseint())!==a&&(r=peg$parse__())!==a?e=t=function(e){return parseFloat(e).toString()}(t):(zt=e,e=a))));return e}())!==a&&(e=function(e){return{type:"number",value:e}}(e));return e}())===a&&(t=function(){var t,r;t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===Re?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Ae));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r={type:"bool",value:!0});(t=r)===a&&(t=zt,(r=function(){var t,r,n,s;t=zt,e.substr(zt,5).toLowerCase()===Me?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(Ce));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(r={type:"bool",value:!1}),t=r);return t}())===a&&(t=function(){var t;zt,(t=function(){var t,r,n,s;t=zt,e.substr(zt,4).toLowerCase()===xe?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Se));r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(t={type:"null",value:null});return t}()),t}function peg$parsesingle_char(){var t;return Q.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(V)),t===a&&(t=peg$parseescape_char()),t}function peg$parsedouble_char(){var t;return Z.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(X)),t===a&&(t=peg$parseescape_char()),t}function peg$parseescape_char(){var t,r,n,s,o,i,p,c,u,d;return t=zt,"\\'"===e.substr(zt,2)?(r="\\'",zt+=2):(r=a,0===Jt&&peg$fail(Y)),r!==a&&(r="'"),(t=r)===a&&(t=zt,'\\"'===e.substr(zt,2)?(r='\\"',zt+=2):(r=a,0===Jt&&peg$fail(ee)),r!==a&&(r='"'),(t=r)===a&&(t=zt,"\\\\"===e.substr(zt,2)?(r="\\\\",zt+=2):(r=a,0===Jt&&peg$fail(te)),r!==a&&(r="\\"),(t=r)===a&&(t=zt,"\\/"===e.substr(zt,2)?(r="\\/",zt+=2):(r=a,0===Jt&&peg$fail(re)),r!==a&&(r="/"),(t=r)===a&&(t=zt,"\\b"===e.substr(zt,2)?(r="\\b",zt+=2):(r=a,0===Jt&&peg$fail(ae)),r!==a&&(r="\b"),(t=r)===a&&(t=zt,"\\f"===e.substr(zt,2)?(r="\\f",zt+=2):(r=a,0===Jt&&peg$fail(ne)),r!==a&&(r="\f"),(t=r)===a&&(t=zt,"\\n"===e.substr(zt,2)?(r="\\n",zt+=2):(r=a,0===Jt&&peg$fail(se)),r!==a&&(r="\n"),(t=r)===a&&(t=zt,"\\r"===e.substr(zt,2)?(r="\\r",zt+=2):(r=a,0===Jt&&peg$fail(oe)),r!==a&&(r="\r"),(t=r)===a&&(t=zt,"\\t"===e.substr(zt,2)?(r="\\t",zt+=2):(r=a,0===Jt&&peg$fail(ie)),r!==a&&(r="\t"),(t=r)===a&&(t=zt,"\\u"===e.substr(zt,2)?(r="\\u",zt+=2):(r=a,0===Jt&&peg$fail(pe)),r!==a&&(n=peg$parsehexDigit())!==a&&(s=peg$parsehexDigit())!==a&&(o=peg$parsehexDigit())!==a&&(i=peg$parsehexDigit())!==a?(p=n,c=s,u=o,d=i,t=r=String.fromCharCode(parseInt("0x"+p+c+u+d))):(zt=t,t=a)))))))))),t}function peg$parseint(){var t,r,n,s;return t=zt,(r=peg$parsedigit19())!==a&&(n=peg$parsedigits())!==a?t=r=r+n:(zt=t,t=a),t===a&&(t=peg$parsedigit())===a&&(t=zt,45===e.charCodeAt(zt)?(r="-",zt++):(r=a,0===Jt&&peg$fail(A)),r===a&&(43===e.charCodeAt(zt)?(r="+",zt++):(r=a,0===Jt&&peg$fail(R))),r!==a&&(n=peg$parsedigit19())!==a&&(s=peg$parsedigits())!==a?t=r=function(e,t,r){return"-"+t+r}(0,n,s):(zt=t,t=a),t===a&&(t=zt,45===e.charCodeAt(zt)?(r="-",zt++):(r=a,0===Jt&&peg$fail(A)),r===a&&(43===e.charCodeAt(zt)?(r="+",zt++):(r=a,0===Jt&&peg$fail(R))),r!==a&&(n=peg$parsedigit())!==a?t=r="-"+n:(zt=t,t=a))),t}function peg$parsefrac(){var t,r,n;return t=zt,46===e.charCodeAt(zt)?(r=ue,zt++):(r=a,0===Jt&&peg$fail(de)),r!==a&&(n=peg$parsedigits())!==a?t=r="."+n:(zt=t,t=a),t}function peg$parseexp(){var t,r,n;return t=zt,(r=function(){var t,r,n;t=zt,ye.test(e.charAt(zt))?(r=e.charAt(zt),zt++):(r=a,0===Jt&&peg$fail(ve));r!==a?(Te.test(e.charAt(zt))?(n=e.charAt(zt),zt++):(n=a,0===Jt&&peg$fail($e)),n===a&&(n=null),n!==a?t=r=r+n:(zt=t,t=a)):(zt=t,t=a);return t}())!==a&&(n=peg$parsedigits())!==a?t=r=r+n:(zt=t,t=a),t}function peg$parsedigits(){var e,t;if(zt,e=[],(t=peg$parsedigit())!==a)for(;t!==a;)e.push(t),t=peg$parsedigit();else e=a;return e!==a&&(e=e.join("")),e}function peg$parsedigit(){var t;return Jt++,ge.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(fe)),Jt--,t===a&&0===Jt&&peg$fail(le),t}function peg$parsedigit19(){var t;return Jt++,he.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(me)),Jt--,t===a&&0===Jt&&peg$fail(le),t}function peg$parsehexDigit(){var t;return Jt++,Ee.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(be)),Jt--,t===a&&0===Jt&&peg$fail(_e),t}function peg$parseKW_AS(){var t,r,n,s;return t=zt,"as"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ke)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_JOIN(){var t,r,n,s;return t=zt,"join"===e.substr(zt,4).toLowerCase()?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(tt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_UNION(){var t,r,n,s;return t=zt,"union"===e.substr(zt,5).toLowerCase()?(r=e.substr(zt,5),zt+=5):(r=a,0===Jt&&peg$fail(rt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_BY(){var t,r,n,s;return t=zt,"by"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(lt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r=[r,n]:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_DISTINCT(){var t,r,n,s;return t=zt,"distinct"===e.substr(zt,8).toLowerCase()?(r=e.substr(zt,8),zt+=8):(r=a,0===Jt&&peg$fail(vt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="DISTINCT":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_IN(){var t,r,n,s;return t=zt,"in"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(xt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="IN":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_LIKE(){var t,r,n,s;return t=zt,"like"===e.substr(zt,4).toLowerCase()?(r=e.substr(zt,4),zt+=4):(r=a,0===Jt&&peg$fail(Rt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="LIKE":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_CONTAINS(){var t,r,n,s;return t=zt,"contains"===e.substr(zt,8).toLowerCase()?(r=e.substr(zt,8),zt+=8):(r=a,0===Jt&&peg$fail(At)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="CONTAINS":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_NOT(){var t,r,n,s;return t=zt,"not"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Mt)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="NOT":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_AND(){var t,r,n,s;return t=zt,"and"===e.substr(zt,3).toLowerCase()?(r=e.substr(zt,3),zt+=3):(r=a,0===Jt&&peg$fail(Ct)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="AND":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseKW_OR(){var t,r,n,s;return t=zt,"or"===e.substr(zt,2).toLowerCase()?(r=e.substr(zt,2),zt+=2):(r=a,0===Jt&&peg$fail(Ot)),r!==a?(n=zt,Jt++,s=peg$parseident_start(),Jt--,s===a?n=void 0:(zt=n,n=a),n!==a?t=r="OR":(zt=t,t=a)):(zt=t,t=a),t}function peg$parseDOT(){var t;return 46===e.charCodeAt(zt)?(t=ue,zt++):(t=a,0===Jt&&peg$fail(de)),t}function peg$parseCOMMA(){var t;return 44===e.charCodeAt(zt)?(t=",",zt++):(t=a,0===Jt&&peg$fail(Lt)),t}function peg$parseLPAREN(){var t;return 40===e.charCodeAt(zt)?(t=o,zt++):(t=a,0===Jt&&peg$fail(i)),t}function peg$parseRPAREN(){var t;return 41===e.charCodeAt(zt)?(t=p,zt++):(t=a,0===Jt&&peg$fail(c)),t}function peg$parse__(){var e,t;for(e=[],t=peg$parsewhitespace();t!==a;)e.push(t),t=peg$parsewhitespace();return e}function peg$parsewhitespace(){var t;return Jt++,kt.test(e.charAt(zt))?(t=e.charAt(zt),zt++):(t=a,0===Jt&&peg$fail(Wt)),Jt--,t===a&&0===Jt&&peg$fail(Pt),t}function peg$parseproc_stmt(){var t,r,n,s;return t=zt,r=zt,Jt++,n=function(){var e;zt,(e="")!==a&&(er=[],e=!0);return e}(),Jt--,n!==a?(zt=r,r=void 0):r=a,r!==a&&(n=peg$parse__())!==a?((s=function(){var t,r,n;t=zt,(r=peg$parsevar_decl())!==a&&peg$parse__()!==a&&function(){var t;e.substr(zt,2)===Ft?(t=Ft,zt+=2):(t=a,0===Jt&&peg$fail(Ut));return t}()!==a&&peg$parse__()!==a&&(n=peg$parseproc_expr())!==a?t=r={type:"assign",left:r,right:n}:(zt=t,t=a);return t}())===a&&(s=function(){var t,r;t=zt,function(){var t;e.substr(zt,6).toLowerCase()===Bt?(t=e.substr(zt,6),zt+=6):(t=a,0===Jt&&peg$fail(jt));return t}()!==a&&peg$parse__()!==a&&(r=peg$parseproc_expr())!==a?t={type:"return",expr:r}:(zt=t,t=a);return t}()),s!==a?t=r={stmt:s,vars:er}:(zt=t,t=a)):(zt=t,t=a),t}function peg$parseproc_expr(){var t;return(t=peg$parseselect_stmt())===a&&(t=function(){var e,t,r,n,s;e=zt,(t=peg$parsevar_decl())!==a&&peg$parse__()!==a&&(r=peg$parsejoin_op())!==a&&peg$parse__()!==a&&(n=peg$parsevar_decl())!==a&&peg$parse__()!==a&&(s=peg$parseon_clause())!==a?e=t={type:"join",ltable:t,rtable:n,op:r,on:s}:(zt=e,e=a);return e}())===a&&(t=peg$parseproc_additive_expr())===a&&(t=function(){var t,r;t=zt,function(){var t;return 91===e.charCodeAt(zt)?(t="[",zt++):(t=a,0===Jt&&peg$fail(It)),t}()!==a&&peg$parse__()!==a&&(r=peg$parseproc_primary_list())!==a&&peg$parse__()!==a&&function(){var t;return 93===e.charCodeAt(zt)?(t="]",zt++):(t=a,0===Jt&&peg$fail(Dt)),t}()!==a?t={type:"array",value:r}:(zt=t,t=a);return t}()),t}function peg$parseproc_additive_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_multiplicative_expr())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_multiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseadditive_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_multiplicative_expr())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseproc_multiplicative_expr(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_primary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parsemultiplicative_operator())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c54(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parseproc_primary(){var e,t;return(e=peg$parseliteral())===a&&(e=peg$parsevar_decl())===a&&(e=function(){var e,t,r;e=zt,(t=peg$parseident())!==a&&peg$parse__()!==a&&peg$parseLPAREN()!==a&&peg$parse__()!==a&&(r=peg$parseproc_primary_list())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=t=function(e,t){return{type:"function",name:e,args:{type:"expr_list",value:t}}}(t,r):(zt=e,e=a);return e}())===a&&(e=peg$parseparam())===a&&(e=zt,peg$parseLPAREN()!==a&&peg$parse__()!==a&&(t=peg$parseproc_additive_expr())!==a&&peg$parse__()!==a&&peg$parseRPAREN()!==a?e=peg$c88(t):(zt=e,e=a)),e}function peg$parseproc_primary_list(){var e,t,r,n,s,o,i,p;if(e=zt,(t=peg$parseproc_primary())!==a){for(r=[],n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);n!==a;)r.push(n),n=zt,(s=peg$parse__())!==a&&(o=peg$parseCOMMA())!==a&&(i=peg$parse__())!==a&&(p=peg$parseproc_primary())!==a?n=s=[s,o,i,p]:(zt=n,n=a);r!==a?e=t=peg$c28(t,r):(zt=e,e=a)}else zt=e,e=a;return e}function peg$parsevar_decl(){var t,r,n;return t=zt,function(){var t;36===e.charCodeAt(zt)?(t="$",zt++):(t=a,0===Jt&&peg$fail(qt));return t}()!==a&&(r=peg$parseident_name())!==a&&(n=function(){var t,r,n,s;zt,t=[],r=zt,46===e.charCodeAt(zt)?(n=ue,zt++):(n=a,0===Jt&&peg$fail(de));n!==a&&(s=peg$parseident_name())!==a?r=n=[n,s]:(zt=r,r=a);for(;r!==a;)t.push(r),r=zt,46===e.charCodeAt(zt)?(n=ue,zt++):(n=a,0===Jt&&peg$fail(de)),n!==a&&(s=peg$parseident_name())!==a?r=n=[n,s]:(zt=r,r=a);t!==a&&(t=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r][1]);return t}(t));return t}())!==a?t=function(e,t){return er.push(e),{type:"var",name:e,members:t}}(r,n):(zt=t,t=a),t}function createBinaryExpr(e,t,r){return{type:"binary_expr",operator:e,left:t,right:r}}function createList(e,t){for(var r=[e],a=0;a<t.length;a++)r.push(t[a][3]);return r}function createBinaryExprChain(e,t){for(var r=e,a=0;a<t.length;a++)r=createBinaryExpr(t[a][1],r,t[a][3]);return r}var Qt,Vt,Zt,Xt={SHOW:!0,DROP:!0,SELECT:!0,UPDATE:!0,CREATE:!0,DELETE:!0,INSERT:!0,REPLACE:!0,EXPLAIN:!0,ALL:!0,DISTINCT:!0,AS:!0,TABLE:!0,INTO:!0,FROM:!0,SET:!0,LEFT:!0,ON:!0,INNER:!0,JOIN:!0,UNION:!0,VALUES:!0,EXISTS:!0,WHERE:!0,GROUP:!0,BY:!0,HAVING:!0,ORDER:!0,ASC:!0,DESC:!0,LIMIT:!0,BETWEEN:!0,IN:!0,IS:!0,LIKE:!0,CONTAINS:!0,NOT:!0,AND:!0,OR:!0,TRUE:!0,FALSE:!0,NULL:!0},Yt=[],er=[];if((r=s())!==a&&zt===e.length)return r;throw r!==a&&zt<e.length&&peg$fail({type:"end"}),Qt=Kt,Vt=Gt<e.length?e.charAt(Gt):null,Zt=Gt<e.length?peg$computeLocation(Gt,Gt+1):peg$computeLocation(Gt,Gt),new peg$SyntaxError(peg$SyntaxError.buildMessage(Qt,Vt),Qt,Vt,Zt)}};const{parse:_t}=mt;var sql_parseQueryArgs=function(e,t){const r=void 0===t&&e instanceof Function;return{params:r?[]:e,callback:r?e:t}},sql_wrapSqlQuery=function(e,r,a,n,s){let o;try{let i={};try{let t=e.split("`").join("");t.endsWith(";")&&(t=t.substr(0,t.length-1)),i=_t(t)}catch(e){i.type="SQL-Command"}const{type:p}=i;let{tables:c}=i;c||(c=i.from.map(e=>e.table));const{database:u,host:d}=n;let l="sql";d.match(".rds.")&&(l="rds"),d.match(".redshift.")&&(l="redshift");const g=new T.Resource([u,l,p]),f=Date.now(),h=new T.Event(["dbapi-"+t(),S.createTimestampFromTime(f),null,s,0,v.ErrorCode.OK]);h.setResource(g),U.addToMetadata(h,{Host:d,Driver:s,Type:p,"Table Name":1===c.length?c[0]:c},{Query:e.substring(0,2048)}),r&&r.length&&U.addToMetadata(h,{},{Params:r.slice(0,5)});const m=new Promise(e=>{o=(t,r,n)=>{if(S.debugLog("SQL Patched callback was called"),h.setDuration(S.createDurationTimestamp(f)),t)U.setException(h,t);else{let{rowCount:e,rows:t}=r;!e&&r instanceof Array&&(e=r.length,t=r),U.addToMetadata(h,{rowCount:e});const a=F.getConfig().ignoredDBTables;e&&t instanceof Array&&t.length&&!c.some(e=>le.doesContainIgnoredKey(a,e))&&(t.length>100&&U.addToMetadata(h,{is_trimmed:!0}),U.addToMetadata(h,{"sql.rows":t.slice(0,100)}))}e(),a&&a(t,r,n)}});le.addEvent(h,m)}catch(e){le.addException(e)}return o||a};const Et=process.env.EPSAGON_PG_PATH?`${process.cwd()}${process.env.EPSAGON_PG_PATH}`:"pg";function pgClientWrapper(e){return function(t,r,a){if(t&&t.submit)return e.apply(this,[t,r,a]);const n=sql_parseQueryArgs(r,a);let{params:s}=n;const{callback:o}=n;let i=t,p=s;t&&t.text&&(i=t.text,t.values&&s&&!s.length&&(s=void 0,p=t.values));let c=sql_wrapSqlQuery(i,p,o,this.connectionParameters||this._clients[0],"pg");if(o)return e.apply(this,[t,s,c]);c=c||(()=>{});const u=e.apply(this,[t,s]);return u&&"function"==typeof u.then||c(null,null,null),u.then(e=>(c(null,e,null),e),e=>{throw c(e,null,null),e})}}var bt={init(){process.env.EPSAGON_PG_PATH&&(S.debugLog("EPSAGON_PG_PATH="+process.env.EPSAGON_PG_PATH),S.debugLog("cwd="+process.cwd())),We.patchModule(Et,"query",pgClientWrapper,e=>e.Client.prototype),We.patchModule("pg-pool","query",pgClientWrapper,e=>e.prototype)}};function mysqlQueryWrapper(e){return function(t,r,a){let n,s,o,i=!1;n="string"!=typeof t?t.sql:t,t.onResult?(o=t.values,s=t.onResult):({params:o,callback:s}=sql_parseQueryArgs(r,a)),void 0===s&&t._callback&&(s=t._callback,i=!0);const p=sql_wrapSqlQuery(n,o,s,this.config,"mysql");return t.onResult?t.onResult=p:s=p,i&&(t._callback=p),e.apply(this,[t,o,s])}}var yt={init(){We.patchModule("mysql2","query",mysqlQueryWrapper,e=>e.Connection.prototype),We.patchModule("mysql2","execute",mysqlQueryWrapper,e=>e.Connection.prototype),We.patchModule("mysql/lib/Connection.js","query",mysqlQueryWrapper,e=>e.prototype)}};function openWhiskWrapper$1(e){return function(r,a){const{name:n}=r,s=`/${process.env.__OW_NAMESPACE}/${n||r}`,o=new T.Resource([s,"openwhisk_action","invoke"]),i=Date.now(),p=new T.Event(["openwhisk-"+t(),S.createTimestampFromTime(i),null,"openwhisk",0,v.ErrorCode.OK]);let c,u;if(p.setResource(o),U.addToMetadata(p,{api_host:r.apihost||process.env.__OW_API_HOST,namespace:r.namespace||process.env.__OW_NAMESPACE},{params:r.params}),r.result){const t={...r,result:!1};c=e.apply(this,[t,a]),u=c.then(e=>e.response.result)}else c=e.apply(this,[r,a]),u=c;const d=new Promise(e=>{c.then(e=>{let t=e.response;t&&t.result&&t.result.body&&t.result.body.length>100&&(t=Object.assign({},t),t.result=Object.assign({},t.result),t.result.body=t.result.body.substring(0,100)+"...(truncated)");const r={activation_id:t.result&&t.result.headers&&t.result.headers["x-last-activation-id"]||e.activationId,status:t.status,result_statusCode:t.result&&t.result.statusCode};U.addToMetadata(p,r,{response:t}),p.setDuration(S.createDurationTimestamp(i))}).catch(e=>{U.setException(p,e)}).finally(()=>{e()})});return le.addEvent(p,d),u}}var vt={init(){We.patchModule("openwhisk/lib/actions.js","invoke",openWhiskWrapper$1,e=>e.prototype)}};const Tt="{{projectId}}",$t={type:"pubsub",origin:"google_cloud/pubsub"};function bigQueryWrapper(e){return function(r,a,n){if(-1===r.uri.indexOf("bigquery"))return e.apply(this,[r,a,n]);const s=r.uri.split("googleapis.com/")[1]||"",o=s.split("/"),i=o[0]||"google-cloud",p=o[3]||"Unknown",c=s.split(p+"/")[1].split("/")[0]||"Unknown",u=new T.Resource([p,i,c]),d=Date.now();let l=`${i}-${t()}`,g={};void 0!==r.json?(r.json.jobReference&&(l=r.json.jobReference.jobId),g=r.json):void 0!==r.uri&&(l=r.uri.split("/")[8]);const f=new T.Event([l,S.createTimestampFromTime(d),null,i,0,v.ErrorCode.OK]);let h;f.setResource(u),U.addToMetadata(f,{},g);const m=new Promise(e=>{h=(t,r,a)=>{f.setDuration(S.createDurationTimestamp(d)),U.addToMetadata(f,{},a.body),e(),n(t,r,a)}}).catch(e=>{le.addException(e)});return le.addEvent(f,m),e.apply(this,[r,a,h])}}const getMessageData=(e,t)=>{if(Array.isArray(e)&&e.length>t&&e[t].data)try{const r=JSON.parse(""+e[t].data);if("object"==typeof r)return r}catch(e){return null}return null},handlePublishMethod=(e,t)=>{const r=(e=>{const t=e&&e.messageIds?e.messageIds:e;return Array.isArray(t)?t:null})(e);if(r){const e=t.reqOpts&&t.reqOpts.messages;return{messages:r.reduce((t,r,a)=>{let n={id:r};const s=getMessageData(e,a);return s&&(n=Object.assign(n,s)),t.push(n),t},[]),messageIdsArray:r}}return{}},getMessagesFromResponse=e=>{if(e&&e.receivedMessages){const t=[];return{messages:e.receivedMessages.reduce((e,r)=>{const{messageId:a}=r.message;t.push(a);let n={messageId:a};const s=r.message.data&&JSON.parse(""+r.message.data);return s&&"object"==typeof s&&(n=Object.assign(n,s)),e.push(n),e},[]),messageIdsArray:t}}return{}};function wrapPubSubRequestFunction(e){return function(t,r){let a=r;try{const e=this.projectId,{slsEvent:n,startTime:s}=U.initializeEvent($t.type,e,t.method,$t.origin),o=this,i=new Promise(i=>{a=(a,p,...c)=>{e&&e!==Tt||!o.projectId||n.getResource().setName(o.projectId);const u={},d={};switch(p&&t.method){case"publish":{const{messages:e,messageIdsArray:r}=handlePublishMethod(p,t);r&&(u.messageIds=r,r.length&&n.setId(r[0])),e&&(d.messages=e);break}case"createSubscription":u.subscription=p;break;case"deleteSubscription":t.reqOpts&&t.reqOpts.subscription&&(u.subscription=S.getLastSplittedItem(t.reqOpts.subscription,"/"));break;case"createTopic":u.topic=p;break;case"deleteTopic":t.reqOpts&&t.reqOpts.topic&&(u.topic=S.getLastSplittedItem(t.reqOpts.topic,"/"))}U.finalizeEvent(n,s,a,u,d),i(),r&&r(a,p,...c)}});le.addEvent(n,i)}catch(e){le.addException(e)}return e.apply(this,[t,a])}}function wrapPubSubPullFunction(e){return function(t,r,a){let n;try{let s;if(t&&t.subscription){const e=t.subscription.split("/");e.length>1&&([,s]=e)}const{slsEvent:o,startTime:i}=U.initializeEvent($t.type,s,"Pull",$t.origin),patchedCallback=(e,t,r)=>{const n={},s={},{messages:p,messageIdsArray:c}=getMessagesFromResponse(t);c&&(n.messageIds=c,c.length&&o.setId(c[0])),p&&(s.receivedMessages=p),U.finalizeEvent(o,i,e,n,s),r&&r(),a&&a(e,t)};if(a){let n=a;const s=new Promise(e=>{n=(t,r)=>{patchedCallback(t,r,e)}});return le.addEvent(o,s),e.apply(this,[t,r,n])}n=e.apply(this,[t,r,a]).then(e=>{const[t]=e;return patchedCallback(null,t),e},e=>{throw patchedCallback(e,null),e}),le.addEvent(o,n)}catch(s){le.addException(s),n||(n=e.apply(this,[t,r,a]))}return n}}var xt={init(){We.patchModule("@google-cloud/common/","makeRequest",bigQueryWrapper,e=>e.util),We.patchModule("@google-cloud/pubsub/","request",wrapPubSubRequestFunction,e=>e.PubSub.prototype),We.patchModule("@google-cloud/pubsub/","pull",wrapPubSubPullFunction,e=>e.v1.SubscriberClient.prototype)}},St=getMessageData,Rt=handlePublishMethod,At=getMessagesFromResponse;function redisClientWrapper(e){return function(r){try{if(!1===this.ready||!1===this.stream.writable)return e.apply(this,[r]);const{callback:a}=r,n=this.connection_options.host||"local",s=new T.Resource([this.connection_options.host||"local","redis",r.command]),o=Date.now(),i=new T.Event(["redis-"+t(),S.createTimestampFromTime(o),null,"redis",0,v.ErrorCode.OK]);i.setResource(s),U.addToMetadata(i,{"Redis Host":n,"Redis Port":this.connection_options.port,"Redis DB Index":this.connection_options.db||"0"},{"Command Arguments":r.args});const p=new Promise(e=>{r.callback=(t,r)=>{i.setDuration(S.createDurationTimestamp(o)),t&&U.setException(i,t),e(),a&&a(t,r)}});le.addEvent(i,p)}catch(e){le.addException(e)}return e.apply(this,[r])}}xt.getMessageData=St,xt.handlePublishMethod=Rt,xt.getMessagesFromResponse=At;var Mt={init(){We.patchModule("redis","internal_send_command",redisClientWrapper,e=>e.RedisClient.prototype)}};function redisClientWrapper$1(e){return function(r,a){try{if("ready"!==this.status)return e.apply(this,[r,a]);const n=this.options.host||"local",s=new T.Resource([n,"redis",r.name]),o=Date.now(),i=new T.Event(["ioredis-"+t(),S.createTimestampFromTime(o),null,"redis",0,v.ErrorCode.OK]);i.setResource(s);const p=Array.isArray(r.args)?r.args:[];U.addToMetadata(i,{"Redis Host":n,"Redis Port":this.options.port,"Redis DB Index":this.options.db||"0"},{"Command Arguments":p.map(e=>e.toString())});const c=new Promise(e=>{r.promise.then(e=>{e&&U.addToMetadata(i,{"redis.response":e.toString()})}).catch(e=>{U.setException(i,e)}).finally(()=>{i.setDuration(S.createDurationTimestamp(o)),e()})});le.addEvent(i,c)}catch(e){le.addException(e)}return e.apply(this,[r,a])}}var Ct={init(){We.patchModule("ioredis","sendCommand",redisClientWrapper$1,e=>e.prototype),We.patchModule("ioredis-move","sendCommand",redisClientWrapper$1,e=>e.prototype),We.patchModule("dy-ioredis/lib/redis.js","sendCommand",redisClientWrapper$1,e=>e.prototype)}};function getCommandMetadata(e){const t={};if(!e||"object"!=typeof e&&!Array.isArray(e))return t;let r="",a="";return"object"==typeof e&&(r=JSON.stringify(e.filter),a=JSON.stringify(e.query)),r&&(t.filter=r),a&&(t.query=a),0===Object.keys(t).length&&(t.criteria=JSON.stringify(e)),t}function getHostAndPort(e){let t="27017",r="mongodb";if(e&&e.s&&e.s.options){const{options:a}=e.s;t=a.port?a.port:t,r=a.host?a.host:r}return{port:t,host:r}}function getItemsCount(e,t){let r;switch(e){case"find":r=t.result.cursor.firstBatch.length;break;case"insert":case"update":case"delete":r=t.result.n;break;case"getMore":r=t.cursor.nextBatch.length}return r}function getArgsFromFunction(...e){return{server:e[0],namespace:e[1],cmd:"getMore"===e[e.length-2]?{}:e[2],callback:e[e.length-3],operationName:e[e.length-2],wrappedFunction:e[e.length-1]}}function internalMongodbOperationWrapper(...e){const r=getArgsFromFunction(...e),{server:a,namespace:n,cmd:s,callback:o,operationName:i,wrappedFunction:p}=r;let c=o;try{const e=Date.now(),r=getCommandMetadata(s),{host:p,port:u}=getHostAndPort(a),d=new T.Resource([p,"mongodb",i]),l=new T.Event(["mongodb-"+t(),S.createTimestampFromTime(e),null,"mongodb",0,v.ErrorCode.OK]);l.setResource(d),U.addToMetadata(l,{namespace:n},{...r,port:u});const g=new Promise(t=>{c=(r,a)=>{S.debugLog("MongoDb Patched callback was called."),l.setDuration(S.createDurationTimestamp(e)),r?U.setException(l,r):U.addToMetadata(l,{items_count:getItemsCount(i,a)}),t(),o&&o(r,a)}});le.addEvent(l,g)}catch(e){le.addException(e)}return arguments[e.length-3]=c,p.apply(this,arguments)}function mongodbInsertWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"insert",e)}}function mongodbUpdateWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"update",e)}}function mongodbRemoveWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"delete",e)}}function mongodbGetMoreWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"getMore",e)}}function mongodbQueryWrapper(e){return function(...t){return internalMongodbOperationWrapper(...t,"find",e)}}function mongodbCommandWrapper(e){return function(...t){const r=t[2];return r&&r.ismaster?e.apply(this,t):internalMongodbOperationWrapper(...t,r&&"object"==typeof r?Object.keys(r)[0]:"",e)}}var Ot={init(){We.patchModule("mongodb/lib/core/wireprotocol/index.js","insert",mongodbInsertWrapper,e=>e),We.patchModule("mongodb/lib/core/wireprotocol/index.js","update",mongodbUpdateWrapper,e=>e),We.patchModule("mongodb/lib/core/wireprotocol/index.js","remove",mongodbRemoveWrapper,e=>e),We.patchModule("mongodb/lib/core/wireprotocol/index.js","query",mongodbQueryWrapper,e=>e),We.patchModule("mongodb/lib/core/wireprotocol/index.js","getMore",mongodbGetMoreWrapper,e=>e),We.patchModule("mongodb/lib/core/wireprotocol/index.js","command",mongodbCommandWrapper,e=>e)}};const{isBlacklistURL:wt}=ce,Nt={"tc.epsagon.com":"endsWith"},Lt={resolveAny:"ANY",resolve6:"AAAA",resolve4:"A",resolveCname:"CNAME",resolveMx:"MX",resolveNaptr:"NAPTR",resolveNs:"NS",resolvePtr:"PTR",resolveSoa:"SOA",resolveSrv:"SRV",resolveTxt:"TXT"};function handleFunctionWithoutCallback(e,t,r,a){try{return e.apply(this,a)}catch(e){throw r.setDuration(S.createDurationTimestamp(t)),U.setException(r,e),le.addEvent(r),e}}function wrapDnsResolveFunction(e){return function(t,r,a){let n,s,o;const{hostname:i,rrtype:p,callback:c}=((e,t,r,a)=>{const n=e;let s=Lt.resolve4,o=r;return r&&"object"!=typeof t||(a&&(s=Object.values(Lt).find(e=>a.toLocaleLowerCase().includes(("query"+e).toLocaleLowerCase()))),r||(o=t)),{hostname:n,rrtype:s,callback:o}})(t,r,a,e.name);"object"==typeof r&&(o=r);const{slsEvent:u,startTime:d}=U.initializeEvent("dns",e.name,"dns","dns");if(!c)return handleFunctionWithoutCallback(e,d,u,[t,r,a]);try{const t={};o&&(t.options=o),p&&(t.rrtype=p),U.addToMetadata(u,{hostname:i,...t});const r=new Promise(e=>{n=(t,r)=>{const a=((e,t)=>{if(!e)return;let r;return r=t&&t!==Lt.resolveTxt?t===Lt.resolveAny?{ret:e}:t===Lt.resolveSoa?{address:e}:{addresses:e}:{records:e},r})(r,p);U.finalizeEvent(u,d,t,{...a}),e(),c&&c(t,r)}});s=e.apply(this,[i,p,n]),le.addEvent(u,r)}catch(e){le.addException(e)}return s||(s=e.apply(this,[t,r,a])),s}}var It={init(){if("TRUE"===(process.env.EPSAGON_DNS_INSTRUMENTATION||"").toUpperCase()){const e=Object.keys(b);Object.keys(Lt).forEach(t=>{e.includes(t)&&We.patchSingle(b,t,wrapDnsResolveFunction)}),We.patchSingle(b,"resolve",()=>wrapDnsResolveFunction(b.resolve)),We.patchSingle(b,"reverse",()=>{return e=b.reverse,function(t,r){let a,n;const{slsEvent:s,startTime:o}=U.initializeEvent("dns",e.name,"dns","dns");if(!r)return handleFunctionWithoutCallback(e,o,s,[t,r]);try{U.addToMetadata(s,{ip:t});const i=new Promise(e=>{a=(t,a)=>{U.finalizeEvent(s,o,t,{hostnames:a}),e(),r&&r(t,a)}});n=e.apply(this,[t,a]),le.addEvent(s,i)}catch(e){le.addException(e)}return n||(n=e.apply(this,[t,r])),n};var e}),We.patchSingle(b,"lookup",()=>{return e=b.lookup,function(t,r,a){let n,s;const{hostname:o,options:i,callback:p}=((e,t,r)=>{let a=t,n=r;return r||(a=void 0,n=t),{hostname:e,options:a,callback:n}})(t,r,a);if(wt(o,Nt))return S.debugLog("filtered blacklist hostname "+o),e.apply(this,[t,r,a]);const{slsEvent:c,startTime:u}=U.initializeEvent("dns",e.name,"dns","dns");if(!p)return handleFunctionWithoutCallback(e,u,c,[t,r,a]);try{U.addToMetadata(c,{hostname:o}),i&&U.addToMetadata(c,{options:i});const t=new Promise(e=>{n=(t,r,a)=>{U.finalizeEvent(c,u,t,{address:r,family:a}),e(),p&&p(t,r,a)}}),r=[o,n];i&&r.splice(1,0,i),s=e.apply(this,r),le.addEvent(c,t)}catch(e){le.addException(e)}return s||(s=e.apply(this,[t,r,a])),s};var e}),We.patchSingle(b,"lookupService",()=>{return e=b.lookupService,function(t,r,a){let n,s;const{slsEvent:o,startTime:i}=U.initializeEvent("dns",e.name,"dns","dns");if(!a)return handleFunctionWithoutCallback(e,i,o,[t,r,a]);try{U.addToMetadata(o,{address:t,port:r});const p=new Promise(e=>{n=(t,r,n)=>{U.finalizeEvent(o,i,t,{hostname:r,service:n}),e(),a&&a(t,r,n)}});s=e.apply(this,[t,r,n]),le.addEvent(o,p)}catch(e){le.addException(e)}return s||(s=e.apply(this,[t,r,a])),s};var e})}}};const Dt="nats",Pt="Client",kt="unknown",Wt="NATS_BAD_JSON_MSG";function wrapNatsPublishFunction(e,r,a){return function(n,s,o,i){const{subject_internal:p,msg_internal:c,msgJsonStringify:u,opt_reply_internal:d,opt_callback_internal:l,epsagon_id:g}=((e,r,a,n,s)=>{let o,i,p=e,c=r,u=a,d=n;if("function"==typeof p&&(d=p,p=void 0),c=s?void 0===c?null:c:c||"","function"==typeof c&&(d=r,c="",u=void 0),"function"==typeof u&&(d=a,u=void 0),s&&c&&"object"==typeof c&&"TRUE"===(process.env.EPSAGON_PROPAGATE_NATS_ID||"").toUpperCase()&&(i=t(),c.epsagon_id=i),!Buffer.isBuffer(c)&&s)try{o=JSON.stringify(c)}catch(e){o=Wt}return{subject_internal:p,msg_internal:c,msgJsonStringify:o,opt_reply_internal:u,opt_callback_internal:d,epsagon_id:i}})(n,s,o,i,a);let f=l;if(d)return e.apply(this,[n,s,o,i]);try{const{slsEvent:e,startTime:t}=U.initializeEvent(Dt,n,"publish",Dt),s={subject:p},o={};a?u&&u!==Wt&&(o.msg=u):o.msg=c,r&&(s.server_host_name=r),g&&(s.epsagon_id=g);const i=new Promise(r=>{f=()=>{U.finalizeEvent(e,t,null,s,o),r(),l&&l()}});le.addEvent(e,i)}catch(e){le.addException(e)}return e.apply(this,[p,c,d,f])}}function wrapNatsConnectFunction(e){return function(t,r){const a=e.apply(this,[t,r]);try{if(a&&a.constructor&&a.constructor.name===Pt){const e=(n=a.currentServer).url&&n.url.hostname?n.url.hostname:kt,t=a.options?a.options.json:null;f.wrap(a,"publish",()=>wrapNatsPublishFunction(a.publish,e,t))}}catch(e){le.addException(e)}var n;return a}}var qt={init(){We.patchModule("nats","connect",wrapNatsConnectFunction)}};function getPubSubParams(e,t){let r=t,a=e;return"function"==typeof a&&(r=e,a={}),{internalCallback:r,internalOptions:a}}function publishWrapper(e){return function(r,a,n,s){const{internalCallback:o,internalOptions:i}=getPubSubParams(n,s),p=t(),c=function(e,t){if("object"==typeof t)return{...t,epsagonId:e};if("string"==typeof t)try{const r=JSON.parse(t);if(r)return r.epsagonId=e,JSON.stringify(r)}catch(e){}return t}(p,a);let u=o;try{const{slsEvent:e,startTime:t}=U.initializeEvent("mqtt",r,"publish","mqtt"),a={region:this.options.region,protocol:this.options.protocol,host:this.options.host,epsagon_id:p},n={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion,message:c},s=new Promise(r=>{u=(s,...i)=>{U.finalizeEvent(e,t,s||null,a,n),o&&o(s,...i),r()}});le.addEvent(e,s)}catch(e){le.addException(e)}return e.apply(this,[r,c,i,u])}}function onWrapper(e){return function(t,r){let a=r;try{if("message"===t){const e={region:this.options.region,protocol:this.options.protocol,host:this.options.host},t={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion};a=(a,n,...s)=>{const{slsEvent:o,startTime:i}=U.initializeEvent("mqtt",a,"onMessage","mqtt");t.message=n?n.toString():n;const p=function(e){let t=e;if("object"==typeof t&&Buffer.isBuffer(t)&&(t=t.toString()),"string"==typeof t)try{t=JSON.parse(t)}catch(e){}return t.epsagonId}(n);p&&(e.epsagon_id=p),U.finalizeEvent(o,i,null,e,t),r&&r(a,n,...s),le.addEvent(o)}}}catch(e){le.addException(e)}return e.apply(this,[t,a])}}function mqttClientWrapper(e){return function(t,r){const a=e.apply(this,[t,r]);try{f.wrap(a,"publish",e=>publishWrapper(e)),f.wrap(a,"subscribe",e=>{return t=e,function(e,r,a){const{internalCallback:n,internalOptions:s}=getPubSubParams(r,a);let o=n;try{const{slsEvent:t,startTime:r}=U.initializeEvent("mqtt",e,"subscribe","mqtt"),a={region:this.options.region,protocol:this.options.protocol,host:this.options.host},s={clientId:this.options.clientId,protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion},i=new Promise(e=>{o=(o,...i)=>{U.finalizeEvent(t,r,o||null,a,s),n&&n(o,...i),e()}});le.addEvent(t,i)}catch(e){le.addException(e)}return t.apply(this,[e,s,o])};var t}),f.wrap(a,"on",e=>onWrapper(e))}catch(e){le.addException(e)}return a}}var Bt={init(){We.patchModule("mqtt","MqttClient",mqttClientWrapper,e=>e)}};const{EPSAGON_HEADER:jt}=j,{generateEpsagonTraceId:Ft}=ke;function kafkaConnectWrapper(e){return function(...t){let r,a,n,s,o;try{const{host:e,port:t}=this.brokerPool.seedBroker.connection;o=t;const{slsEvent:r,startTime:s}=U.initializeEvent("kafka_server",e,"connect","kafkajs");a=r,n=s}catch(e){le.addException(e)}try{s=e.apply(this,t)}catch(e){throw a&&(a.setException(a,e),le.addEvent(a)),e}return s=s.catch(e=>{throw r=e,e}).finally(()=>{try{if(!a)return void S.debugLog("Could not initialize kafkajs, skipping response.");U.finalizeEvent(a,n,r,{port:o})}catch(e){le.addException(e)}}),a&&le.addEvent(a,s),s}}function kafkaProducerWrapper(e){return function(t){const r=e.apply(this,[t]);if(r&&!r.__epsagonPatched)try{r.__epsagonPatched=!0,f.wrap(r,"send",()=>{return e=r.send,function(t){let r,a,n,s,o;const i=Ft();try{const{slsEvent:e,startTime:n}=U.initializeEvent("kafka",t.topic,"produce","kafkajs");r=e,a=n,t.messages=t.messages.map(e=>(e.headers||(e.headers={}),e.headers[jt]=i,e))}catch(e){le.addException(e)}try{n=e.apply(this,[t])}catch(e){throw r&&(U.setException(r,e),le.addEvent(r)),e}return n=n.then(e=>(o=e,e)).catch(e=>{throw s=e,e}).finally(()=>{try{if(!r)return void S.debugLog("Could not initialize kafkajs, skipping response.");U.finalizeEvent(r,a,s,{messages_count:t.messages.length,[jt]:i},{messages:t,response:o})}catch(e){le.addException(e)}}),r&&le.addEvent(r,n),n};var e})}catch(e){le.addException(e)}return r}}var Ut={init(){We.patchModule("kafkajs","producer",kafkaProducerWrapper,e=>e.Kafka.prototype),We.patchModule("kafkajs/src/cluster/index.js","connect",kafkaConnectWrapper,e=>e.prototype)}};const{EPSAGON_HEADER:zt}=j,{generateEpsagonTraceId:Ht}=ke;function wrapKafkaSendFunction$1(e){return function(t,r){let a,n,s,o;const i=this,p=Ht(),c=t[0];try{const{slsEvent:e,startTime:r}=U.initializeEvent("kafka",c.topic,"produce","kafka-node");a=e,n=r,t=t.map(e=>{try{if("string"==typeof e.messages){const t=JSON.parse(e.messages);t[zt]=p,e.messages=JSON.stringify(t)}else{const t=JSON.parse(e.messages[0]);t[zt]=p,e.messages[0]=JSON.stringify(t)}}catch(e){S.debugLog("kafka-node - Could not extract epsagon header")}return e})}catch(e){le.addException(e)}const u=new Promise(e=>{o=(t,s)=>{let o;try{if(!a)return S.debugLog("Could not initialize kafka-node, skipping response."),o;U.finalizeEvent(a,n,undefined,{[zt]:p,host:i.client.options.kafkaHost},{messages:c.messages})}catch(e){le.addException(e)}finally{r&&"function"==typeof r&&(o=r(t,s))}return e(),o}});try{s=e.apply(this,[t,o])}catch(e){throw a&&(U.setException(a,e),le.addEvent(a)),e}return a&&le.addEvent(a,u),s}}var Gt={init(){We.patchModule("kafka-node","send",wrapKafkaSendFunction$1,e=>e.Producer.prototype)}};function emitWrapper(e){return function(t,...r){if(!le.isLoggingTracingEnabled())return e.apply(this,[t].concat(r));const a=le.getTraceId();if(!a)return e.apply(this,[t].concat(r));const n={epsagon:{trace_id:a}};if(!t)return e.apply(this,[t].concat(r));for(const e in t)n[e]=t[e];for(const e of Object.getOwnPropertySymbols(t))n[e]=t[e];return le.addLoggingTracingEnabledMetadata(),e.apply(this,[n].concat(r))}}var Kt={init(){We.patchModule("bunyan","_emit",emitWrapper,e=>e.prototype)}};function logWrapper(e){return function(t,r,a,n){if(!le.isLoggingTracingEnabled())return e.apply(this,[t,r,a,n]);const s=le.getTraceId();return s?(t.epsagon={trace_id:s},le.addLoggingTracingEnabledMetadata(),e.apply(this,[t,r,a,n])):e.apply(this,[t,r,a,n])}}var Jt={init(){We.patchModule("pino/lib/tools","asJson",logWrapper)}};function blobUploadWrapper(e){return function(t,r){const{accountName:a,containerName:n}=this,{slsEvent:s,startTime:o}=U.initializeEvent("blob_storage",n,"upload","azure-sdk");U.addToMetadata(s,{"azure.blob.account_name":a,"azure.blob.content_size":r},{"azure.blob.content":t});const i=e.apply(this,[t,r]).then(e=>(U.addToMetadata(s,{"azure.blob.error_code":e.errorCode}),s.setDuration(S.createDurationTimestamp(o)),e)).catch(e=>{throw U.setException(s,e),e});return le.addEvent(s,i),i}}function blobDownloadWrapper(e){return function(t,r,a){const{accountName:n,containerName:s}=this,{slsEvent:o,startTime:i}=U.initializeEvent("blob_storage",s,"download","azure-sdk");U.addToMetadata(o,{"azure.blob.account_name":n,"azure.blob.container_name":s,"azure.blob.offset":t});const p=e.apply(this,[t,r,a]).then(e=>(U.addToMetadata(o,{"azure.blob.content_length":e.contentLength}),o.setDuration(S.createDurationTimestamp(i)),e)).catch(e=>{throw U.setException(o,e),e});return le.addEvent(o,p),p}}function cosmosCreateItemWrapper(e){return function(t,r){const{id:a,content:n}=t,{container:s,clientContext:o}=this,{database:i}=s,p=s.id,{slsEvent:c,startTime:u}=U.initializeEvent("cosmos_db",p,"create","azure-sdk");U.addToMetadata(c,{"azure.cosmos.endpoint":o.cosmosClientOptions.endpoint,"azure.cosmos.database_id":i.id,"azure.cosmos.item_id":a},{"azure.cosmos.item_content":n});const d=e.apply(this,[t,r]).then(e=>(U.addToMetadata(c,{"azure.cosmos.status_code":e.statusCode}),c.setDuration(S.createDurationTimestamp(u)),e)).catch(e=>{throw U.setException(c,e),e});return le.addEvent(c,d),d}}var Qt={init(){We.patchModule("@azure/storage-blob","upload",blobUploadWrapper,e=>e.BlockBlobClient.prototype),We.patchModule("@azure/storage-blob","download",blobDownloadWrapper,e=>e.BlockBlobClient.prototype),We.patchModule("@azure/cosmos","create",cosmosCreateItemWrapper,e=>e.Items.prototype)}};function writeWrapper(e){return function(t,r,a){S.debugLog("in internal winston write");const n=function(e){return e&&"object"==typeof e&&le.isLoggingTracingEnabled()?le.getTraceId():null}(t);if(S.debugLog("winston traceId="+n),!n)return e.apply(this,[t,r,a]);const s={epsagon:{trace_id:n}};for(const e in t)s[e]=t[e];for(const e of Object.getOwnPropertySymbols(t))s[e]=t[e];return le.addLoggingTracingEnabledMetadata(),S.debugLog("finish internal winston write"),e.apply(this,[s,r,a])}}var Vt={init(){We.patchModule("winston/lib/winston/logger","write",writeWrapper,e=>e.prototype)}};const{EPSAGON_HEADER:Zt}=j,{generateEpsagonTraceId:Xt}=ke;function amqplibProducerWrapper(e){return function(t,r,a){let n,s,o;const i=Xt();try{const{slsEvent:e,startTime:r}=U.initializeEvent("rabbitmq",t.routingKey,"SendMessage","amqplib");s=e,o=r,t.headers[Zt]=i}catch(e){le.addException(e)}try{n=e.apply(this,[t,r,a])}catch(e){throw s&&(U.setException(s,e),le.addEvent(s)),e}return U.finalizeEvent(s,o,void 0,{exchange:t.exchange,host:this.connection.stream._host,[Zt]:i,"messaging.message_payload_size_bytes":a.toString().length},{headers:t.headers,message:a.toString()}),le.addEvent(s),n}}var Yt={init(){We.patchModule("amqplib/lib/channel.js","sendMessage",amqplibProducerWrapper,e=>e.Channel.prototype)}};const{EPSAGON_HEADER:er}=j,{generateEpsagonTraceId:tr}=ke;function amqpProducerWrapper(e){return function(t,r,a,n){let s,o,i;const p=tr();try{const{slsEvent:e,startTime:r}=U.initializeEvent("rabbitmq",t,"SendMessage","amqplib");o=e,i=r,a&&a.headers||(a.headers={}),a.headers[er]=p}catch(e){le.addException(e)}try{s=e.apply(this,[t,r,a,n])}catch(e){throw o&&(U.setException(o,e),le.addEvent(o)),e}return U.finalizeEvent(o,i,void 0,{exchange:this.name,host:this.connection.options.host,vhost:this.connection.options.vhost,[er]:p,"messaging.message_payload_size_bytes":r.toString().length},{headers:a.headers,message:JSON.stringify(r)}),le.addEvent(o),s}}var rr={init(){We.patchModule("amqp/lib/exchange.js","publish",amqpProducerWrapper,e=>e.prototype)}};function bindWrapper(e){return function(r,a,n,s){let o,i,p;try{const e=r;"function"==typeof n?(o=n,i=[]):"function"==typeof s&&(o=s,i=n),S.debugLog("LDAP.js bind() wrapper - name: "+e);const a=new T.Resource([this.url.hostname,"ldap","bind"]),c=Date.now(),u=new T.Event(["ldap-"+t(),S.createTimestampFromTime(c),null,"ldap",0,v.ErrorCode.OK]);u.setResource(a);const d=S.flatten({enduser:{id:e},ldap:{strict_dn:S.getValueIfExist(this.url,"strictDN")},net:{transport:"IP.TCP",protocol:S.getValueIfExist(this.url,"protocol"),socket_path:S.getValueIfExist(this.url,"socketPath"),timeout:S.getValueIfExist(this.url,"timeout"),connect_timeout:S.getValueIfExist(this.url,"connectTimeout"),tls_options:S.getValueIfExist(this.url,"tlsOptions"),idle_timeout:S.getValueIfExist(this.url,"idleTimeout"),pathname:S.getValueIfExist(this.url,"pathname"),secure:S.getValueIfExist(this.url,"secure"),peer:{address:S.getValueIfExist(this.url,"href"),hostname:S.getValueIfExist(this.url,"hostname"),port:S.getValueIfExist(this.url,"port"),service:"ldap"}}});U.addToMetadata(u,d);const l=new Promise(e=>{p=(t,r)=>{u.setDuration(S.createDurationTimestamp(c)),t&&U.setException(u,t),e(),o&&o(t,r)}});le.addEvent(u,l)}catch(e){le.addException(e)}return e.apply(this,[r,a,i,p])}}var ar={init(){We.patchModule("ldapjs","bind",bindWrapper,e=>e.Client.prototype)}};const{parse:nr}=mt;function cassandraClientWrapper(e){return function(t,r,a,n){let s,o,i,p,c,u="execute";try{const e=nr(t);u=e.type,p=e.from.length&&e.from[0].table}catch(e){S.debugLog("could not extract cassandra operation "+e)}try{const{slsEvent:e,startTime:t}=U.initializeEvent("cassandra",this.options.contactPoints[0],u,"cassandra-driver");o=e,i=t}catch(e){le.addException(e)}this.options.keyspace&&U.addToMetadata(o,{"db.cassandra.keyspace":this.options.keyspace}),this.options.localDataCenter&&U.addToMetadata(o,{"db.cassandra.coordinator.dc":this.options.localDataCenter}),p&&U.addToMetadata(o,{"db.cassandra.table":p});const d=new Promise(e=>{c=(a,s)=>{let p;try{if(!o)return S.debugLog("Could not initialize cassandra, skipping response."),p;U.finalizeEvent(o,i,a,{"db.name":this.options.contactPoints[0],"db.operation":u},{"db.statement":t,"db.cassandra.params":r})}catch(e){le.addException(e)}finally{n&&"function"==typeof n&&(p=n(a,s))}return e(),p}});try{s=e.apply(this,[t,r,a,c])}catch(e){throw o&&(U.setException(o,e),le.addEvent(o)),e}return o&&le.addEvent(o,d),s}}var sr={init(){We.patchModule("cassandra-driver/lib/client","execute",cassandraClientWrapper,e=>e.prototype)}};function tencentCOSWrapper(e){return function(t){const r=e.apply(this,[t]),a=t._addTask;return t._addTask=(e,t,r,n)=>{const{slsEvent:s,startTime:o}=U.initializeEvent("cos",t.Bucket,e,"tencent-cos");U.addToMetadata(s,{"tencent.region":t.Region,"tencent.cos.object_key":t.Key,"tencent.cos.object_path":t.FilePath});let i=r;const p=new Promise(e=>{i=(t,a)=>(s.setDuration(S.createDurationTimestamp(o)),U.addToMetadata(s,{"tencent.cos.request_id":a.headers["x-cos-request-id"],"tencent.status_code":a.statusCode}),t&&U.setException(s,t),e(),r(t,a))});return le.addEvent(s,p),a(e,t,i,n)},r}}var or={init(){We.patchModule("cos-nodejs-sdk-v5/sdk/task.js","init",tencentCOSWrapper)}};function getArgsFromFunction$1(...e){let t={};switch(e[e.length-1]){case"Session":t={query:e[0],params:e[1],transactionConfig:e[2]};break;case"Transaction":t={query:e[0],params:e[1]}}return t}function getPatchedSubscribeMethods(e,t,r,a,n){const s=[];return{...t,onNext:a=>(s.push(a),t.onNext.apply(e,r)),onCompleted(o){switch(o.queryType){case"s":U.addToMetadata(a,{items_count:s.length,operation_executed:"Schema, Write"});break;case"r":U.addToMetadata(a,{items_count:s.length,operation_executed:"Read"});break;case"w":U.addToMetadata(a,{operation_executed:"Write"},{write_stats:o.counters._stats});break;case"rw":U.addToMetadata(a,{items_count:s.length,operation_executed:"Read, Write"},{write_stats:o.counters._stats});break;default:S.debugLog("Unkown query type: "+o.queryType)}return a.setDuration(S.createDurationTimestamp(n)),le.addEvent(a),t.onCompleted.apply(e,r)},onError:n=>(U.setException(a,n),t.onError.apply(e,r))}}function createNewNeo4jEvent(e,r){const{host:a,port:n}=function(e){let t,r="7474",a="neo4j";switch(e.constructor.name){case"Session":t=e._readConnectionHolder;break;case"Transaction":t=e._connectionHolder;break;default:return{host:a,port:r}}if(t&&t._connectionProvider){const e=t._connectionProvider;r=e._address.port(),a=e._address.host()}return{port:r,host:a}}(e),{metadata:s,fullMetadata:o}=function(e){const t={},r={};let a,n,s="";switch(e.constructor.name){case"Session":a=e._readConnectionHolder,n="READ|WRITE";break;case"Transaction":a=e._connectionHolder,n=a._mode;break;default:return}switch(n){case"READ":s="Read";break;case"WRITE":s="Write";break;case"READ|WRITE":s="Read|Write"}return a&&(t.dbName=a._database?a._database:"default",t.operation=`${e.constructor.name}:${s}`,r.config=a._connectionProvider._config),{metadata:t,fullMetadata:r}}(e);s.port=n;const i=new T.Resource([a,"neo4j",s.operation]),p=new T.Event(["neo4j-"+t(),S.createTimestampFromTime(r),null,"neo4j",0,v.ErrorCode.OK]);return p.setResource(i),U.addToMetadata(p,s,o),p}function neo4jSessionRunWrapper(e){return function(...t){const r=getArgsFromFunction$1(...t,this.constructor.name),{query:a,params:n,transactionConfig:s}=r;let o;S.debugLog("User called Neo4j wrapped Session run function");try{const t=Date.now(),r=createNewNeo4jEvent(this,t);U.addToMetadata(r,{},{query:a,param:n,transaction_config:s}),o=e.apply(this,[a,n,s]);const i=o.subscribe;return o.subscribe=function(e){i.call(this,getPatchedSubscribeMethods(this,e,arguments,r,t))},o}catch(e){return le.addException(e),o}}}function neo4jTransactionRunWrapper(e){return function(...t){const r=getArgsFromFunction$1(...t,this.constructor.name),{query:a,params:n}=r;let s;S.debugLog("User called Neo4j wrapped Transaction run function");try{const t=Date.now(),r=createNewNeo4jEvent(this,t);U.addToMetadata(r,{},{query:a,param:n}),s=e.apply(this,[a,n]);const o=s.subscribe;return s.subscribe=function(e){o.call(this,getPatchedSubscribeMethods(this,e,arguments,r,t))},s}catch(e){return le.addException(e),s}}}var ir={init(){We.patchModule("neo4j-driver/lib/transaction.js","run",neo4jTransactionRunWrapper,e=>e.default.prototype),We.patchModule("neo4j-driver/lib/session.js","run",neo4jSessionRunWrapper,e=>e.default.prototype)}};function wrapFsWriteFileFunction(e,t){return function(r,a,n,s){const o="object"==typeof r?r.toString():r,i="function"==typeof(s||n)&&(s||n),{slsEvent:p,startTime:c}=U.initializeEvent("file_system",o,t,"file_system");if(U.addToMetadata(p,{"fs.file":o}),n&&"object"==typeof n&&U.addToMetadata(p,{options:n}),!i)return function(e,t,r,a){try{return le.addEvent(r),e.apply(this,a)}catch(e){throw U.finalizeEvent(r,t,e),e}}(e,c,p,[o,a,n]);let u,d,l;try{const t=new Promise(e=>{u=t=>{U.finalizeEvent(p,c,t),e(),i(t)}});"function"==typeof s?(l=!0,d=e.apply(this,[r,a,n,u])):"function"==typeof n&&(l=!0,d=e.apply(this,[r,a,u])),le.addEvent(p,t)}catch(e){le.addException(e)}return d||l?d:e.apply(this,[r,a,n,s])}}var pr={init(){"TRUE"===(process.env.EPSAGON_FS_INSTRUMENTATION||"").toUpperCase()&&(We.patchSingle(n,"writeFile",()=>wrapFsWriteFileFunction(n.writeFile,"writeFile")),We.patchSingle(n,"writeFileSync",()=>wrapFsWriteFileFunction(n.writeFileSync,"writeFileSync")))}};const cr={"aws-sdk/global":ze,"azure-sdk":Qt,"winston-cw":se,"cos-nodejs-sdk-v5":or,http:at,http2:ht,pg:bt,mysql:yt,redis:Mt,ioredis:Ct,mongo:Ot,dax:Ge,openwhisk:vt,google:xt,dns:It,nats:qt,myqq:Bt,kafkajs:Ut,kafkanode:Gt,bunyan:Kt,pino:Jt,winston:Vt,amqplib:Yt,amqp:rr,ldap:ar,cassandra:sr,neo4j:ir,fs:pr};function patch(e){try{e.init()}catch(e){"TRUE"===(process.env.EPSAGON_DEBUG||"").toUpperCase()&&S.debugLog(e)}}F.getConfig().isEpsagonPatchDisabled||(F.getConfig().patchWhitelist?F.getConfig().patchWhitelist.forEach(e=>{cr[e]?(S.debugLog("[PATCHER] Whitelisting "+e),patch(cr[e])):S.debugLog("[PATCHER] Unable to find lib to patch: "+e)}):[ze,at,ht,bt,yt,Mt,Ct,Ot,Ge,vt,xt,It,qt,Bt,Ut,Gt,Kt,Jt,Qt,se,Vt,Yt,rr,ar,sr,or,ir,pr].forEach(patch));var ur=createCommonjsModule((function(e){e.exports={lambdaWrapper:e=>e,tencentFunctionWrapper:e=>e,stepLambdaWrapper:e=>e,openWhiskWrapper:e=>e,googleCloudFunctionWrapper:e=>e,nodeWrapper:e=>e,wrapBatchJob:e=>e,label:e=>e,setError:e=>e,setWarning:e=>e,getTraceUrl:e=>e,tracer:le,config:F,utils:S,eventInterface:U,event:T,tryRequire:te,errorCode:v,httpHelpers:ke,consts:j,sqsUtils:fe},F.getConfig().isEpsagonDisabled||(e.exports.lambdaWrapper=lambda_lambdaWrapper,e.exports.tencentFunctionWrapper=tencent_tencentFunctionWrapper,e.exports.stepLambdaWrapper=lambda_stepLambdaWrapper,e.exports.nodeWrapper=node_nodeWrapper,e.exports.googleCloudFunctionWrapper=google_cloud_function_googleCloudFunctionWrapper,e.exports.openWhiskWrapper=openwhisk_openWhiskWrapper,e.exports.wrapBatchJob=batch_wrapBatchJob,e.exports.label=le.label,e.exports.setError=le.setError,e.exports.setWarning=le.setWarning,e.exports.getTraceUrl=le.getTraceUrl),e.exports.wrapper=Oe.wrapper,e.exports.init=le.initTrace,e.exports.disable=le.disable,e.exports.unpatch=We.unpatchModules,e.exports.enable=le.enable,e.exports.moduleUtils=We})),dr=ur.lambdaWrapper,lr=ur.tencentFunctionWrapper,gr=ur.stepLambdaWrapper,fr=ur.openWhiskWrapper,hr=ur.googleCloudFunctionWrapper,mr=ur.nodeWrapper,_r=ur.wrapBatchJob,Er=ur.label,br=ur.setError,yr=ur.setWarning,vr=ur.getTraceUrl,Tr=ur.tracer,$r=ur.config,xr=ur.utils,Sr=ur.eventInterface,Rr=ur.event,Ar=ur.tryRequire,Mr=ur.errorCode,Cr=ur.httpHelpers,Or=ur.consts,wr=ur.sqsUtils,Nr=ur.wrapper,Lr=ur.init,Ir=ur.disable,Dr=ur.unpatch,Pr=ur.enable,kr=ur.moduleUtils;exports.default=ur,exports.lambdaWrapper=dr,exports.tencentFunctionWrapper=lr,exports.stepLambdaWrapper=gr,exports.openWhiskWrapper=fr,exports.googleCloudFunctionWrapper=hr,exports.nodeWrapper=mr,exports.wrapBatchJob=_r,exports.label=Er,exports.setError=br,exports.setWarning=yr,exports.getTraceUrl=vr,exports.tracer=Tr,exports.config=$r,exports.utils=xr,exports.eventInterface=Sr,exports.event=Rr,exports.tryRequire=Ar,exports.errorCode=Mr,exports.httpHelpers=Cr,exports.consts=Or,exports.sqsUtils=wr,exports.wrapper=Nr,exports.init=Lr,exports.disable=Ir,exports.unpatch=Dr,exports.enable=Pr,exports.moduleUtils=kr;
